#################################################
# Purpose: To test having extra columns on the replica.
##################################################

# Some tests in here requre partitioning
-- source include/have_partition.inc

#################################################
############ Different Table Def Test ###########
#################################################
# Purpose: To have different table def on the   #
#          primary and replica. Most of these tests#
#          should stop the replica.               #
#################################################

call mtr.add_suppression("Replica: Unknown table 'test.t6' Error_code: 1051");
call mtr.add_suppression("Replica SQL.*Column [0-9] of table .test.t[0-9]*. cannot be converted from type.* Error_code: 1677");
call mtr.add_suppression("The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state");

--echo **** Diff Table Def Start ****

##############################################
### Try to replicate w/ PK on diff columns ###
### Should Stop Replica                      ###
##############################################

--echo *** On Replica ***
sync_replica_with_primary;
STOP REPLICA;

SET @saved_replica_type_conversions = @@replica_type_conversions;
SET GLOBAL REPLICA_TYPE_CONVERSIONS = 'ALL_NON_LOSSY';

eval CREATE TABLE t1 (a INT, b INT PRIMARY KEY, c CHAR(20),
                      d FLOAT DEFAULT '2.00', 
                      e CHAR(4) DEFAULT 'TEST') 
                      ENGINE=$engine_type;

--echo *** Create t1 on Primary ***
connection primary;
eval CREATE TABLE t1 (a INT PRIMARY KEY, b INT, c CHAR(10)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

INSERT INTO t1 () VALUES(1,2,'TEXAS'),(2,1,'AUSTIN'),(3,4,'QA');
SELECT * FROM t1 ORDER BY a;

--echo *** Select from replica ***
sync_replica_with_primary;
SELECT * FROM t1 ORDER BY a;

SET GLOBAL REPLICA_TYPE_CONVERSIONS = @saved_replica_type_conversions;

--echo *** Drop t1  ***
connection primary;
DROP TABLE t1;
sync_replica_with_primary;

############################################
### Try to replicate CHAR(10) to CHAR(5) ###
### Should Stop Replica or truncate value  ###
############################################

## BUG22086
--echo *** Create t2 on replica  ***
STOP REPLICA;
eval CREATE TABLE t2 (a INT, b INT PRIMARY KEY, c CHAR(5),
                      d FLOAT DEFAULT '2.00',
                      e CHAR(5) DEFAULT 'TEST2')
                      ENGINE=$engine_type;

--echo *** Create t2 on Primary ***
connection primary;
eval CREATE TABLE t2 (a INT PRIMARY KEY, b INT, c CHAR(10)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

INSERT INTO t2 () VALUES(1,2,'Kyle, TEX'),(2,1,'JOE AUSTIN'),(3,4,'QA TESTING');
SELECT * FROM t2 ORDER BY a;

connection replica;
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error.inc
STOP REPLICA;

# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

SELECT * FROM t2 ORDER BY a;

--echo *** Drop t2  ***
connection primary;
DROP TABLE t2;
sync_replica_with_primary;

####################################
### Try to replicate BLOB to INT ###
### Should Stop Replica            ###
####################################
--echo *** Create t3 on replica  ***
STOP REPLICA;
eval CREATE TABLE t3 (a INT, b INT PRIMARY KEY, c CHAR(20),
                      d FLOAT DEFAULT '2.00',
                      e CHAR(5) DEFAULT 'TEST2')
                      ENGINE=$engine_type;

--echo *** Create t3 on Primary ***
connection primary;
eval CREATE TABLE t3 (a BLOB, b INT PRIMARY KEY, c CHAR(20)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

set @b1 = 'b1';
set @b1 = concat(@b1,@b1);

INSERT INTO t3 () VALUES(@b1,2,'Kyle, TEX'),(@b1,1,'JOE AUSTIN'),(@b1,4,'QA TESTING');

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_skip_counter= 2
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc

--echo *** Drop t3  ***
connection primary;
DROP TABLE t3;
sync_replica_with_primary;

#####################################################
# Columns with different types, more columns at end #
# Expect: proper error message (wrong types)        #
##################################################### 

--echo *** Create t4 on replica  ***
STOP REPLICA;
eval CREATE TABLE t4 (a INT, b INT PRIMARY KEY, c CHAR(20),
                      d FLOAT DEFAULT '2.00',
                      e CHAR(5) DEFAULT 'TEST2')
                      ENGINE=$engine_type;

--echo *** Create t4 on Primary ***
connection primary;
eval CREATE TABLE t4 (a DECIMAL(8,2), b INT PRIMARY KEY, c CHAR(20)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

INSERT INTO t4 () VALUES(100.22,2,'Kyle, TEX'),(200.26,1,'JOE AUSTIN'),
                        (30000.22,4,'QA TESTING');

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_skip_counter= 2
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc


--echo *** Drop t4  ***
connection primary;
DROP TABLE t4;
sync_replica_with_primary;

#######################################################
# Columns with different types, same number of colums #
# Expect: Proper error message                        #
#######################################################

--echo *** Create t5 on replica  ***
STOP REPLICA;
eval CREATE TABLE t5 (a INT PRIMARY KEY, b CHAR(5),
                      c FLOAT, d INT, e DOUBLE,
                      f DECIMAL(8,2))ENGINE=$engine_type;

--echo *** Create t5 on Primary ***
connection primary;
eval CREATE TABLE t5 (a INT PRIMARY KEY, b VARCHAR(6),
                      c DECIMAL(8,2), d BIT, e BLOB,
                      f FLOAT) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

INSERT INTO t5 () VALUES(1,'Kyle',200.23,1,'b1b1',23.00098),
                        (2,'JOE',300.01,0,'b2b2',1.0000009);

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_skip_counter= 2
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc


--echo *** Drop t5  ***
connection primary;
DROP TABLE t5;
sync_replica_with_primary;

#######################################################
################## Continued ##########################
#######################################################
# Columns with different types, same number of colums #
# Expect: Proper error message                        #
#######################################################

--echo *** Create t6 on replica  ***
STOP REPLICA;
eval CREATE TABLE t6 (a INT PRIMARY KEY, b CHAR(5),
                      c FLOAT, d INT)ENGINE=$engine_type;

--echo *** Create t6 on Primary ***
connection primary;
eval CREATE TABLE t6 (a INT PRIMARY KEY, b VARCHAR(6),
                      c DECIMAL(8,2), d BIT 
                      ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

INSERT INTO t6 () VALUES(1,'Kyle',200.23,1),
                        (2,'JOE',300.01,0);

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc


--echo *** Drop t6  ***
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

connection primary;
DROP TABLE t6;
--sync_replica_with_primary


--echo **** Diff Table Def End ****

#######################################
#### Extra Column on Replica Testing ####
#######################################
# Purpose: To test extra colums on the#
#          Replica                      #
#######################################

--echo **** Extra Colums Start ****

##########################################
# More columns in replica at end of table, # 
# added columns have default values      #
# Expect: it should work, default values #
#         should be used                 #
##########################################

--echo *** Create t7 on replica  ***
STOP REPLICA;
SET sql_mode = 'NO_ENGINE_SUBSTITUTION';
eval CREATE TABLE t7 (a INT KEY, b BLOB, c CHAR(5),
                      d TIMESTAMP NULL DEFAULT '0000-00-00 00:00:00',
                      e CHAR(20) DEFAULT 'Extra Column Testing')
                      ENGINE=$engine_type;

--echo *** Create t7 on Primary ***
connection primary;
eval CREATE TABLE t7 (a INT PRIMARY KEY, b BLOB, c CHAR(5)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t7 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');
SELECT * FROM t7 ORDER BY a;

--echo *** Select from replica ***
sync_replica_with_primary;
SELECT * FROM t7 ORDER BY a;

--echo *** Drop t7  ***
connection primary;
DROP TABLE t7;
sync_replica_with_primary;

###########################################
# More columns in replica at end of table,  #
# added columns do not have default values#
# Expect: Proper error message            #
###########################################
# NOTE: This should fail but currently    #
#       works. BUG#22101                  #
###########################################
--echo *** Create t8 on replica  ***
STOP REPLICA;
eval CREATE TABLE t8 (a INT KEY, b BLOB, c CHAR(5),
                      d TIMESTAMP NULL DEFAULT '0000-00-00 00:00:00',
                      e INT)ENGINE=$engine_type;
SET sql_mode = default;
--echo *** Create t8 on Primary ***
connection primary;
eval CREATE TABLE t8 (a INT PRIMARY KEY, b BLOB, c CHAR(5)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t8 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');

### Uncomment once bug is fixed

#connection replica;
#--let $replica_sql_errno= SOMETHING
#--let $replica_skip_counter= 2
#--let $show_replica_sql_error= 1
#--source include/wait_for_replica_sql_error_and_skip.inc

--echo *** Drop t8  ***
connection primary;
DROP TABLE t8;
sync_replica_with_primary;

###########################################
############# Continued ###################
# More columns in replica at end of table,  #
# added columns do not have default values#
# Expect: Proper error message            #
###########################################
# Bug#22234, Bug#23907 Extra Replica Col is not 
# erroring on extra col with no default values.
###############################################################
# Error reaction is up to sql_mode of the replica sql (bug#38173)
#--echo *** Create t9 on replica  ***
# Please, check BUG#47741 to see why you are not testing NDB.
if (`SELECT UPPER(LEFT($engine_type, 3)) != 'NDB'`)
{
  STOP REPLICA;
  eval CREATE TABLE t9 (a INT KEY, b BLOB, c CHAR(5),
                        d TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
                          ON UPDATE CURRENT_TIMESTAMP,
                        e INT NOT NULL,
                        f text not null,
                        g text,
                        h blob not null,
                        i blob) ENGINE=$engine_type;

  --echo *** Create t9 on Primary ***
  connection primary;
  eval CREATE TABLE t9 (a INT PRIMARY KEY, b BLOB, c CHAR(5)
                       ) ENGINE=$engine_type;

  --echo *** Start Replica ***
  connection replica;
  # reset primary and replica and start replica
  --let $rpl_only_running_threads= 1
  --source include/rpl_reset.inc

  --echo *** Primary Data Insert ***
  connection primary;
  set @b1 = 'b1b1b1b1';

  set @b1 = concat(@b1,@b1);
  INSERT INTO t9 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');

  # the test would stop replica if @@sql_mode for the sql thread
  # was set to strict. Otherwise, as with this tests setup, 
  # the implicit defaults will be inserted into fields even though
  # they are declared without DEFAULT clause.

  sync_replica_with_primary;
  select * from t9;

  # todo: fix Bug #43992 replica sql thread can't tune own sql_mode ...
  # and add/restore waiting for stop test

  #--let $replica_sql_errno= SOMETHING
  #--let $replica_skip_counter= 2
  #--let $show_replica_sql_error= 1
  #--source include/wait_for_replica_sql_error_and_skip.inc

  #--echo *** Drop t9  ***
  connection primary;
  DROP TABLE t9;
  sync_replica_with_primary;

}

############################################
# More columns in replica at middle of table #
# Expect: Proper error message             #
############################################
--echo  *** Create t10 on replica  ***
STOP REPLICA;
eval CREATE TABLE t10 (a INT KEY, b BLOB, f DOUBLE DEFAULT '233', 
                      c CHAR(5), e INT DEFAULT '1')ENGINE=$engine_type;

--echo *** Create t10 on Primary ***
connection primary;
eval CREATE TABLE t10 (a INT PRIMARY KEY, b BLOB, c CHAR(5)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t10 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_skip_counter= 2
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc


--echo *** Drop t10  ***
connection primary;
DROP TABLE t10;
sync_replica_with_primary;

############################################
############## Continued ###################
############################################
# More columns in replica at middle of table #
# Expect: Proper error message             #
############################################
--echo  *** Create t11 on replica  ***
STOP REPLICA;
eval CREATE TABLE t11 (a INT KEY, b BLOB, f INT,
                      c CHAR(5) DEFAULT 'test', e INT DEFAULT '1')ENGINE=$engine_type;

--echo *** Create t11 on Primary ***
connection primary;
eval CREATE TABLE t11 (a INT PRIMARY KEY, b BLOB, c VARCHAR(254)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t11 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_skip_counter= 2
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc


--echo *** Drop t11  ***
connection primary;
DROP TABLE t11;
sync_replica_with_primary;

############################################
############## Continued ###################
############################################
# More columns in replica at middle of table #
# Expect: This one should pass blob-text   #
############################################
--echo  *** Create t12 on replica  ***
STOP REPLICA;
eval CREATE TABLE t12 (a INT KEY, b BLOB, f TEXT,
                      c CHAR(5) DEFAULT 'test', e INT DEFAULT '1')ENGINE=$engine_type;

--echo *** Create t12 on Primary ***
connection primary;
eval CREATE TABLE t12 (a INT PRIMARY KEY, b BLOB, c BLOB
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t12 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');
SELECT * FROM t12 ORDER BY a;

--echo *** Select on Replica ***
sync_replica_with_primary;
SELECT * FROM t12 ORDER BY a;

--echo *** Drop t12  ***
connection primary;
DROP TABLE t12;
sync_replica_with_primary;

--echo **** Extra Colums End ****

###############################
# BUG#22177 CURRENT_TIMESTAMP #
# Sould work with ^           #
###############################
--echo *** BUG 22177 Start ***
--echo *** Create t13 on replica  ***
STOP REPLICA;
eval CREATE TABLE t13 (a INT KEY, b BLOB, c CHAR(5),
                      d INT DEFAULT '1',
                      e TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP
                      )ENGINE=$engine_type;

--echo *** Create t13 on Primary ***
connection primary;
eval CREATE TABLE t13 (a INT PRIMARY KEY, b BLOB, c CHAR(5)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t13 () VALUES(1,@b1,'Kyle'),(2,@b1,'JOE'),(3,@b1,'QA');
SELECT * FROM t13 ORDER BY a;

--echo *** Select on Replica ****
sync_replica_with_primary;
--replace_column 5 CURRENT_TIMESTAMP 
SELECT * FROM t13 ORDER BY a;

--echo *** Drop t13  ***
connection primary;
DROP TABLE t13;
sync_replica_with_primary;

--echo *** 22117 END *** 

##############################
# ALTER PRIMARY TABLE TESTING #
##############################

--echo *** Alter Primary Table Testing Start ***

####################################################
# - Alter Primary adding columns at middle of table #
#   Expect: columns added                          #
####################################################

--echo *** Create t14 on replica  ***
STOP REPLICA;
eval CREATE TABLE t14 (c1 INT KEY, c4 BLOB, c5 CHAR(5),
                      c6 INT DEFAULT '1',
                      c7 TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP
                      )ENGINE=$engine_type;

--echo *** Create t14 on Primary ***
connection primary;
eval CREATE TABLE t14 (c1 INT PRIMARY KEY, c4 BLOB, c5 CHAR(5)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
ALTER TABLE t14 ADD COLUMN c2 DECIMAL(8,2) AFTER c1;
ALTER TABLE t14 ADD COLUMN c3 TEXT AFTER c2;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t14 () VALUES(1,1.00,'Replication Testing Extra Col',@b1,'Kyle'),
                        (2,2.00,'This Test Should work',@b1,'JOE'),
                        (3,3.00,'If is does not, I will open a bug',@b1,'QA');
SELECT * FROM t14 ORDER BY c1;


--echo *** Select on Replica ****
sync_replica_with_primary;
--replace_column 7 CURRENT_TIMESTAMP
SELECT * FROM t14 ORDER BY c1;

####################################################
# - Alter Primary drop column at end of table      #
#   Expect: column dropped                        #
####################################################

--echo *** Create t14a on replica  ***
STOP REPLICA;
eval CREATE TABLE t14a (c1 INT KEY, c4 BLOB, c5 CHAR(5),
                      c6 INT DEFAULT '1',
                      c7 TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP
                      )ENGINE=$engine_type;

--echo *** Create t14a on Primary ***
connection primary;
eval CREATE TABLE t14a (c1 INT PRIMARY KEY, c4 BLOB, c5 CHAR(5)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t14a () VALUES(1,@b1,'Kyle'),
                        (2,@b1,'JOE'),
                        (3,@b1,'QA');

SELECT * FROM t14a ORDER BY c1;
--echo *** Select on Replica ****
sync_replica_with_primary;
--replace_column 5 CURRENT_TIMESTAMP
SELECT * FROM t14a ORDER BY c1;
STOP REPLICA;

--echo *** Primary Drop c5 ***
connection primary;
ALTER TABLE t14a DROP COLUMN c5;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);

INSERT INTO t14a () VALUES(4,@b1),
                        (5,@b1),
                        (6,@b1);
SELECT * FROM t14a ORDER BY c1;

--echo *** Select on Replica ****
sync_replica_with_primary;
--replace_column 5 CURRENT_TIMESTAMP
SELECT * FROM t14a ORDER BY c1;

--connection primary
DROP TABLE t14a;
--sync_replica_with_primary

####################################################
# - Alter Primary Dropping columns from the middle. #
#   Expect: columns dropped                        #
####################################################

--echo *** connect to primary and drop columns ***
connection primary;
ALTER TABLE t14 DROP COLUMN c2;
ALTER TABLE t14 DROP COLUMN c4;
--echo *** Select from Primary ***
SELECT * FROM t14 ORDER BY c1;

--echo *** Select from Replica ***
sync_replica_with_primary;
--replace_column 5 CURRENT_TIMESTAMP
SELECT * FROM t14 ORDER BY c1;

--echo *** Drop t14  ***
connection primary;
DROP TABLE t14;
sync_replica_with_primary;

##############################################################
# - Alter Primary adding columns that already exist on replica. #
#  Expect: proper error message                              #
##############################################################

--echo *** Create t15 on replica  ***
STOP REPLICA;
eval CREATE TABLE t15 (c1 INT KEY, c2 DECIMAL(8,2), c3 TEXT,
                      c4 BLOB, c5 CHAR(5),
                      c6 INT DEFAULT '1',
                      c7 TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP
                      )ENGINE=$engine_type;

--echo *** Create t15 on Primary ***
connection primary;
eval CREATE TABLE t15 (c1 INT PRIMARY KEY, c2 DECIMAL(8,2), c3 TEXT,
                      c4 BLOB, c5 CHAR(5)) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

call mtr.add_suppression("Error .Unknown table .t6.. on query.* Error_code: 1051");
call mtr.add_suppression("Error .Duplicate column name .c6.. on query.* Error_code: 1060");
call mtr.add_suppression("Table definition on primary and replica does not match: Column . ...e mismatch.* Error_code: 1535");

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t15 () VALUES(1,1.00,'Replication Testing Extra Col',@b1,'Kyle'),
                        (2,2.00,'This Test Should work',@b1,'JOE'),
                        (3,3.00,'If is does not, I will open a bug',@b1,'QA');
SELECT * FROM t15 ORDER BY c1;


--echo *** Select on Replica ****
sync_replica_with_primary;
--replace_column 7 CURRENT_TIMESTAMP
SELECT * FROM t15 ORDER BY c1;

--echo *** Add column on primary that is a Extra on Replica ***
connection primary;
ALTER TABLE t15 ADD COLUMN c6 INT AFTER c5;

--echo ********************************************************
--echo *** Expect replica to fail with Error ER_DUP_FIELDNAME ***
--echo ********************************************************
connection replica;
--let $replica_skip_counter= 1
--let $replica_sql_errno= convert_error(ER_DUP_FIELDNAME) # 1060
--source include/wait_for_replica_sql_error_and_skip.inc


--echo *** Try to insert in primary ****
connection primary;
INSERT INTO t15 () VALUES(5,2.00,'Replication Testing',@b1,'Buda',2);
SELECT * FROM t15 ORDER BY c1;

#SHOW BINLOG EVENTS;

--echo *** Try to select from replica ****
sync_replica_with_primary;
--replace_column 7 CURRENT_TIMESTAMP
SELECT * FROM t15 ORDER BY c1;

--echo *** DROP TABLE t15 ***
connection primary;
DROP TABLE t15;
sync_replica_with_primary;

####################################
# - Alter Primary and ADD PARTITION #
#   Expect:?                       #
####################################

--echo *** Create t16 on replica  ***
STOP REPLICA;
eval CREATE TABLE t16 (c1 INT KEY, c2 DECIMAL(8,2), c3 TEXT,
                      c4 BLOB, c5 CHAR(5),
                      c6 INT DEFAULT '1',
                      c7 TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP
                      )ENGINE=$engine_type;

--echo *** Create t16 on Primary ***
connection primary;
eval CREATE TABLE t16 (c1 INT PRIMARY KEY, c2 DECIMAL(8,2), c3 TEXT,
                      c4 BLOB, c5 CHAR(5))ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;
set @b1 = 'b1b1b1b1';
set @b1 = concat(@b1,@b1);
INSERT INTO t16 () VALUES(1,1.00,'Replication Testing Extra Col',@b1,'Kyle'),
                        (2,2.00,'This Test Should work',@b1,'JOE'),
                        (3,3.00,'If is does not, I will open a bug',@b1,'QA');
SELECT * FROM t16 ORDER BY c1;

--echo *** Select on Replica ****
sync_replica_with_primary;
--replace_column 7 CURRENT_TIMESTAMP
SELECT * FROM t16 ORDER BY c1;

--echo *** Add Partition on primary ***
connection primary;
ALTER TABLE t16 PARTITION BY KEY(c1) PARTITIONS 4;
INSERT INTO t16 () VALUES(4,1.00,'Replication Rocks',@b1,'Omer');
SHOW CREATE TABLE t16;

--echo *** Show table on Replica ****
sync_replica_with_primary;
SHOW CREATE TABLE t16;

--echo *** DROP TABLE t16 ***
connection primary;
DROP TABLE t16;
sync_replica_with_primary;

--echo *** Alter Primary End ***

############################################
### Try to replicate BIGINT to SMALLINT ###
### Should Stop Replica                   ###
############################################

--echo *** Create t17 on replica  ***
STOP REPLICA;
eval CREATE TABLE t17 (a SMALLINT, b INT PRIMARY KEY, c CHAR(5),
                      d FLOAT DEFAULT '2.00',
                      e CHAR(5) DEFAULT 'TEST2')
                      ENGINE=$engine_type;

--echo *** Create t17 on Primary ***
connection primary;
eval CREATE TABLE t17 (a BIGINT PRIMARY KEY, b INT, c CHAR(10)
                       ) ENGINE=$engine_type;

--echo *** Start Replica ***
connection replica;
# reset primary and replica and start replica
--let $rpl_only_running_threads= 1
--source include/rpl_reset.inc

--echo *** Primary Data Insert ***
connection primary;

INSERT INTO t17 () VALUES(9223372036854775807,2,'Kyle, TEX');

--echo ******************************************************************
--echo *** Expect replica to fail with Error ER_REPLICA_CONVERSION_FAILED ***
--echo ******************************************************************
connection replica;
--let $replica_skip_counter= 2
--let $replica_sql_errno= convert_error(ER_REPLICA_CONVERSION_FAILED)
--source include/wait_for_replica_sql_error_and_skip.inc

--echo ** DROP table t17 ***
connection primary;
DROP TABLE t17;
sync_replica_with_primary;
