#################################################################################
# This test checks if the replication between "null" fields to either "null"
# fields or "not null" fields works properly. In the first case, the execution
# should work fine. In the second case, it may fail according to the sql_mode
# being used.
#
# The test is devided in three main parts:
#
# 1 - NULL --> NULL (no failures)
# 2 - NULL --> NOT NULL ( sql-mode  = STRICT and failures)
# 3 - NULL --> NOT NULL ( sql-mode != STRICT and no failures)
#
#################################################################################
connection primary;

SET SQL_LOG_BIN= 0;
eval CREATE TABLE t1(`a` INT, `b` DATE DEFAULT NULL,
`c` INT DEFAULT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

eval CREATE TABLE t2(`a` INT, `b` DATE DEFAULT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

eval CREATE TABLE t3(`a` INT, `b` DATE DEFAULT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

eval CREATE TABLE t4(`a` INT, `b` DATE DEFAULT NULL,
`c` INT DEFAULT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
SET SQL_LOG_BIN= 1;

connection replica;

eval CREATE TABLE t1(`a` INT, `b` DATE DEFAULT NULL,
`c` INT DEFAULT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

eval CREATE TABLE t2(`a` INT, `b` DATE DEFAULT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

SET sql_mode = 'NO_ENGINE_SUBSTITUTION';

eval CREATE TABLE t3(`a` INT, `b` DATE DEFAULT '0000-00-00',
`c` INT DEFAULT 500, 
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

eval CREATE TABLE t4(`a` INT, `b` DATE DEFAULT '0000-00-00',
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

SET sql_mode = default;

--echo ************* EXECUTION WITH INSERTS *************
connection primary;
INSERT INTO t1(a,b,c) VALUES (1, null, 1);
INSERT INTO t1(a,b,c) VALUES (2,'1111-11-11', 2);
INSERT INTO t1(a,b) VALUES (3, null);
INSERT INTO t1(a,c) VALUES (4, 4);
INSERT INTO t1(a) VALUES (5);

INSERT INTO t2(a,b) VALUES (1, null);
INSERT INTO t2(a,b) VALUES (2,'1111-11-11');
INSERT INTO t2(a) VALUES (3);

INSERT INTO t3(a,b) VALUES (1, null);
INSERT INTO t3(a,b) VALUES (2,'1111-11-11');
INSERT INTO t3(a) VALUES (3);

INSERT INTO t4(a,b,c) VALUES (1, null, 1);
INSERT INTO t4(a,b,c) VALUES (2,'1111-11-11', 2);
INSERT INTO t4(a,b) VALUES (3, null);
INSERT INTO t4(a,c) VALUES (4, 4);
INSERT INTO t4(a) VALUES (5);

--echo ************* SHOWING THE RESULT SETS WITH INSERTS *************
--source include/sync_replica_sql_with_primary.inc

--echo TABLES t1 and t2 must be equal otherwise an error will be thrown. 
let $diff_tables= primary:t1, replica:t1;
source include/diff_tables.inc;
 
let $diff_tables= primary:t2, replica:t2;
source include/diff_tables.inc;

--echo TABLES t2 and t3 must be different.
connection primary;
SELECT * FROM t3 ORDER BY a;
connection replica;
SELECT * FROM t3 ORDER BY a;
connection primary;
SELECT * FROM t4 ORDER BY a;
connection replica;
SELECT * FROM t4 ORDER BY a;

--echo ************* EXECUTION WITH UPDATES and REPLACES *************
connection primary;
DELETE FROM t1;
INSERT INTO t1(a,b,c) VALUES (1,'1111-11-11', 1);
REPLACE INTO t1(a,b,c) VALUES (2,'1111-11-11', 2);
UPDATE t1 set b= NULL, c= 300 where a= 1;
REPLACE INTO t1(a,b,c) VALUES (2, NULL, 300);

--echo ************* SHOWING THE RESULT SETS WITH UPDATES and REPLACES *************
--source include/sync_replica_sql_with_primary.inc

--echo TABLES t1 and t2 must be equal otherwise an error will be thrown. 
let $diff_tables= primary:t1, replica:t1;
source include/diff_tables.inc;

--echo ************* CLEANING *************
connection primary;

DROP TABLE t1;
DROP TABLE t2;
DROP TABLE t3;
DROP TABLE t4;

--source include/sync_replica_sql_with_primary.inc
  
connection primary;

SET SQL_LOG_BIN= 0;
eval CREATE TABLE t1 (`a` INT, `b` BIT DEFAULT NULL, `c` BIT DEFAULT NULL, 
PRIMARY KEY (`a`)) ENGINE= $engine;
SET SQL_LOG_BIN= 1;

connection replica;

eval CREATE TABLE t1 (`a` INT, `b` BIT DEFAULT b'01', `c` BIT DEFAULT NULL,
PRIMARY KEY (`a`)) ENGINE= $engine;

--echo ************* EXECUTION WITH INSERTS *************
connection primary;
INSERT INTO t1(a,b,c) VALUES (1, null, b'01');
INSERT INTO t1(a,b,c) VALUES (2,b'00', b'01');
INSERT INTO t1(a,b) VALUES (3, null);
INSERT INTO t1(a,c) VALUES (4, b'01');
INSERT INTO t1(a) VALUES (5);

--echo ************* SHOWING THE RESULT SETS WITH INSERTS *************
--echo TABLES t1 and t2 must be different.
--source include/sync_replica_sql_with_primary.inc
connection primary;
SELECT a,b+0,c+0 FROM t1 ORDER BY a;
connection replica;
SELECT a,b+0,c+0 FROM t1 ORDER BY a;

--echo ************* EXECUTION WITH UPDATES and REPLACES *************
connection primary;
DELETE FROM t1;
INSERT INTO t1(a,b,c) VALUES (1,b'00', b'01');
REPLACE INTO t1(a,b,c) VALUES (2,b'00',b'01');
UPDATE t1 set b= NULL, c= b'00' where a= 1;
REPLACE INTO t1(a,b,c) VALUES (2, NULL, b'00');

--echo ************* SHOWING THE RESULT SETS WITH UPDATES and REPLACES *************
--echo TABLES t1 and t2 must be equal otherwise an error will be thrown. 
--source include/sync_replica_sql_with_primary.inc
let $diff_tables= primary:t1, replica:t1;
source include/diff_tables.inc;
 
connection primary;

DROP TABLE t1;

--source include/sync_replica_sql_with_primary.inc
  
--echo ################################################################################
--echo #                       NULL ---> NOT NULL (STRICT MODE)
--echo #                    UNCOMMENT THIS AFTER FIXING BUG#43992
--echo ################################################################################
#connection replica;
#SET GLOBAL sql_mode="TRADITIONAL";
#
#STOP REPLICA;
#--source include/wait_for_replica_to_stop.inc
#START REPLICA;
#--source include/wait_for_replica_to_start.inc
#
#let $y=0;
#while ($y < 6)
#{
#  connection primary;
#
#  SET SQL_LOG_BIN= 0;
#  eval CREATE TABLE t1(`a` INT NOT NULL, `b` INT,
#  PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
#  eval CREATE TABLE t2(`a` INT NOT NULL, `b` INT,
#  PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
#  eval CREATE TABLE t3(`a` INT NOT NULL, `b` INT,
#  PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
#  SET SQL_LOG_BIN= 1;
#  
#  connection replica;
#  
#  eval CREATE TABLE t1(`a` INT NOT NULL, `b` INT NOT NULL, 
#  `c` INT NOT NULL,
#  PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
#  eval CREATE TABLE t2(`a` INT NOT NULL, `b` INT NOT NULL,
#  `c` INT, 
#  PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
#  eval CREATE TABLE t3(`a` INT NOT NULL, `b` INT NOT NULL,
#  `c` INT DEFAULT 500, 
#  PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
#  
#  if ($y==0)
#  {
#    --echo ************* EXECUTION WITH INSERTS *************
#    connection primary;
#    INSERT INTO t1(a) VALUES (1);
#  }
#  
#  if ($y==1)
#  {
#    --echo ************* EXECUTION WITH INSERTS *************
#    connection primary;
#    INSERT INTO t1(a, b) VALUES (1, NULL);
#  }
#  
#  if ($y==2)
#  {
#    --echo ************* EXECUTION WITH UPDATES *************
#    connection primary;
#    INSERT INTO t3(a, b) VALUES (1, 1);
#    INSERT INTO t3(a, b) VALUES (2, 1);
#    UPDATE t3 SET b = NULL where a= 1;
#  }
#  
#  if ($y==3)
#  {
#    --echo ************* EXECUTION WITH INSERTS/REPLACES *************
#    connection primary;
#    REPLACE INTO t3(a, b) VALUES (1, null);
#  }
#   
#  if ($y==4)
#  {
#    --echo ************* EXECUTION WITH UPDATES/REPLACES *************
#    connection primary;
#    INSERT INTO t3(a, b) VALUES (1, 1);
#    REPLACE INTO t3(a, b) VALUES (1, null);
#  }
#   
#  if ($y==5)
#  {
#    --echo ************* EXECUTION WITH MULTI-ROW INSERTS *************
#    connection primary;
#
#    SET SQL_LOG_BIN= 0;
#    INSERT INTO t2(a, b) VALUES (1, 1);
#    INSERT INTO t2(a, b) VALUES (2, 1);
#    INSERT INTO t2(a, b) VALUES (3, null);
#    INSERT INTO t2(a, b) VALUES (4, 1);
#    INSERT INTO t2(a, b) VALUES (5, 1);
#    SET SQL_LOG_BIN= 1;
#
#    INSERT INTO t2 SELECT a + 10, b from t2;
#    --echo The statement below is just executed to stop processing
#    INSERT INTO t1(a) VALUES (1);
#  }
#  
#  --echo ************* SHOWING THE RESULT SETS *************
#  connection replica;
#  --source include/wait_for_replica_sql_to_stop.inc
#  connection primary;
#  SELECT * FROM t1 ORDER BY a;
#  connection replica;
#  SELECT * FROM t1 ORDER BY a;
#  connection primary;
#  SELECT * FROM t2 ORDER BY a;
#  connection replica;
#  SELECT * FROM t2 ORDER BY a;
#  connection primary;
#  SELECT * FROM t3 ORDER BY a;
#  connection replica;
#  SELECT * FROM t3 ORDER BY a;
#  --source include/rpl_reset.inc
#  
#  connection primary;
#  
#  DROP TABLE t1;
#  DROP TABLE t2;
#  DROP TABLE t3;
#  
#  sync_replica_with_primary;
#
#  inc $y;
#}
#connection replica;
#SET GLOBAL sql_mode="";
#
#STOP REPLICA;
#source include/wait_for_replica_to_stop.inc;
#START REPLICA;
#--source include/wait_for_replica_to_start.inc

--echo ################################################################################
--echo #                       NULL ---> NOT NULL (NON-STRICT MODE)
--echo ################################################################################
connection primary;

SET SQL_LOG_BIN= 0;
eval CREATE TABLE t1(`a` INT NOT NULL, `b` INT,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
eval CREATE TABLE t2(`a` INT NOT NULL, `b` INT,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
eval CREATE TABLE t3(`a` INT NOT NULL, `b` INT,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
SET SQL_LOG_BIN= 1;

connection replica;

eval CREATE TABLE t1(`a` INT NOT NULL, `b` INT NOT NULL, 
`c` INT NOT NULL,
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
eval CREATE TABLE t2(`a` INT NOT NULL, `b` INT NOT NULL,
`c` INT, 
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;
eval CREATE TABLE t3(`a` INT NOT NULL, `b` INT NOT NULL,
`c` INT DEFAULT 500, 
PRIMARY KEY(`a`)) ENGINE=$engine DEFAULT CHARSET=LATIN1;

--echo ************* EXECUTION WITH INSERTS *************
connection primary;
INSERT INTO t1(a) VALUES (1);
INSERT INTO t1(a, b) VALUES (2, NULL);
INSERT INTO t1(a, b) VALUES (3, 1);

INSERT INTO t2(a) VALUES (1);
INSERT INTO t2(a, b) VALUES (2, NULL);
INSERT INTO t2(a, b) VALUES (3, 1);

INSERT INTO t3(a) VALUES (1);
INSERT INTO t3(a, b) VALUES (2, NULL);
INSERT INTO t3(a, b) VALUES (3, 1);
INSERT INTO t3(a, b) VALUES (4, 1);
REPLACE INTO t3(a, b) VALUES (5, null);

REPLACE INTO t3(a, b) VALUES (3, null);
UPDATE t3 SET b = NULL where a = 4;

--echo ************* SHOWING THE RESULT SETS *************
connection primary;
--source include/sync_replica_sql_with_primary.inc

connection primary;
SELECT * FROM t1 ORDER BY a;
connection replica;
SELECT * FROM t1 ORDER BY a;
connection primary;
SELECT * FROM t2 ORDER BY a;
connection replica;
SELECT * FROM t2 ORDER BY a;
connection primary;
SELECT * FROM t3 ORDER BY a;
connection replica;
SELECT * FROM t3 ORDER BY a;

connection primary;

DROP TABLE t1;
DROP TABLE t2;
DROP TABLE t3;

--source include/sync_replica_sql_with_primary.inc
