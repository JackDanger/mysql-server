# TBF - difference in row level logging
# Temp tables are not replicated in rbr, but it is still good to hit rbr with everthing

# See SHOW REPLICA STATUS displays well after RESET REPLICA (it should display the
# --primary-* options from mysqld, as this is what is going to be used next time
# replica threads will be started). In bug 985, it displayed old values (of before
# RESET REPLICA).
# See if replica crashes when doing a CREATE TEMPORARY TABLE twice, separated by
# RESET REPLICA.

-- source include/primary-replica.inc
sync_replica_with_primary;
--disable_query_log
call mtr.add_suppression('Replica I/O: Get primary BINLOG_CHECKSUM failed with error');
--enable_query_log
let $status_items= Primary_User, Primary_Host;
source include/show_replica_status.inc;

source include/stop_replica.inc;
--replace_column 2 ####
change primary to primary_user='test';
source include/show_replica_status.inc;

reset replica;
source include/show_replica_status.inc;

--replace_column 2 ####
change primary to primary_user='root';
source include/start_replica.inc;
sync_with_primary;
source include/show_replica_status.inc;

# test of crash with temp tables & RESET REPLICA
# (test to see if RESET REPLICA clears temp tables in memory and disk)
source include/stop_replica.inc;
reset replica;
source include/start_replica.inc;
connection primary;
create temporary table t1 (a int);
sync_replica_with_primary;
source include/stop_replica.inc;
reset replica;
reset primary; # clear GTIDs metadata so that create temporary table is replayed
source include/start_replica.inc;
sync_with_primary;
show status like 'replica_open_temp_tables';
connection primary;
drop temporary table if exists t1;
sync_replica_with_primary;

#
#Bug#34654  	RESET REPLICA does not clear LAST_IO_Err* 
#

# clearing the status
source include/stop_replica.inc;
reset replica;
source include/check_replica_no_error.inc;

#
# verifying start replica resets Last_IO_Error and Last_IO_Errno.
#

--replace_column 2 ####
change primary to primary_user='impossible_user_name';
start replica;
let $replica_io_errno= 1045;
--source include/wait_for_replica_io_error.inc
--source include/stop_replica_sql.inc

--replace_column 2 ####
change primary to primary_user='root';
source include/start_replica.inc;
source include/check_replica_no_error.inc;

#
# verifying reset replica resets Last_{IO,SQL}_Err{or,no}
#

--echo
--echo Sync replica, else STOP REPLICA may complain about open temporary table.
--echo

--source include/rpl_connection_primary.inc
--source include/sync_replica_sql_with_primary.inc
--source include/stop_replica.inc

--replace_column 2 ####
change primary to primary_user='impossible_user_name';
start replica;
let $replica_io_errno= 1045;
--source include/wait_for_replica_io_error.inc
--source include/stop_replica_sql.inc

reset replica;
source include/check_replica_no_error.inc;
--replace_column 2 ####
change primary to primary_user='root';


#
# BUG#11809016 - NO WAY TO DISCOVER AN INSTANCE IS NO LONGER A REPLICA FOLLOWING MYSQL BUG#28796
#

reset replica;

--echo
--echo Sync replica, else STOP REPLICA may complain about open temporary table.
--echo

--source include/start_replica.inc
--source include/rpl_connection_primary.inc
--source include/sync_replica_sql_with_primary.inc

--source include/stop_replica.inc
--let $_replica_primary_host= query_get_value(SHOW REPLICA STATUS, Primary_Host, 1)
--let $_replica_primary_user= query_get_value(SHOW REPLICA STATUS, Primary_User, 1)
--let $_replica_primary_port= query_get_value(SHOW REPLICA STATUS, Primary_Port, 1)

reset replica all;
--error ER_BAD_REPLICA
start replica;

--let $_show_primary_host= query_get_value(SHOW REPLICA STATUS, Primary_Host, 1)
if ($_show_primary_host != No such row)
{
  die;
}

--replace_result $_replica_primary_host PRIMARY_HOST $_replica_primary_user PRIMARY_USER $_replica_primary_port PRIMARY_PORT
--replace_column 2 ####
--eval CHANGE PRIMARY TO PRIMARY_HOST= '$_replica_primary_host', PRIMARY_USER= '$_replica_primary_user', PRIMARY_PORT= $_replica_primary_port
--source include/start_replica.inc

--source include/rpl_end.inc
