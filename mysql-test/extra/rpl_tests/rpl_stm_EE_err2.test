###################################
# Author: JBM
# Date: 2006-01-11
# Purpose: Second test case from
#          rpl_EE_err.test split out
#          from orginal to make the
#          first work with both RBR and SBR
###################################
#REQUIREMENT: An INSERT with a faked duplicate entry error on
#primary should be replicated to replica and force the replica to stop
#(since the replica can't cause a faked error to re-occur).
###################################

-- source include/primary-replica.inc

connection primary;
eval create table t1 (a int, unique(a)) engine=$engine_type;
set sql_log_bin=0;
insert into t1 values(2);
set sql_log_bin=1;

--error ER_DUP_ENTRY
insert into t1 values(1),(2);
drop table t1;

connection replica;
--let $err1= convert_error(ER_MTS_INCONSISTENT_DATA)
--let $err2= convert_error(ER_INCONSISTENT_ERROR)
--eval call mtr.add_suppression("Replica SQL.*Query caused different errors on primary and replica.*Error on primary:.* error code=1062.*Error on replica:.* Error_code: $err2")
call mtr.add_suppression("The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state");

--echo (expect different error codes on primary and replica)
--let $replica_sql_errno= $err1,$err2
# can't print error text. MTS reports a separate error in this case.
# Todo: to fix single-threaded-replica BUG#57287.
--let $show_replica_sql_error= 0
--source include/wait_for_replica_sql_error.inc
drop table t1;
--source include/stop_replica.inc
# Clear error messages.
RESET REPLICA;

# End of 4.1 tests

--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
