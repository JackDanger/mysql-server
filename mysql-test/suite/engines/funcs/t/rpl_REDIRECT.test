#
# Test of automatic redirection of queries to primary/replica.
# 

source include/primary-replica.inc;
# We disable this for now as PS doesn't handle redirection
--disable_ps_protocol

#first, make sure the replica has had enough time to register
sync_replica_with_primary;

#discover replicas
connection primary;
--query_vertical SHOW REPLICA STATUS;
--replace_result $REPLICA_MYPORT REPLICA_PORT
SHOW REPLICA HOSTS;
rpl_probe;

#turn on primary/replica query direction auto-magic
enable_rpl_parse;
create table t1 ( n int);
insert into t1 values (1),(2),(3),(4);
disable_rpl_parse;
sync_replica_with_primary;
insert into t1 values(5);
connection primary;
enable_rpl_parse;
# The first of the queries will be sent to the replica, the second to the primary.
SELECT * FROM t1 ORDER BY n;
SELECT * FROM t1 ORDER BY n;
disable_rpl_parse;
SELECT * FROM t1 ORDER BY n;
connection replica;
SELECT * FROM t1 ORDER BY n;

# Cleanup
connection primary;
drop table t1;
sync_replica_with_primary;

# End of 4.1 tests
