-- source include/not_ndb_default.inc
-- source include/have_binlog_format_row.inc
-- source include/primary-replica.inc

# Note: The test is dependent on binlog positions

# Create some events on primary
connection primary;
CREATE TABLE t1(n INT NOT NULL AUTO_INCREMENT PRIMARY KEY);
INSERT INTO t1 VALUES (1),(2),(3),(4);
DROP TABLE t1;
# Save primary log position for query DROP TABLE t1
save_primary_pos;
let $primary_pos_drop_t1= query_get_value(SHOW BINLOG EVENTS, Pos, 7);
let $primary_log_file= query_get_value(SHOW BINLOG EVENTS, Log_name, 7);

CREATE TABLE t2(n INT NOT NULL AUTO_INCREMENT PRIMARY KEY);
# Save primary log position for query CREATE TABLE t2
save_primary_pos;
let $primary_pos_create_t2= query_get_value(SHOW BINLOG EVENTS, Pos, 8);

INSERT INTO t2 VALUES (1),(2);
save_primary_pos;
# Save primary log position for query INSERT INTO t2 VALUES (1),(2);
let $primary_pos_insert1_t2= query_get_value(SHOW BINLOG EVENTS, End_log_pos, 12);
sync_replica_with_primary;

# Save relay log position for query INSERT INTO t2 VALUES (1),(2);
let $relay_pos_insert1_t2= query_get_value(show replica status, Relay_Log_Pos, 1);

connection primary;
INSERT INTO t2 VALUES (3),(4);
DROP TABLE t2;
# Save primary log position for query INSERT INTO t2 VALUES (1),(2);
let $primary_pos_drop_t2= query_get_value(SHOW BINLOG EVENTS, End_log_pos, 17);
sync_replica_with_primary;

--source include/stop_replica.inc
# Reset replica.
RESET REPLICA;
--disable_query_log
eval CHANGE PRIMARY TO PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=1, PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT;
--enable_query_log

# Try to replicate all queries until drop of t1
connection replica;
echo START REPLICA UNTIL PRIMARY_LOG_FILE='$primary_log_file', PRIMARY_LOG_POS=primary_pos_drop_t1;
--disable_query_log
eval START REPLICA UNTIL PRIMARY_LOG_FILE='$primary_log_file', PRIMARY_LOG_POS=$primary_pos_drop_t1;
--enable_query_log
--source include/wait_for_replica_sql_to_stop.inc

# Here table should be still not deleted
SELECT * FROM t1;
--let $replica_param= Exec_Primary_Log_Pos
--let $replica_param_value= $primary_pos_drop_t1
--source include/check_replica_param.inc

# This should fail right after start
--replace_result 291 PRIMARY_LOG_POS
START REPLICA UNTIL PRIMARY_LOG_FILE='primary-no-such-bin.000001', PRIMARY_LOG_POS=291;
--source include/wait_for_replica_sql_to_stop.inc
# again this table should be still not deleted
SELECT * FROM t1;

--let $replica_param= Exec_Primary_Log_Pos
--let $replica_param_value= $primary_pos_drop_t1
--source include/check_replica_param.inc

# Try replicate all up to and not including the second insert to t2;
echo START REPLICA UNTIL RELAY_LOG_FILE='replica-relay-bin.000002', RELAY_LOG_POS=relay_pos_insert1_t2;
--disable_query_log
eval START REPLICA UNTIL RELAY_LOG_FILE='replica-relay-bin.000002', RELAY_LOG_POS=$relay_pos_insert1_t2;
--enable_query_log
--source include/wait_for_replica_sql_to_stop.inc
SELECT * FROM t2;

--let $replica_param= Exec_Primary_Log_Pos
--let $replica_param_value= $primary_pos_insert1_t2
--source include/check_replica_param.inc

# clean up
START REPLICA;
--source include/wait_for_replica_to_start.inc
connection primary;
sync_replica_with_primary;
--source include/stop_replica.inc

# This should stop immediately as we are already there
echo START REPLICA SQL_THREAD UNTIL PRIMARY_LOG_FILE='$primary_log_file', PRIMARY_LOG_POS=primary_pos_create_t2;
--disable_query_log
eval START REPLICA SQL_THREAD UNTIL PRIMARY_LOG_FILE='$primary_log_file', PRIMARY_LOG_POS=$primary_pos_create_t2;
--enable_query_log
let $replica_param= Until_Log_Pos;
let $replica_param_value= $primary_pos_create_t2;
--source include/wait_for_replica_param.inc
--source include/wait_for_replica_sql_to_stop.inc
# here the sql replica thread should be stopped
--let $replica_param= Exec_Primary_Log_Pos
--let $replica_param_value= $primary_pos_drop_t2
--source include/check_replica_param.inc

#testing various error conditions
--replace_result 561 PRIMARY_LOG_POS
--error 1277
START REPLICA UNTIL PRIMARY_LOG_FILE='primary-bin', PRIMARY_LOG_POS=561;
--replace_result 561 PRIMARY_LOG_POS 12 RELAY_LOG_POS
--error 1277
START REPLICA UNTIL PRIMARY_LOG_FILE='primary-bin.000001', PRIMARY_LOG_POS=561, RELAY_LOG_POS=12;
--error 1277
START REPLICA UNTIL PRIMARY_LOG_FILE='primary-bin.000001';
--error 1277
START REPLICA UNTIL RELAY_LOG_FILE='replica-relay-bin.000009';
--replace_result 561 PRIMARY_LOG_POS
--error 1277
START REPLICA UNTIL RELAY_LOG_FILE='replica-relay-bin.000002', PRIMARY_LOG_POS=561;
# Warning should be given for second command
START REPLICA;
--replace_result 740 PRIMARY_LOG_POS
START REPLICA UNTIL PRIMARY_LOG_FILE='primary-bin.000001', PRIMARY_LOG_POS=740;

--source include/stop_replica.inc
# Clear replica IO error.
RESET REPLICA;

--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
