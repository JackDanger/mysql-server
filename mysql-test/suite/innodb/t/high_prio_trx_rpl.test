# Scenario: High prio setup with replication.
# T1 and T2 run on primary.
#  T1= ({R(B), W(B)}, )
#  T2= ({R(B), W(B), C}, HIGH PRIORITY)
#
# Outcome: T2 completes and T1 abort.T2 is replicated to replica.

--source include/not_embedded.inc
--source include/have_innodb.inc
--source include/primary-replica.inc
--source include/count_sessions.inc

CREATE TABLE t1 (c1 INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (0);

--connect(con1, localhost,root,,test,$PRIMARY_MYPORT)

--echo
--echo # On connection primary
--connection primary
START TRANSACTION;
UPDATE t1 SET c1=1 WHERE c1=0;

--echo
--echo # On connection con1
--connection con1
--source include/start_transaction_high_prio.inc
UPDATE t1 SET c1=2 WHERE c1=0;
COMMIT;
--disconnect con1

--echo
--echo # On connection primary
--connection primary
--error ER_ERROR_DURING_COMMIT
COMMIT;

--echo # Row with value 2 is expected on primary.
SELECT * FROM t1;

--source include/sync_replica_sql_with_primary.inc
-- connection replica
--echo # Row with value 2 is expected on replica.
SELECT * FROM t1;

--echo
--echo # On connection primary
-- connection primary
DROP TABLE t1;
--source include/wait_until_count_sessions.inc
--source include/sync_replica_sql_with_primary.inc
--source include/rpl_end.inc
