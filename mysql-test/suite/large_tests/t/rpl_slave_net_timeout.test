#
#  Testing reconnecting by replica as specified by `replica_net_timeout'
#
#  Bug #50296 Replica reconnects earlier than the prescribed replica_net_timeout value
#
--source include/primary-replica.inc


# save global env
connection primary;
set @save_general_log = @@global.general_log;
set @save_log_output = @@global.log_output;

connection replica;
set @save_replica_net_timeout = @@global.replica_net_timeout;

connection primary;
set @@global.general_log = ON;
set @@global.log_output = 'table,file';

connection replica;
--source include/stop_replica.inc
#
# if heartbeat is disabled then reconnecting to the idle primary
# should happen with `replica_net_timeout' period.
# Since it's the real time that is measured, `replica_net_timeout'
# merely guarantees that reconnecting can *not* happen earlier of a value specified.
# That is there can't an exact estimate for how many time it will happen.
#
# The following lines verify that having idle primary
# for more than 2 * replica_net_timeout seconds and
# replica.net_read_timeout < replica_net_timeout
# won't cause reconnecting by the replica within at least
# replica_net_timeout interval.
#
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval change primary to primary_host = '127.0.0.1',primary_port = $PRIMARY_MYPORT,
primary_user = 'root', primary_heartbeat_period = 0;

set @@global.replica_net_timeout = @@global.net_read_timeout * 2;
let $idle_time=`select @@global.replica_net_timeout * 2`;

let $replica_net_timeout = `select @@global.replica_net_timeout`;

--source include/start_replica.inc

--disable_query_log
--disable_result_log
eval select 'primary is idle for ', sleep($idle_time);
--enable_result_log
--enable_query_log

# querying general-log

connection primary;

# In particular the last reconnection timestamp must be greater or equal to
# the previous one + replica_net_timeout

--let $ts_last= `select time_to_sec(event_time) from (select event_time from mysql.general_log as t_1 where command_type like 'Connect' order by event_time desc limit 2) as t_2 order by event_time desc limit 1`
--let $ts_prev= `select time_to_sec(event_time) from (select event_time from mysql.general_log as t_1 where command_type like 'Connect' order by event_time desc limit 2) as t_2 order by event_time asc limit 1`

--let $timeout= $idle_time + 10
while ($timeout)
{
  --let $ts_last= `select time_to_sec(event_time) from (select event_time from mysql.general_log as t_1 where command_type like 'Connect' order by event_time desc limit 2) as t_2 order by event_time desc limit 1`
  --let $ts_flag= `select $ts_last-$ts_prev>=$replica_net_timeout`
  if($ts_flag)
  {
     --let $timeout=1
  }
  --dec $timeout
  --sleep 1
}

--let $assert_cond= $ts_flag=1
--let $assert_text= time between last reconnection and the reconnection before that should be >= replica_net_timeout
--source include/assert.inc

# cleanup

# restore global env
connection primary;
set @@global.general_log = @save_general_log;
set @@global.log_output = @save_log_output;
connection replica;
set @@global.replica_net_timeout = @save_replica_net_timeout;

--source include/rpl_end.inc
