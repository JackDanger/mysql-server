include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
SET default_storage_engine=ndb;

=== NDB -> MYISAM ===

[connection replica]
set @old_replica_exec_mode= @@global.replica_exec_mode;
set @@global.replica_exec_mode= 'IDEMPOTENT';
CREATE TABLE mysql.ndb_apply_status
( server_id INT UNSIGNED NOT NULL,
epoch BIGINT UNSIGNED NOT NULL,
log_name VARCHAR(255) BINARY NOT NULL,
start_pos BIGINT UNSIGNED NOT NULL,
end_pos BIGINT UNSIGNED NOT NULL,
PRIMARY KEY USING HASH (server_id)) ENGINE=MYISAM;
SET @old_replica_storage_engine=@@global.default_storage_engine;
SET @@global.default_storage_engine=myisam;
include/start_replica.inc
--- Doing pre test cleanup --- 
DROP TABLE IF EXISTS t1;
--- Create Table Section ---
CREATE TABLE t1 (id MEDIUMINT NOT NULL, 
b1 INT, 
vc VARCHAR(255), 
bc CHAR(255), 
d DECIMAL(10,4) DEFAULT 0, 
f FLOAT DEFAULT 0, 
total BIGINT UNSIGNED, 
y YEAR, 
t DATE, 
PRIMARY KEY(id));
--- Show table on primary ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` varchar(255) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
--- Show table on replica ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` varchar(255) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
4
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
4
TRUNCATE TABLE t1;
--- Check that simple Alter statements are replicated correctly --
ALTER TABLE t1 DROP PRIMARY KEY;
ALTER TABLE t1 MODIFY vc char(32);
--- Show the new improved table on the primary ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` char(32) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
--- Make sure that our tables on replica are still same engine ---
--- and that the alter statements replicated correctly ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` char(32) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
4
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
4
TRUNCATE TABLE t1;
--- Check that replication works when replica has more columns than primary
ALTER TABLE t1 ADD PRIMARY KEY(id,total);
ALTER TABLE t1 MODIFY vc TEXT;
INSERT INTO t1 VALUES(3,1,'Testing MySQL databases is a cool ',
'Must make it bug free for the customer',
654321.4321,15.21,0,1965,"1905-11-14");
INSERT INTO t1 VALUES(20,1,'Testing MySQL databases is a cool ',
'Must make it bug free for the customer',
654321.4321,15.21,0,1965,"1965-11-14");
INSERT INTO t1 VALUES(50,1,'Testing MySQL databases is a cool ',
'Must make it bug free for the customer',
654321.4321,15.21,0,1965,"1985-11-14");
--- Add columns on replica ---
ALTER TABLE t1 ADD (u int, v char(16) default 'default');
UPDATE t1 SET u=7 WHERE id < 50;
UPDATE t1 SET v='explicit' WHERE id >10;
--- Show changed table on replica ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` text,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned NOT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL,
  `u` int(11) DEFAULT NULL,
  `v` char(16) DEFAULT 'default',
  PRIMARY KEY (`id`,`total`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
SELECT * 
FROM t1
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t	u	v
3	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14	7	default
20	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14	7	explicit
50	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14	NULL	explicit
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
3	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
20	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
50	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t	u	v
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14	NULL	default
3	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14	7	default
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14	NULL	default
20	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14	7	explicit
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14	NULL	default
50	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14	NULL	explicit
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14	NULL	default
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14	NULL	default
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
3	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
20	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
50	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t	u	v
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	default
3	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	7	default
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	default
20	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	7	explicit
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	default
50	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	explicit
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
7
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
7
TRUNCATE TABLE t1;
TRUNCATE TABLE t1;
--- Check that replication works when primary has more columns than replica
--- Remove columns on replica ---
ALTER TABLE t1 DROP COLUMN v;
ALTER TABLE t1 DROP COLUMN u;
ALTER TABLE t1 DROP COLUMN t;
ALTER TABLE t1 DROP COLUMN y;
--- Show changed table on replica ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` text,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned NOT NULL,
  PRIMARY KEY (`id`,`total`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
4
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
4
TRUNCATE TABLE t1;
TRUNCATE TABLE t1;
--- Do Cleanup --
DROP TABLE IF EXISTS t1;
[connection replica]
include/stop_replica.inc

=== NDB -> INNODB ===

[connection replica]
alter table mysql.ndb_apply_status engine=innodb;
SET @@global.default_storage_engine=innodb;
include/start_replica.inc
--- Doing pre test cleanup --- 
DROP TABLE IF EXISTS t1;
--- Create Table Section ---
CREATE TABLE t1 (id MEDIUMINT NOT NULL, 
b1 INT, 
vc VARCHAR(255), 
bc CHAR(255), 
d DECIMAL(10,4) DEFAULT 0, 
f FLOAT DEFAULT 0, 
total BIGINT UNSIGNED, 
y YEAR, 
t DATE, 
PRIMARY KEY(id));
--- Show table on primary ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` varchar(255) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
--- Show table on replica ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` varchar(255) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
4
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
4
TRUNCATE TABLE t1;
--- Check that simple Alter statements are replicated correctly --
ALTER TABLE t1 DROP PRIMARY KEY;
ALTER TABLE t1 MODIFY vc char(32);
--- Show the new improved table on the primary ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` char(32) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
--- Make sure that our tables on replica are still same engine ---
--- and that the alter statements replicated correctly ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` char(32) DEFAULT NULL,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned DEFAULT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a coo	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a coo	updated	654321.4321	15.21	0	1965	2006-02-22
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
4
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
4
TRUNCATE TABLE t1;
--- Check that replication works when replica has more columns than primary
ALTER TABLE t1 ADD PRIMARY KEY(id,total);
ALTER TABLE t1 MODIFY vc TEXT;
INSERT INTO t1 VALUES(3,1,'Testing MySQL databases is a cool ',
'Must make it bug free for the customer',
654321.4321,15.21,0,1965,"1905-11-14");
INSERT INTO t1 VALUES(20,1,'Testing MySQL databases is a cool ',
'Must make it bug free for the customer',
654321.4321,15.21,0,1965,"1965-11-14");
INSERT INTO t1 VALUES(50,1,'Testing MySQL databases is a cool ',
'Must make it bug free for the customer',
654321.4321,15.21,0,1965,"1985-11-14");
--- Add columns on replica ---
ALTER TABLE t1 ADD (u int, v char(16) default 'default');
UPDATE t1 SET u=7 WHERE id < 50;
UPDATE t1 SET v='explicit' WHERE id >10;
--- Show changed table on replica ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` text,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned NOT NULL,
  `y` year(4) DEFAULT NULL,
  `t` date DEFAULT NULL,
  `u` int(11) DEFAULT NULL,
  `v` char(16) DEFAULT 'default',
  PRIMARY KEY (`id`,`total`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
SELECT * 
FROM t1
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t	u	v
3	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14	7	default
20	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14	7	explicit
50	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14	NULL	explicit
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
3	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
20	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
50	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t	u	v
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14	NULL	default
3	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14	7	default
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14	NULL	default
20	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14	7	explicit
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14	NULL	default
50	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14	NULL	explicit
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14	NULL	default
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14	NULL	default
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
3	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
20	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
50	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t	u	v
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	default
3	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	7	default
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	default
20	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	7	explicit
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	default
50	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22	NULL	explicit
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
7
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
7
TRUNCATE TABLE t1;
TRUNCATE TABLE t1;
--- Check that replication works when primary has more columns than replica
--- Remove columns on replica ---
ALTER TABLE t1 DROP COLUMN v;
ALTER TABLE t1 DROP COLUMN u;
ALTER TABLE t1 DROP COLUMN t;
ALTER TABLE t1 DROP COLUMN y;
--- Show changed table on replica ---
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` mediumint(9) NOT NULL,
  `b1` int(11) DEFAULT NULL,
  `vc` text,
  `bc` char(255) DEFAULT NULL,
  `d` decimal(10,4) DEFAULT '0.0000',
  `f` float DEFAULT '0',
  `total` bigint(20) unsigned NOT NULL,
  PRIMARY KEY (`id`,`total`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
START REPLICA;
--- Populate t1 with data ---
--- Select from t1 on primary --- 
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total	y	t
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1965-11-14
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1985-11-14
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1905-11-14
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	1995-11-14
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0	1965	2005-11-14
--- Select from t1 on replica ---
select *
from t1 
order by id;
id	b1	vc	bc	d	f	total
2	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
4	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
42	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
142	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
412	1	Testing MySQL databases is a cool 	Must make it bug free for the customer	654321.4321	15.21	0
--- Perform basic operation on primary ---
--- and ensure replicated correctly ---
--- Update t1 on primary --
UPDATE t1 SET b1 = 0, bc='updated', t="2006-02-22" 
WHERE id < 100 
ORDER BY id;
--- Check the update on primary --- 
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total	y	t
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0	1965	2006-02-22
--- Check Update on replica ---
SELECT *
FROM t1 
WHERE id < 100
ORDER BY id;
id	b1	vc	bc	d	f	total
2	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0
4	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0
42	0	Testing MySQL databases is a cool 	updated	654321.4321	15.21	0
--- Remove a record from t1 on primary ---
DELETE FROM t1 WHERE id = 412;
--- Show current count on primary for t1 ---
SELECT COUNT(*) FROM t1;
COUNT(*)
4
--- Show current count on replica for t1 --- 
SELECT COUNT(*) FROM t1;
COUNT(*)
4
TRUNCATE TABLE t1;
TRUNCATE TABLE t1;
--- Do Cleanup --
DROP TABLE IF EXISTS t1;
[connection replica]
include/stop_replica.inc
[connection replica]
drop table mysql.ndb_apply_status;
set @@global.replica_exec_mode= @old_replica_exec_mode;
SET @@global.default_storage_engine=@old_replica_storage_engine;
