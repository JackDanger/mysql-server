#############################################################
# Author: Rafal Somla
# Date: 2006-08-20
# Purpose: Trying to test ability to replicate from cluster
# to other engines (innodb, myisam).
##############################################################
--source include/have_ndb.inc
--source include/have_innodb.inc
--source include/have_binlog_format_mixed_or_row.inc

let $rpl_skip_start_replica= 1; # Don't start replica automatically
--source include/primary-replica.inc

# On primary use NDB as storage engine.
SET default_storage_engine=ndb;

--echo
--echo === NDB -> MYISAM ===
--echo
--source include/rpl_connection_replica.inc

# Remove any old ndb_apply_status from replicas datadir
let $datadir= `SELECT @@datadir`;
--error 0,1
remove_file $datadir/mysql/ndb_apply_status.frm;
--error 0,1
remove_file $datadir/mysql/ndb_apply_status.ndb;

set @old_replica_exec_mode= @@global.replica_exec_mode;
set @@global.replica_exec_mode= 'IDEMPOTENT';
CREATE TABLE mysql.ndb_apply_status
                   ( server_id INT UNSIGNED NOT NULL,
                   epoch BIGINT UNSIGNED NOT NULL,
                   log_name VARCHAR(255) BINARY NOT NULL,
                   start_pos BIGINT UNSIGNED NOT NULL,
                   end_pos BIGINT UNSIGNED NOT NULL,
                   PRIMARY KEY USING HASH (server_id)) ENGINE=MYISAM;

# Reconfigure replica to use MyISAM as default engine
SET @old_replica_storage_engine=@@global.default_storage_engine;
SET @@global.default_storage_engine=myisam;

--source include/start_replica.inc
--source suite/ndb_rpl/t/ndb_rpl_2multi_basic.inc
--source include/rpl_connection_replica.inc
--source include/stop_replica.inc

--echo
--echo === NDB -> INNODB ===
--echo

# Reconfigure replica to use Innodb as default engine
--source include/rpl_connection_replica.inc

alter table mysql.ndb_apply_status engine=innodb;
SET @@global.default_storage_engine=innodb;

--source include/start_replica.inc
--source suite/ndb_rpl/t/ndb_rpl_2multi_basic.inc
--source include/rpl_connection_replica.inc
--source include/stop_replica.inc

# Cleanup
--source include/rpl_connection_replica.inc
drop table mysql.ndb_apply_status;
set @@global.replica_exec_mode= @old_replica_exec_mode;
SET @@global.default_storage_engine=@old_replica_storage_engine;

