--source include/not_embedded.inc
--source include/have_perfschema.inc
--source include/no_protocol.inc

-- source include/primary-replica.inc

connection primary;
--echo **** On Primary ****

--disable_warnings
drop table if exists test.marker;
--enable_warnings

create table test.marker(a int) engine=innodb;
insert into test.marker values (1);
select * from test.marker;

truncate table performance_schema.events_waits_history_long;
truncate table performance_schema.events_statements_summary_by_digest;

update performance_schema.setup_instruments
  set enabled='YES', timed='YES';

sync_replica_with_primary;
--echo **** On Replica ****

truncate table performance_schema.events_waits_history_long;
truncate table performance_schema.events_statements_summary_by_digest;

update performance_schema.setup_instruments
  set enabled='YES', timed='NO';

connection primary;
--echo **** On Primary ****

select * from performance_schema.setup_instruments
  where timed='NO';

select "This better be in the primary" as in_primary_digest;

insert into performance_schema.setup_objects
  values ('TABLE', 'primary', 'foo', 'YES', 'YES');

select * from performance_schema.setup_objects
  order by object_type, object_schema, object_name;

select digest, digest_text, count_star
  from performance_schema.events_statements_summary_by_digest
  where digest_text like "%in_%_digest%";

insert into test.marker values (2);

sync_replica_with_primary;
--echo **** On Replica ****

select * from test.marker;

select * from performance_schema.setup_instruments
  where timed='YES';

select "This better be in the replica" as in_replica_digest;

insert into performance_schema.setup_objects
  values ('TABLE', 'replica', 'foo', 'YES', 'YES');

select * from performance_schema.setup_objects
  order by object_type, object_schema, object_name;

select digest, digest_text, count_star
  from performance_schema.events_statements_summary_by_digest
  where digest_text like "%in_%_digest%";

connection primary;
--echo **** On Primary ****
delete from performance_schema.setup_objects
  where object_schema='primary';
sync_replica_with_primary;
--echo **** On Replica ****

delete from performance_schema.setup_objects
  where object_schema='replica';
select * from performance_schema.setup_objects;

--disable_query_log
--disable_warnings
connection primary;
drop table test.marker;
sync_replica_with_primary;
--enable_warnings
--enable_query_log
--source include/rpl_end.inc
