include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
call mtr.add_suppression('Replica can not handle replication events with the checksum that primary is configured to log');
call mtr.add_suppression('Replication event checksum verification failed');
call mtr.add_suppression('Relay log write failure: could not queue event from primary');
call mtr.add_suppression('Event crc check failed! Most likely there is event corruption');
call mtr.add_suppression("Replica SQL for channel '': Error initializing relay log position: I/O error reading event at position .*, Error_code: 1593");
call mtr.add_suppression('Primary is configured to log replication events with checksum, but will not send such events to replicas that cannot process');
set @primary_save_binlog_checksum= @@global.binlog_checksum;
set @save_primary_verify_checksum =  @@global.primary_verify_checksum;
select @@global.binlog_checksum as 'must be CRC32 because of the command line option';
must be CRC32 because of the command line option
CRC32
select @@session.binlog_checksum as 'no session var';
ERROR HY000: Variable 'binlog_checksum' is a GLOBAL variable
select @@global.primary_verify_checksum  as 'must be zero because of default';
must be zero because of default
0
select @@session.primary_verify_checksum  as 'no session var';
ERROR HY000: Variable 'primary_verify_checksum' is a GLOBAL variable
set @replica_save_binlog_checksum= @@global.binlog_checksum;
set @save_replica_sql_verify_checksum = @@global.replica_sql_verify_checksum;
select @@global.replica_sql_verify_checksum  as 'must be one because of default';
must be one because of default
1
select @@session.replica_sql_verify_checksum  as 'no session var';
ERROR HY000: Variable 'replica_sql_verify_checksum' is a GLOBAL variable
show binary logs;
Log_name	File_size
primary-bin.000001	#
set @@global.binlog_checksum = NONE;
*** must be rotations seen ***
show binary logs;
Log_name	File_size
primary-bin.000001	#
primary-bin.000002	#
set @@global.binlog_checksum = default;
set @@global.binlog_checksum = CRC32;
set @@global.binlog_checksum = CRC32;
set @@global.primary_verify_checksum = 0;
set @@global.primary_verify_checksum = default;
set @@global.binlog_checksum = ADLER32;
ERROR 42000: Variable 'binlog_checksum' can't be set to the value of 'ADLER32'
set @@global.primary_verify_checksum = 2;
ERROR 42000: Variable 'primary_verify_checksum' can't be set to the value of '2'
set @@global.replica_sql_verify_checksum = 0;
set @@global.replica_sql_verify_checksum = default;
set @@global.replica_sql_verify_checksum = 2;
ERROR 42000: Variable 'replica_sql_verify_checksum' can't be set to the value of '2'
set @@global.binlog_checksum = NONE;
create table t1 (a int);
flush logs;
flush logs;
flush logs;
flush logs;
flush logs;
flush logs;
select count(*) as zero from t1;
zero
0
include/stop_replica.inc
set @@global.binlog_checksum = CRC32;
insert into t1 values (1) /* will not be applied on replica due to simulation */;
set @@global.debug='d,simulate_replica_unaware_checksum';
start replica;
include/wait_for_replica_io_error.inc [errno=1236]
Warnings:
Warning	3090	Changing sql mode 'NO_AUTO_CREATE_USER' is deprecated. It will be removed in a future release.
Last_IO_Error = 'Got fatal error 1236 from primary when reading data from binary log: 'Replica can not handle replication events with the checksum that primary is configured to log; the first event 'primary-bin.000009' at XXX, the last event read from './primary-bin.000010' at XXX, the last byte read from './primary-bin.000010' at XXX.''
Warnings:
Warning	3090	Changing sql mode 'NO_AUTO_CREATE_USER' is deprecated. It will be removed in a future release.
select count(*) as zero from t1;
zero
0
include/stop_replica.inc
set @@global.debug='';
include/start_replica.inc
set @@global.primary_verify_checksum = 1;
set @@session.debug='d,simulate_checksum_test_failure';
show binlog events;
ERROR HY000: Error when executing command SHOW BINLOG EVENTS: Wrong offset or I/O error
set @@session.debug='';
set @@global.primary_verify_checksum = default;
include/stop_replica.inc
create table t2 (a int);
set @@global.debug='d,simulate_checksum_test_failure';
start replica io_thread;
include/wait_for_replica_io_error.inc [errno=1595, 1743]
set @@global.debug='';
start replica io_thread;
include/sync_replica_io_with_primary.inc
set @@global.replica_sql_verify_checksum = 1;
set @@global.debug='d,simulate_checksum_test_failure';
start replica sql_thread;
include/wait_for_replica_sql_error.inc [errno=1593]
Last_SQL_Error = 'Error initializing relay log position: I/O error reading event at position 4'
include/stop_replica.inc
set @@global.debug='';
include/start_replica.inc
select count(*) as 'must be zero' from t2;
must be zero
0
stop replica;
reset replica;
reset primary;
set @@global.binlog_checksum= IF(floor((rand()*1000)%2), "CRC32", "NONE");
flush logs;
set @@global.binlog_checksum= CRC32;
reset primary;
flush logs;
create table t3 (a int, b char(5));
include/start_replica.inc
select count(*) as 'must be zero' from t3;
must be zero
0
include/stop_replica.inc
change primary to primary_host='127.0.0.1',primary_port=PRIMARY_PORT, primary_user='root';
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
flush logs;
reset primary;
insert into t3 value (1, @@global.binlog_checksum);
include/start_replica.inc
flush logs;
select count(*) as 'must be one' from t3;
must be one
1
set @@global.binlog_checksum= IF(floor((rand()*1000)%2), "CRC32", "NONE");
insert into t3 value (1, @@global.binlog_checksum);
drop table t1, t2, t3;
set @@global.binlog_checksum = @primary_save_binlog_checksum;
set @@global.primary_verify_checksum = @save_primary_verify_checksum;
set @@global.binlog_checksum = @replica_save_binlog_checksum;
set @@global.replica_sql_verify_checksum = @save_replica_sql_verify_checksum;
include/rpl_end.inc
