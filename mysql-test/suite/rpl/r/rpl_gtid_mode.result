include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
==== Initialize ====
call mtr.add_suppression("Replica I/O for channel '': The replication receiver thread cannot start");
call mtr.add_suppression("Replica I/O for channel '': The replica IO thread stops");
call mtr.add_suppression("Replica I/O for channel '': Got fatal error 1236 from primary when reading data from binary log: 'Cannot replicate GTID-transaction when @@GLOBAL.GTID_MODE = OFF");
call mtr.add_suppression("Replica I/O for channel '': Cannot replicate GTID-transaction when @@GLOBAL.GTID_MODE = OFF");
call mtr.add_suppression("GTID_LOG_EVENT or ANONYMOUS_GTID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT or an ANONYMOUS_GTID_LOG_EVENT.");
call mtr.add_suppression("An unexpected event sequence was detected by the IO thread while queuing the event received from primary");
call mtr.add_suppression("Detected misconfiguration: replication channel '' was configured with AUTO_POSITION = 1, but the server was started with --gtid-mode=off.");
call mtr.add_suppression("Replica I/O for channel '': Relay log write failure: could not queue event from primary");
call mtr.add_suppression("Got fatal error 1236 from primary when reading data from binary log: 'Cannot replicate anonymous transaction when @@GLOBAL.GTID_MODE = ON");
call mtr.add_suppression("Replica I/O for channel '': Cannot replicate anonymous transaction when @@GLOBAL.GTID_MODE = ON");
call mtr.add_suppression("Replica I/O for channel '': Cannot replicate anonymous transaction when AUTO_POSITION = 1");
call mtr.add_suppression("Got fatal error 1236 from primary when reading data from binary log: 'Cannot replicate anonymous transaction when AUTO_POSITION = 1,");
call mtr.add_suppression("Replica I/O for channel '': The primary uses an unknown GTID_MODE 'on_something'. Treating it as 'ON'.");
call mtr.add_suppression("Replica I/O for channel '': The primary uses an unknown GTID_MODE 'off_something'. Treating it as 'OFF'.");
call mtr.add_suppression("Could not open .* for logging.*. Turning logging off for the whole duration of the MySQL server process.");
include/sync_replica_sql_with_primary.inc
include/stop_replica.inc
==== Checks performed at server start ====
---- gtid-mode=ON requires enforce-gtid-consistency ----
include/rpl_stop_server.inc [server_number=2]
include/assert_command_output.inc
include/rpl_start_server.inc [server_number=2 gtids=off]
==== Primary-replica handshake checks ====
[connection primary]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = ON;
[connection replica]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = ON;
include/rpl_set_gtid_mode.inc [0 on servers 1]
include/rpl_set_gtid_mode.inc [0 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
ERROR HY000: CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1 cannot be executed because @@GLOBAL.GTID_MODE = OFF.
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [1 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [2 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [3 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [1 on servers 1]
include/rpl_set_gtid_mode.inc [0 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
ERROR HY000: CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1 cannot be executed because @@GLOBAL.GTID_MODE = OFF.
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [1 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [2 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [3 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [2 on servers 1]
include/rpl_set_gtid_mode.inc [0 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
ERROR HY000: CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1 cannot be executed because @@GLOBAL.GTID_MODE = OFF.
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [1 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [2 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [3 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [3 on servers 1]
include/rpl_set_gtid_mode.inc [0 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
ERROR HY000: CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1 cannot be executed because @@GLOBAL.GTID_MODE = OFF.
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [1 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [2 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
include/rpl_set_gtid_mode.inc [3 on servers 2]
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_to_start.inc
include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
#
# Test for ER_CANT_REPLICATE_GTID_WITH_GTID_MODE_OFF
#   eng "Cannot replicate GTID-transaction when GTID_MODE = OFF, at file %.512s, position %lld. Found a Gtid_log_event when @@GLOBAL.GTID_MODE = OFF.
#
#
# Case 1: Error on Primary(sender thread)
#
include/rpl_set_gtid_mode.inc [ON on servers 1]
[connection primary]
CREATE TABLE t1 (a int);
include/rpl_set_gtid_mode.inc [OFF on servers 1,2]
[connection replica]
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1236  # ER_CANT_REPLICATE_GTID_WITH_GTID_MODE_OFF]
include/assert.inc [sender thread should report - Cannot replicate GTID-transaction when @@GLOBAL.GTID_MODE = OFF.]
include/assert_grep.inc [Receiver thread should report - Cannot replicate GTID-transaction when @@GLOBAL.GTID_MODE = OFF.]
[connection primary]
DROP TABLE t1;
RESET PRIMARY;
[connection replica]
RESET REPLICA;
#
# Case 2: Error on Replica(receiver thread)
#
include/rpl_set_gtid_mode.inc [ON on servers 1,2]
[connection replica]
include/start_replica.inc
include/rpl_set_gtid_mode.inc [OFF on servers 2]
[connection primary]
CREATE TABLE t2(a int);
[connection replica]
include/wait_for_replica_io_error.inc [errno=1595 # ER_REPLICA_RELAY_LOG_WRITE_FAILURE]
include/assert_grep.inc [Receiver thread should report - Cannot replicate GTID-transaction when @@GLOBAL.GTID_MODE = OFF.]
[connection primary]
DROP TABLE t2;
[connection replica]
include/rpl_set_gtid_mode.inc [ON on servers 2]
include/start_replica.inc
#
#  Warning: "Detected misconfiguration: replication channel '%.192s' was configured with AUTO_POSITION = 1, but the server was started with --gtid-mode=off.  Either reconfigure replication using CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0 FOR CHANNEL '%.192s', or change GTID_MODE to some value other than OFF, before starting the replica receiver thread."
#
include/rpl_set_gtid_mode.inc [ON on servers 1,2]
[connection replica]
include/stop_replica.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 1;
include/rpl_restart_server.inc [server_number=2 gtids=off]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = ON;
include/assert_grep.inc [While AUTO_POSITION is set, attempt to restart the replica with gtid-mode= off to get ER_STARTING_WITH_GTID_MODE_OFF_AND_AUTO_POSITION.]
#
# ER_CANT_USE_AUTO_POSITION_WITH_GTID_MODE_OFF
#   eng "The replication receiver thread for channel '%s' cannot start in AUTO_POSITION mode: this server uses GTID_MODE = OFF."
#
START REPLICA IO_THREAD;
ERROR HY000: The replication receiver thread for channel '%s' cannot start in AUTO_POSITION mode: this server uses @@GLOBAL.GTID_MODE = OFF.
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 0;
#
# ER_CANT_REPLICATE_ANONYMOUS_WITH_GTID_MODE_ON
#   eng "Cannot replicate anonymous transaction when GTID_MODE = ON, at file %.512s, position %lld."
#
# Case 1: Error on primary(sender thread)
#
include/rpl_set_gtid_mode.inc [OFF on servers 1]
[connection primary]
CREATE TABLE t3(a int);
include/rpl_set_gtid_mode.inc [ON on servers 1,2]
[connection replica]
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1236 # ER_CANT_REPLICATE_ANONYMOUS_WITH_GTID_MODE_ON]
include/assert.inc [sender thread should report - Cannot replicate anonymous transaction when @@GLOBAL.GTID_MODE = ON.]
include/assert_grep.inc [While gtid-mode=on, replica expects an anonymous event to get ER_CANT_REPLICATE_ANONYMOUS_WITH_GTID_MODE_ON.]
[connection primary]
DROP TABLE t3;
include/rpl_reset.inc
Warnings:
Note	3084	Replication thread(s) for channel '' are already stopped.
#
# Case 2: Error on replica(receiver thread)
#
include/rpl_set_gtid_mode.inc [OFF on servers 1]
[connection primary]
CREATE TABLE t4(a int);
[connection replica]
include/wait_for_replica_io_error.inc [errno=1595 # ER_REPLICA_RELAY_LOG_WRITE_FAILURE]
include/assert_grep.inc [While gtid-mode=on, replica expects an anonymous event to get ER_CANT_REPLICATE_ANONYMOUS_WITH_GTID_MODE_ON.]
include/stop_replica_sql.inc
include/rpl_set_gtid_mode.inc [OFF on servers 2]
[connection primary]
DROP TABLE t4;
RESET PRIMARY;
[connection replica]
RESET REPLICA;
include/start_replica.inc
[connection primary]
include/sync_replica_sql_with_primary.inc
#
# ER_CANT_REPLICATE_ANONYMOUS_WITH_AUTO_POSITION
#   eng "Cannot replicate anonymous transaction when AUTO_POSITION = 1, at file %.512s, position %lld."
#
#
# Case 1: Error on primary(sender thread).
#
include/rpl_set_gtid_mode.inc [ON on servers 1,2]
[connection primary]
CREATE TABLE t5(a int);
include/sync_replica_sql_with_primary.inc
include/stop_replica.inc
[connection primary]
INSERT INTO t5 VALUES(2);
include/rpl_set_gtid_mode.inc [ON_PERMISSIVE on servers 1]
SET @@SESSION.GTID_NEXT = 'ANONYMOUS';
INSERT INTO t5 VALUES(1);
include/rpl_set_gtid_mode.inc [ON on servers 1]
include/rpl_set_gtid_mode.inc [ON on servers 2]
[connection replica]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1236 # ER_CANT_REPLICATE_ANONYMOUS_WITH_AUTO_POSITION]
include/assert.inc [sender thread should report - Cannot replicate anonymous transaction when AUTO_POSITION = 1.]
include/assert_grep.inc [While AUTO_POSITION is enabled, Primary sends an anonymous transaction resulting into ER_CANT_REPLICATE_ANONYMOUS_WITH_AUTO_POSITION.]
include/rpl_restart_server.inc [server_number=1 gtids=off]
[connection primary]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = ON;
[connection replica]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 0;
include/rpl_set_gtid_mode.inc [OFF on servers 2]
[connection primary]
DROP TABLE t5;
RESET PRIMARY;
[connection replica]
RESET REPLICA;
include/start_replica.inc
[connection primary]
include/sync_replica_sql_with_primary.inc
#
# Case 2: Error on Replica(receiver thread).
#
[connection primary]
SET @debug_saved= @@GLOBAL.DEBUG;
SET GLOBAL DEBUG= "d,skip_sender_anon_autoposition_error";
include/rpl_set_gtid_mode.inc [ON on servers 1,2]
[connection primary]
CREATE TABLE t6(a int);
include/sync_replica_sql_with_primary.inc
include/stop_replica.inc
[connection primary]
INSERT INTO t6 VALUES(2);
include/rpl_set_gtid_mode.inc [ON_PERMISSIVE on servers 1]
SET @@SESSION.GTID_NEXT = 'ANONYMOUS';
INSERT INTO t6 VALUES(1);
include/rpl_set_gtid_mode.inc [ON on servers 1]
include/rpl_set_gtid_mode.inc [ON on servers 2]
[connection replica]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 1;
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1595 # ER_REPLICA_RELAY_LOG_WRITE_FAILURE]
include/assert_grep.inc [While AUTO_POSITION is enabled, Primary sends an anonymous transaction resulting into ER_CANT_REPLICATE_ANONYMOUS_WITH_AUTO_POSITION.]
[connection replica]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 0;
include/rpl_set_gtid_mode.inc [OFF on servers 1,2]
[connection primary]
SET @@GLOBAL.DEBUG= @debug_saved;
SET DEBUG_SYNC= 'RESET';
DROP TABLE t6;
RESET PRIMARY;
[connection replica]
RESET REPLICA;
include/start_replica.inc
[connection primary]
include/sync_replica_sql_with_primary.inc
#
# Verify the behaviour when rotate fails while setting gtid_mode.
#
[connection replica]
include/start_replica.inc
Warnings:
Note	3083	Replication thread(s) for channel '' are already runnning.
[connection primary]
call mtr.add_suppression("Could not open * for logging");
include/sync_replica_sql_with_primary.inc
include/stop_replica.inc
SET @debug_saved= @@GLOBAL.DEBUG;
SET GLOBAL DEBUG= "d,fault_injection_new_file_rotate_event";
SET GLOBAL binlog_error_action= IGNORE_ERROR;
SET @@GLOBAL.GTID_MODE= OFF_PERMISSIVE;
ERROR HY000: Can't open file: 'replica-bin' (errno: 2 - No such file or directory)
SET @@GLOBAL.GTID_MODE= OFF;
SET @@GLOBAL.DEBUG= @debug_saved;
SET GLOBAL binlog_error_action= ABORT_SERVER;
include/rpl_restart_server.inc [server_number=1 gtids=off]
[connection primary]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = ON;
#
# ER_CANT_SET_GTID_NEXT_TO_ANONYMOUS_WHEN_GTID_MODE_IS_ON
# generated when re-acquiring anonymous ownership
#
[connection primary]
SET GTID_NEXT='ANONYMOUS';
CREATE TABLE t7(a int);
include/rpl_set_gtid_mode.inc [ON on servers 1]
INSERT INTO t7 values (1);
ERROR HY000: @@SESSION.GTID_NEXT cannot be set to ANONYMOUS when @@GLOBAL.GTID_MODE = ON.
SET GTID_NEXT='AUTOMATIC';
DROP TABLE t7;
RESET PRIMARY;
include/rpl_set_gtid_mode.inc [OFF on servers 1]
#
# Error generated if primary has an unknown gtid_mode
#
include/stop_replica.inc
Warnings:
Note	3084	Replication thread(s) for channel '' are already stopped.
RESET REPLICA;
SET @@GLOBAL.DEBUG= 'd,simulate_primary_has_unknown_gtid_mode';
START REPLICA IO_THREAD;
include/wait_for_replica_io_error.inc [errno=1593]
Warnings:
Warning	3090	Changing sql mode 'NO_AUTO_CREATE_USER' is deprecated. It will be removed in a future release.
Last_IO_Error = 'The replica IO thread stops because the primary has an unknown @@GLOBAL.GTID_MODE 'Krakel Spektakel'.'
Warnings:
Warning	3090	Changing sql mode 'NO_AUTO_CREATE_USER' is deprecated. It will be removed in a future release.
SET @@GLOBAL.DEBUG= @debug_saved;
#
# Warning generated if primary has unknown gtid_mode that begins
# with ON or OFF.
#
SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE;
SET @@GLOBAL.DEBUG = 'd,simulate_primary_has_gtid_mode_on_something';
include/start_replica.inc
include/assert_grep.inc [Receiver thread should report that on_something is unknown]
include/stop_replica.inc
SET @@GLOBAL.DEBUG = 'd,simulate_primary_has_gtid_mode_off_something';
include/start_replica.inc
include/assert_grep.inc [Receiver thread should report that off_something is unknown]
include/stop_replica.inc
RESET REPLICA;
#
# ER_CANT_SET_GTID_MODE generated because AUTO_POSITION = 1.
#
include/rpl_set_gtid_mode.inc [ON on servers 1]
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 1;
SET @@GLOBAL.GTID_MODE = OFF;
ERROR HY000: SET @@GLOBAL.GTID_MODE = OFF is not allowed because replication channel '' is configured in AUTO_POSITION mode. Execute CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0 FOR CHANNEL '' before you set @@GLOBAL.GTID_MODE = OFF..
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION = 0;
SET @@GLOBAL.GTID_MODE = OFF;
include/rpl_set_gtid_mode.inc [OFF on servers 1]
[connection primary]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = OFF;
[connection replica]
SET GLOBAL ENFORCE_GTID_CONSISTENCY = OFF;
include/rpl_end.inc
