include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
call mtr.add_suppression("Replica SQL for channel '': .*Could not execute Write_rows event on table d1.t1; Duplicate entry '13' for key 'a'");
call mtr.add_suppression("Replica SQL for channel '': ... The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state.");
call mtr.add_suppression("Error writing relay log configuration.");
include/stop_replica.inc
SET @save.replica_parallel_workers=@@global.replica_parallel_workers;
SET @@global.replica_parallel_workers=2;
include/start_replica.inc
CREATE DATABASE d1;
CREATE DATABASE d2;
CREATE TABLE d1.t1 (a int unique) ENGINE=INNODB;
CREATE TABLE d2.t1 (a int unique) ENGINE=INNODB;
INSERT INTO d1.t1 VALUES (1);
FLUSH LOGS;
include/sync_replica_sql_with_primary.inc
include/stop_replica.inc
CHANGE PRIMARY TO PRIMARY_DELAY=5;
include/start_replica.inc
INSERT INTO d1.t1 VALUES (3);
INSERT INTO d1.t1 VALUES (5);
FLUSH LOGS;
include/stop_replica.inc
CHANGE PRIMARY TO RELAY_LOG_FILE=FILE,  RELAY_LOG_POS= POS;
include/start_replica.inc
include/stop_replica.inc
CHANGE PRIMARY TO RELAY_LOG_FILE=FILE,  RELAY_LOG_POS= POS, PRIMARY_DELAY=0;
include/start_replica.inc
BEGIN;
INSERT INTO d1.t1 VALUES (13);
INSERT INTO d1.t1 VALUES (6);
INSERT INTO d2.t1 VALUES (7);
BEGIN;
INSERT INTO d1.t1 VALUES (13);
BEGIN;
INSERT INTO d2.t1 VALUES (8);
COMMIT;
COMMIT;
INSERT INTO d2.t1 VALUES (9);
COMMIT;
include/wait_for_replica_sql_error.inc [errno=1062]
include/stop_replica_io.inc
CHANGE PRIMARY TO RELAY_LOG_FILE=FILE,  RELAY_LOG_POS= POS;
ERROR HY000: CHANGE PRIMARY cannot be executed when the replica was stopped with an error or killed in MTS mode. Consider using RESET REPLICA or START REPLICA UNTIL.
SET @@global.replica_parallel_workers= @save.replica_parallel_workers;
include/rpl_restart_server.inc [server_number=2 parameters: --relay-log-recovery --skip-replica-start]
SELECT @@global.relay_log_recovery as 'must be ON';
must be ON
1
call mtr.add_suppression("--relay-log-recovery cannot be executed when the replica was stopped with an error or killed in MTS mode; consider using RESET REPLICA or restart the server with --relay-log-recovery = 0");
call mtr.add_suppression("Failed to initialize the primary info structure");
call mtr.add_suppression("Failed to create or recover replication info repositories.");
call mtr.add_suppression("It is not possible to change the type of the relay log repository because there are workers repositories with possible execution gaps. The value of --relay_log_info_repository is altered to one of the found Worker repositories");
include/rpl_restart_server.inc [server_number=2 parameters: --skip-replica-start]
SELECT @@global.relay_log_recovery as 'must be OFF';
must be OFF
0
DELETE FROM d1.t1 WHERE a = 13;
include/start_replica.inc
DROP DATABASE d1;
DROP DATABASE d2;
include/sync_replica_sql_with_primary.inc
[connection replica]
include/stop_replica.inc
SET @save.replica_parallel_workers=@@global.replica_parallel_workers;
SET @@global.replica_parallel_workers=2;
SET @save.relay_log_info_repository=@@global.relay_log_info_repository;
SET @@global.relay_log_info_repository='TABLE';
include/start_replica.inc
[connection primary]
CREATE DATABASE d1;
CREATE DATABASE d2;
CREATE TABLE d1.t1 (a int unique) ENGINE=INNODB;
CREATE TABLE d2.t1 (a int unique) ENGINE=INNODB;
include/sync_replica_sql_with_primary.inc
BEGIN;
INSERT INTO d1.t1 VALUES (13);
[connection primary]
INSERT INTO d1.t1 VALUES (6);
INSERT INTO d2.t1 VALUES (7);
BEGIN;
INSERT INTO d1.t1 VALUES (13);
BEGIN;
INSERT INTO d2.t1 VALUES (8);
COMMIT;
COMMIT;
INSERT INTO d2.t1 VALUES (9);
[connection replica1]
[connection replica]
COMMIT;
include/wait_for_replica_sql_error.inc [errno=1062]
include/stop_replica_io.inc
[connection primary]
FLUSH LOGS;
[connection replica]
CHANGE PRIMARY TO PRIMARY_HOST= '127.0.0.1', PRIMARY_PORT= PRIMARY_PORT, PRIMARY_USER= 'root',PRIMARY_LOG_FILE = 'FILE', PRIMARY_LOG_POS = POS ;
ERROR HY000: CHANGE PRIMARY cannot be executed when the replica was stopped with an error or killed in MTS mode. Consider using RESET REPLICA or START REPLICA UNTIL.
reset replica;
CHANGE PRIMARY TO PRIMARY_HOST= '127.0.0.1', PRIMARY_PORT= PRIMARY_PORT, PRIMARY_USER= 'root',PRIMARY_LOG_FILE = 'FILE', PRIMARY_LOG_POS = POS ;
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
SET @@global.replica_parallel_workers= @save.replica_parallel_workers;
SET @@global.relay_log_info_repository= @save.relay_log_info_repository;
include/start_replica.inc
[connection primary]
DROP DATABASE d1;
DROP DATABASE d2;
include/rpl_end.inc
