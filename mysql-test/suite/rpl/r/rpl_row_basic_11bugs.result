include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
CREATE DATABASE test_ignore;
**** On Primary ****
SHOW DATABASES;
Database
information_schema
mtr
mysql
performance_schema
sys
test
test_ignore
USE test;
CREATE TABLE t1 (a INT, b INT);
SHOW TABLES;
Tables_in_test
t1
INSERT INTO t1 VALUES (1,1), (2,2);
USE test_ignore;
CREATE TABLE t2 (a INT, b INT);
SHOW TABLES;
Tables_in_test_ignore
t2
INSERT INTO t2 VALUES (3,3), (4,4);
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
primary-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t1 (a INT, b INT)
primary-bin.000001	#	Query	#	#	BEGIN
primary-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
primary-bin.000001	#	Write_rows	#	#	table_id: # flags: STMT_END_F
primary-bin.000001	#	Query	#	#	COMMIT
include/sync_replica_sql_with_primary.inc
**** On Replica ****
SHOW DATABASES;
Database
information_schema
mtr
mysql
performance_schema
sys
test
USE test;
SHOW TABLES;
Tables_in_test
t1
USE test_ignore;
ERROR 42000: Unknown database 'test_ignore'
DROP DATABASE test_ignore;
USE test;
DROP TABLE t1;
include/sync_replica_sql_with_primary.inc
USE test;
include/rpl_reset.inc
CREATE TABLE t1 (a INT);
DELETE FROM t1;
INSERT INTO t1 VALUES (1),(2);
DELETE FROM t1 WHERE a = 0;
UPDATE t1 SET a=99 WHERE a = 0;
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
primary-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t1 (a INT)
primary-bin.000001	#	Query	#	#	BEGIN
primary-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
primary-bin.000001	#	Write_rows	#	#	table_id: # flags: STMT_END_F
primary-bin.000001	#	Query	#	#	COMMIT
DROP TABLE t1;
================ Test for BUG#17620 ================
include/rpl_reset.inc
**** On Replica **** 
SET GLOBAL QUERY_CACHE_SIZE=0;
call mtr.add_suppression("Replica SQL.*Could not execute Update_rows event on table test.t1.* Error_code: 1032");
**** On Primary **** 
CREATE TABLE t1 (a INT);
INSERT INTO t1 VALUES (1),(2),(3);
**** On Replica **** 
include/sync_replica_sql_with_primary.inc
SET GLOBAL QUERY_CACHE_SIZE=16*1024*1024;
**** On Primary **** 
INSERT INTO t1 VALUES (4),(5),(6);
**** On Replica **** 
include/sync_replica_sql_with_primary.inc
SELECT * FROM t1;
a
1
2
3
4
5
6
**** On Primary **** 
INSERT INTO t1 VALUES (7),(8),(9);
**** On Replica **** 
include/sync_replica_sql_with_primary.inc
SELECT * FROM t1;
a
1
2
3
4
5
6
7
8
9
SET GLOBAL QUERY_CACHE_SIZE=DEFAULT;
DROP TABLE t1;
================ Test for BUG#22550 ================
include/rpl_reset.inc
CREATE TABLE t1 (a BIT(1), b INT) ENGINE=MYISAM;
include/sync_replica_sql_with_primary.inc
INSERT INTO t1 VALUES(1,2);
SELECT HEX(a),b FROM t1;
HEX(a)	b
1	2
include/sync_replica_sql_with_primary.inc
SELECT HEX(a),b FROM t1;
HEX(a)	b
1	2
UPDATE t1 SET a=0 WHERE b=2;
SELECT HEX(a),b FROM t1;
HEX(a)	b
0	2
include/sync_replica_sql_with_primary.inc
SELECT HEX(a),b FROM t1;
HEX(a)	b
0	2
DROP TABLE IF EXISTS t1;
include/sync_replica_sql_with_primary.inc
================ Test for BUG#22583 ================
include/rpl_reset.inc
**** On Primary **** 
CREATE TABLE t1_myisam (k INT, a BIT(1), b BIT(9)) ENGINE=MYISAM;
CREATE TABLE t1_innodb (k INT, a BIT(1), b BIT(9)) ENGINE=INNODB;
CREATE TABLE t2_myisam (k INT, a BIT(1) NOT NULL, b BIT(4) NOT NULL) ENGINE=MYISAM;
CREATE TABLE t2_innodb (k INT, a BIT(1) NOT NULL, b BIT(4) NOT NULL) ENGINE=INNODB;
**** On Replica **** 
include/sync_replica_sql_with_primary.inc
ALTER TABLE t1_myisam ENGINE=INNODB;
ALTER TABLE t1_innodb ENGINE=MYISAM;
ALTER TABLE t2_myisam ENGINE=INNODB;
ALTER TABLE t2_innodb ENGINE=MYISAM;
**** On Primary **** 
INSERT INTO t1_myisam VALUES(1, b'0', 257);
INSERT INTO t1_myisam VALUES(2, b'1', 256);
INSERT INTO t1_innodb VALUES(1, b'0', 257);
INSERT INTO t1_innodb VALUES(2, b'1', 256);
SELECT k, HEX(a),HEX(b) FROM t1_myisam;
k	HEX(a)	HEX(b)
1	0	101
2	1	100
SELECT k, HEX(a),HEX(b) FROM t1_innodb;
k	HEX(a)	HEX(b)
1	0	101
2	1	100
INSERT INTO t2_myisam VALUES(1, b'0', 9);
INSERT INTO t2_myisam VALUES(2, b'1', 8);
INSERT INTO t2_innodb VALUES(1, b'0', 9);
INSERT INTO t2_innodb VALUES(2, b'1', 8);
SELECT k, HEX(a),HEX(b) FROM t2_myisam;
k	HEX(a)	HEX(b)
1	0	9
2	1	8
SELECT k, HEX(a),HEX(b) FROM t2_innodb;
k	HEX(a)	HEX(b)
1	0	9
2	1	8
**** On Replica **** 
include/sync_replica_sql_with_primary.inc
SELECT k, HEX(a),HEX(b) FROM t1_myisam;
k	HEX(a)	HEX(b)
1	0	101
2	1	100
SELECT k, HEX(a),HEX(b) FROM t1_innodb;
k	HEX(a)	HEX(b)
1	0	101
2	1	100
SELECT k, HEX(a),HEX(b) FROM t2_myisam;
k	HEX(a)	HEX(b)
1	0	9
2	1	8
SELECT k, HEX(a),HEX(b) FROM t2_innodb;
k	HEX(a)	HEX(b)
1	0	9
2	1	8
**** On Primary **** 
UPDATE t1_myisam SET a=0 WHERE k=2;
SELECT k, HEX(a),HEX(b) FROM t1_myisam;
k	HEX(a)	HEX(b)
1	0	101
2	0	100
UPDATE t1_innodb SET a=0 WHERE k=2;
SELECT k, HEX(a),HEX(b) FROM t1_innodb;
k	HEX(a)	HEX(b)
1	0	101
2	0	100
UPDATE t2_myisam SET a=0 WHERE k=2;
SELECT k, HEX(a),HEX(b) FROM t2_myisam;
k	HEX(a)	HEX(b)
1	0	9
2	0	8
UPDATE t2_innodb SET a=0 WHERE k=2;
SELECT k, HEX(a),HEX(b) FROM t2_innodb;
k	HEX(a)	HEX(b)
1	0	9
2	0	8
**** On Replica **** 
include/sync_replica_sql_with_primary.inc
SELECT k, HEX(a),HEX(b) FROM t1_myisam;
k	HEX(a)	HEX(b)
1	0	101
2	0	100
SELECT k, HEX(a),HEX(b) FROM t1_innodb;
k	HEX(a)	HEX(b)
1	0	101
2	0	100
SELECT k, HEX(a),HEX(b) FROM t2_myisam;
k	HEX(a)	HEX(b)
1	0	9
2	0	8
SELECT k, HEX(a),HEX(b) FROM t2_innodb;
k	HEX(a)	HEX(b)
1	0	9
2	0	8
**** On Primary **** 
DROP TABLE IF EXISTS t1_myisam, t1_innodb, t2_myisam, t2_innodb;
include/sync_replica_sql_with_primary.inc
drop table if exists t1, t2;
CREATE TABLE `t1` (
`a` int(11) NOT NULL auto_increment,
`b` int(11) default NULL,
PRIMARY KEY  (`a`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 ;
CREATE TABLE `t2` (
`a` int(11) NOT NULL auto_increment,
`b` int(11) default NULL,
PRIMARY KEY  (`a`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1 ;
insert into t1 values (1,1),(2,2);
insert into t2 values (1,1),(4,4);
UPDATE t2,t1 SET t2.a=t1.a+2;
ERROR 23000: Duplicate entry '3' for key 'PRIMARY'
select * from t2 /* must be (3,1), (4,4) */;
a	b
3	1
4	4
include/sync_replica_sql_with_primary.inc
select * from t2 /* must be (3,1), (4,4) */;
a	b
3	1
4	4
drop table t1,t2;
include/sync_replica_sql_with_primary.inc
include/rpl_reset.inc
**** On Primary ****
CREATE TABLE t1 (a INT PRIMARY KEY, b SET('primary','replica'));
INSERT INTO t1 VALUES (1,'primary,replica'), (2,'primary,replica');
**** On Replica ****
include/sync_replica_sql_with_primary.inc
UPDATE t1 SET a = 5, b = 'replica' WHERE a = 1;
SELECT * FROM t1 ORDER BY a;
a	b
2	primary,replica
5	replica
set @@global.replica_exec_mode= 'IDEMPOTENT';
**** On Primary ****
UPDATE t1 SET a = 5, b = 'primary' WHERE a = 1;
SELECT * FROM t1 ORDER BY a;
a	b
2	primary,replica
5	primary
**** On Replica ****
include/sync_replica_sql_with_primary.inc
set @@global.replica_exec_mode= default;
Last_SQL_Error

SELECT * FROM t1 ORDER BY a;
a	b
2	primary,replica
5	replica
**** On Primary ****
DROP TABLE t1;
include/rpl_end.inc
