include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
include/sync_replica_sql_with_primary.inc
#
# Uninstall semi-sync plugins on primary and replica
#
include/stop_replica.inc
UNINSTALL PLUGIN rpl_semi_sync_replica;
UNINSTALL PLUGIN rpl_semi_sync_primary;
UNINSTALL PLUGIN rpl_semi_sync_replica;
UNINSTALL PLUGIN rpl_semi_sync_primary;
include/rpl_reset.inc
#
# Main test of semi-sync replication start here
#
[ on primary ]
[ default state of semi-sync on primary should be OFF ]
show variables like 'rpl_semi_sync_primary_enabled';
Variable_name	Value
rpl_semi_sync_primary_enabled	OFF
[ enable semi-sync on primary ]
set global rpl_semi_sync_primary_enabled = 1;
show variables like 'rpl_semi_sync_primary_enabled';
Variable_name	Value
rpl_semi_sync_primary_enabled	ON
[ status of semi-sync on primary should be ON even without any semi-sync replicas ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	0
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	0
#
# BUG#45672 Semisync repl: ActiveTranx:insert_tranx_node: transaction node allocation failed
# BUG#45673 Semisynch reports correct operation even if no replica is connected
#
[ status of semi-sync on primary should be OFF ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	0
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	OFF
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	0
include/rpl_reset.inc
#
# INSTALL PLUGIN semi-sync on replica
#
[ on replica ]
[ default state of semi-sync on replica should be OFF ]
show variables like 'rpl_semi_sync_replica_enabled';
Variable_name	Value
rpl_semi_sync_replica_enabled	OFF
[ enable semi-sync on replica ]
set global rpl_semi_sync_replica_enabled = 1;
show variables like 'rpl_semi_sync_replica_enabled';
Variable_name	Value
rpl_semi_sync_replica_enabled	ON
include/start_replica.inc
[ on primary ]
[ initial primary state after the semi-sync replica connected ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	1
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	0
create table t1(a int) engine = ENGINE_TYPE;
[ primary state after CREATE TABLE statement ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	1
select CONNECTIONS_NORMAL_REPLICA - CONNECTIONS_NORMAL_REPLICA as 'Should be 0';
Should be 0
0
[ insert records to table ]
[ primary status after inserts ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	11
include/sync_replica_sql_with_primary.inc
[ on replica ]
[ replica status after replicated inserts ]
show status like 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	ON
select count(distinct a) from t1;
count(distinct a)
10
select min(a) from t1;
min(a)
1
select max(a) from t1;
max(a)
10

# BUG#50157
# semi-sync replication crashes when replicating a transaction which
# include 'CREATE TEMPORARY TABLE `MyISAM_t` SELECT * FROM `Innodb_t` ;
[ on primary ]
SET SESSION AUTOCOMMIT= 0;
CREATE TABLE t2(c1 INT) ENGINE=innodb;
include/sync_replica_sql_with_primary.inc
BEGIN;

# Even though it is in a transaction, this statement is binlogged into binlog
# file immediately.
CREATE TEMPORARY TABLE t3 SELECT c1 FROM t2 where 1=1;

# These statements will not be binlogged until the transaction is committed
INSERT INTO t2 VALUES(11);
INSERT INTO t2 VALUES(22);
COMMIT;
DROP TABLE t2, t3;
SET SESSION AUTOCOMMIT= 1;
include/sync_replica_sql_with_primary.inc
#
# Test semi-sync primary will switch OFF after one transaction
# timeout waiting for replica reply.
#
include/stop_replica.inc
[ on primary ]
[ primary status should be ON ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	15
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	1
[ semi-sync replication of these transactions will fail ]
insert into t1 values (500);
[ primary status should be OFF ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	OFF
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	1
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	15
insert into t1 values (100);
[ primary status should be OFF ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	OFF
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	12
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	15
#
# Test semi-sync status on primary will be ON again when replica catches up
#
[ on replica ]
[ replica status should be OFF ]
show status like 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	OFF
include/start_replica.inc
[ replica status should be ON ]
show status like 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	ON
select count(distinct a) from t1;
count(distinct a)
2
select min(a) from t1;
min(a)
100
select max(a) from t1;
max(a)
500
[ on primary ]
[ primary status should be ON again after replica catches up ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	12
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	15
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	1
#
# Test disable/enable primary semi-sync on the fly.
#
drop table t1;
include/sync_replica_sql_with_primary.inc
[ on replica ]
include/stop_replica.inc
#
# Flush status
#
[ Semi-sync primary status variables before FLUSH STATUS ]
SHOW STATUS LIKE 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	12
SHOW STATUS LIKE 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	16
FLUSH NO_WRITE_TO_BINLOG STATUS;
[ Semi-sync primary status variables after FLUSH STATUS ]
SHOW STATUS LIKE 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
SHOW STATUS LIKE 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	0
[ on primary ]
show primary logs;
Log_name	primary-bin.000001
File_size	#
show variables like 'rpl_semi_sync_primary_enabled';
Variable_name	Value
rpl_semi_sync_primary_enabled	ON
[ disable semi-sync on the fly ]
set global rpl_semi_sync_primary_enabled=0;
show variables like 'rpl_semi_sync_primary_enabled';
Variable_name	Value
rpl_semi_sync_primary_enabled	OFF
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	OFF
[ enable semi-sync on the fly ]
set global rpl_semi_sync_primary_enabled=1;
show variables like 'rpl_semi_sync_primary_enabled';
Variable_name	Value
rpl_semi_sync_primary_enabled	ON
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
#
# Test RESET PRIMARY/REPLICA
#
[ on replica ]
include/start_replica.inc
[ on primary ]
create table t1 (a int) engine = ENGINE_TYPE;
drop table t1;
include/sync_replica_sql_with_primary.inc
show status like 'Rpl_relay%';
Variable_name	Value
[ test reset primary ]
[ on primary]
reset primary;
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	0
[ on replica ]
include/stop_replica.inc
reset replica;
reset primary;
include/start_replica.inc
[ on primary ]
create table t1 (a int) engine = ENGINE_TYPE;
insert into t1 values (1);
insert into t1 values (2), (3);
include/sync_replica_sql_with_primary.inc
[ on replica ]
select * from t1;
a
1
2
3
[ on primary ]
[ primary semi-sync status should be ON ]
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	3
#
# Start semi-sync replication without SUPER privilege
#
include/rpl_reset.inc
set sql_log_bin=0;
grant replication replica on *.* to rpl@127.0.0.1 identified by 'rpl';
Warnings:
Warning	1287	Using GRANT for creating new user is deprecated and will be removed in future release. Create new user with CREATE USER statement.
flush privileges;
set sql_log_bin=1;
[ on replica ]
grant replication replica on *.* to rpl@127.0.0.1 identified by 'rpl';
Warnings:
Warning	1287	Using GRANT for creating new user is deprecated and will be removed in future release. Create new user with CREATE USER statement.
flush privileges;
change primary to primary_user='rpl',primary_password='rpl';
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
include/start_replica.inc
show status like 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	ON
[ on primary ]
[ primary semi-sync should be ON ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	1
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	0
insert into t1 values (4);
insert into t1 values (5);
[ primary semi-sync should be ON ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	1
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
show status like 'Rpl_semi_sync_primary_no_tx';
Variable_name	Value
Rpl_semi_sync_primary_no_tx	0
show status like 'Rpl_semi_sync_primary_yes_tx';
Variable_name	Value
Rpl_semi_sync_primary_yes_tx	2
#
# Test semi-sync replica connect to non-semi-sync primary
#
include/sync_replica_sql_with_primary.inc
[ on replica ]
include/stop_replica.inc
SHOW STATUS LIKE 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	OFF
[ on primary ]
[ Semi-sync status on primary should be ON ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	0
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	ON
set global rpl_semi_sync_primary_enabled= 0;
[ on replica ]
SHOW VARIABLES LIKE 'rpl_semi_sync_replica_enabled';
Variable_name	Value
rpl_semi_sync_replica_enabled	ON
include/start_replica.inc
[ on primary ]
insert into t1 values (8);
[ primary semi-sync clients should be 1, status should be OFF ]
show status like 'Rpl_semi_sync_primary_clients';
Variable_name	Value
Rpl_semi_sync_primary_clients	1
show status like 'Rpl_semi_sync_primary_status';
Variable_name	Value
Rpl_semi_sync_primary_status	OFF
include/sync_replica_sql_with_primary.inc
[ on replica ]
show status like 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	ON
include/stop_replica.inc
[ on primary ]
include/stop_dump_threads.inc
UNINSTALL PLUGIN rpl_semi_sync_primary;
SHOW VARIABLES LIKE 'rpl_semi_sync_primary_enabled';
Variable_name	Value
[ on replica ]
SHOW VARIABLES LIKE 'rpl_semi_sync_replica_enabled';
Variable_name	Value
rpl_semi_sync_replica_enabled	ON
include/start_replica.inc
[ on primary ]
insert into t1 values (10);
include/sync_replica_sql_with_primary.inc
[ on replica ]
SHOW STATUS LIKE 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	OFF
#
# Test non-semi-sync replica connect to semi-sync primary
#
INSTALL PLUGIN rpl_semi_sync_primary SONAME 'SEMISYNC_PRIMARY_PLUGIN';
set global rpl_semi_sync_primary_timeout= 60000;
/* 60s */
set global rpl_semi_sync_primary_enabled= 1;
[ on replica ]
include/stop_replica.inc
SHOW STATUS LIKE 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	OFF
[ uninstall semi-sync replica plugin ]
UNINSTALL PLUGIN rpl_semi_sync_replica;
SHOW VARIABLES LIKE 'rpl_semi_sync_replica_enabled';
Variable_name	Value
include/start_replica.inc
SHOW STATUS LIKE 'Rpl_semi_sync_replica_status';
Variable_name	Value
include/stop_replica.inc
[ reinstall semi-sync replica plugin and disable semi-sync ]
INSTALL PLUGIN rpl_semi_sync_replica SONAME 'SEMISYNC_REPLICA_PLUGIN';
set global rpl_semi_sync_replica_enabled= 0;
SHOW VARIABLES LIKE 'rpl_semi_sync_replica_enabled';
Variable_name	Value
rpl_semi_sync_replica_enabled	OFF
SHOW STATUS LIKE 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	OFF
include/start_replica.inc
SHOW STATUS LIKE 'Rpl_semi_sync_replica_status';
Variable_name	Value
Rpl_semi_sync_replica_status	OFF
#
# Clean up
#
include/uninstall_semisync.inc
include/stop_replica.inc
change primary to primary_user='root',primary_password='';
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
include/start_replica.inc
drop table t1;
include/sync_replica_sql_with_primary.inc
drop user rpl@127.0.0.1;
flush privileges;
include/rpl_end.inc
