include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
==== Initialize ====
[on primary]
CREATE TABLE t1(a INT PRIMARY KEY);
[on replica]
include/sync_replica_sql_with_primary.inc
==== Test: SQL thread sees 'INSERT' of existing key ====
---- Prepare replica so that it will get duplicate key error ----
INSERT INTO t1 VALUES (1);
---- Insert rows on primary ----
[on primary]
INSERT INTO t1 VALUES (1);
SELECT * FROM t1;
a
1
[on replica]
---- Wait until replica stops with an error ----
include/wait_for_replica_sql_error.inc [errno=1062]
SELECT "1062" as 'Last_SQL_Errno';
Last_SQL_Errno
1062
call mtr.add_suppression("Replica SQL.*Duplicate entry .1. for key .PRIMARY.* Error_code: 1062");
call mtr.add_suppression("The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state");
SELECT * FROM t1;
a
1
---- Resolve the conflict on the replica and restart SQL thread ----
DELETE FROM t1 WHERE a = 1;
START REPLICA SQL_THREAD;
include/wait_for_replica_sql_to_start.inc
---- Sync replica and verify that there is no error ----
include/check_replica_no_error.inc
SELECT * FROM t1;
a
1
==== Test: SQL thread sees 'DELETE' of non-existing row ====
---- On primary, insert two rows, the second with binlogging off ----
[on primary]
DELETE FROM t1;
INSERT INTO t1 VALUES (1);
[on replica]
include/sync_replica_sql_with_primary.inc
DELETE FROM t1 WHERE a = 1;
---- On primary, remove the row that does not exist on replica ----
[on primary]
DELETE FROM t1 WHERE a = 1;
SELECT * FROM t1;
a
[on replica]
---- Sync replica and verify that there is no error ----
include/check_replica_no_error.inc
SELECT * FROM t1;
a
==== Clean up ====
[on primary]
DROP TABLE t1;
[on replica]
include/sync_replica_sql_with_primary.inc
include/rpl_end.inc
