include/primary-replica.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the primary info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection primary]
==== Initialize ====
[on primary]
CREATE TABLE t1 (a CHAR(48));
CREATE TEMPORARY TABLE t1_tmp1(a INT);
INSERT INTO t1 VALUES (UUID());
[on replica]
include/sync_replica_sql_with_primary.inc
==== Verify results on replica ====
SHOW STATUS LIKE "Replica_open_temp_tables";
Variable_name	Value
Replica_open_temp_tables	1
[on primary]
[on primary1]
[on replica]
include/sync_replica_sql_with_primary.inc
==== Verify results on replica ====
SHOW STATUS LIKE "Replica_open_temp_tables";
Variable_name	Value
Replica_open_temp_tables	0
==== Clean up ====
[on primary]
include/rpl_connect.inc [creating primary]
DROP TABLE t1;
[on replica]
include/sync_replica_sql_with_primary.inc
include/rpl_reset.inc
CREATE TABLE t1 (a int);
CREATE TABLE t2 ( i1 INT NOT NULL AUTO_INCREMENT, PRIMARY KEY (i1) );
CREATE TABLE t3 ( i1 INT NOT NULL AUTO_INCREMENT, PRIMARY KEY (i1) );
CREATE TRIGGER tr1 AFTER DELETE ON t2 FOR EACH ROW INSERT INTO t3 () VALUES ();
CREATE TEMPORARY TABLE t1_tmp (i1 int);
ALTER TABLE t1_tmp ADD COLUMN b INT;
DELETE FROM t2;
CREATE TEMPORARY TABLE t2_tmp (a int);
ALTER TABLE t1_tmp ADD COLUMN c INT;
### assertion: assert that there is one open temp table on replica
include/sync_replica_sql_with_primary.inc
SHOW STATUS LIKE 'Replica_open_temp_tables';
Variable_name	Value
Replica_open_temp_tables	1
DROP TABLE t1_tmp, t2;
INSERT INTO t1 VALUES (1);
DROP TEMPORARY TABLE t2_tmp;
INSERT INTO t1 VALUES (2);
include/sync_replica_sql_with_primary.inc
### assertion: assert that replica has no temporary tables opened
SHOW STATUS LIKE 'Replica_open_temp_tables';
Variable_name	Value
Replica_open_temp_tables	0
DROP TABLE t3, t1;
include/sync_replica_sql_with_primary.inc
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
replica-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t1 (a int)
replica-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t2 ( i1 INT NOT NULL AUTO_INCREMENT, PRIMARY KEY (i1) )
replica-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t3 ( i1 INT NOT NULL AUTO_INCREMENT, PRIMARY KEY (i1) )
replica-bin.000001	#	Query	#	#	use `test`; CREATE DEFINER=`root`@`localhost` TRIGGER tr1 AFTER DELETE ON t2 FOR EACH ROW INSERT INTO t3 () VALUES ()
replica-bin.000001	#	Query	#	#	use `test`; CREATE TEMPORARY TABLE t1_tmp (i1 int)
replica-bin.000001	#	Query	#	#	use `test`; ALTER TABLE t1_tmp ADD COLUMN b INT
replica-bin.000001	#	Query	#	#	DROP TEMPORARY TABLE IF EXISTS `test`.`t1_tmp` /* generated by server */
replica-bin.000001	#	Query	#	#	use `test`; DROP TABLE `t2` /* generated by server */
replica-bin.000001	#	Query	#	#	BEGIN
replica-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
replica-bin.000001	#	Write_rows	#	#	table_id: # flags: STMT_END_F
replica-bin.000001	#	Xid	#	#	COMMIT /* XID */
replica-bin.000001	#	Query	#	#	DROP TEMPORARY TABLE IF EXISTS `test`.`t2_tmp` /* generated by server */
replica-bin.000001	#	Query	#	#	BEGIN
replica-bin.000001	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (2)
replica-bin.000001	#	Xid	#	#	COMMIT /* XID */
replica-bin.000001	#	Query	#	#	use `test`; DROP TABLE `t3`,`t1` /* generated by server */

# Bug#55478 Row events wrongly apply on the temporary table of the same name
# ==========================================================================
# The statement should be binlogged
CREATE TEMPORARY TABLE t1(c1 INT) ENGINE=InnoDB;

# Case 1: CREATE TABLE t1 ... SELECT
# ----------------------------------

# The statement generates row events on t1. And the rows events should
# be inserted into the base table on replica.
CREATE TABLE t1 ENGINE=MyISAM SELECT rand();
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
primary-bin.000001	#	Query	#	#	use `test`; CREATE TABLE `t1` (
  `rand()` double NOT NULL DEFAULT '0'
) ENGINE=MyISAM
primary-bin.000001	#	Query	#	#	BEGIN
primary-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
primary-bin.000001	#	Write_rows	#	#	table_id: # flags: STMT_END_F
primary-bin.000001	#	Query	#	#	COMMIT

# Case 2: DROP TEMPORARY TABLE in a transacation
# ----------------------------------------------

BEGIN;
DROP TEMPORARY TABLE t1;
# The rows event will binlogged before 'DROP TEMPORARY TABLE t1',
# as t1 is non-transactional table
INSERT INTO t1 VALUES(Rand());
COMMIT;
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
primary-bin.000001	#	Query	#	#	BEGIN
primary-bin.000001	#	Table_map	#	#	table_id: # (test.t1)
primary-bin.000001	#	Write_rows	#	#	table_id: # flags: STMT_END_F
primary-bin.000001	#	Query	#	#	COMMIT
primary-bin.000001	#	Query	#	#	BEGIN
primary-bin.000001	#	Query	#	#	DROP TEMPORARY TABLE IF EXISTS `test`.`t1` /* generated by server */
primary-bin.000001	#	Query	#	#	COMMIT
include/sync_replica_sql_with_primary.inc
# Compare the base table.
include/diff_tables.inc [primary:t1, replica:t1]

DROP TABLE t1;
include/sync_replica_sql_with_primary.inc
include/rpl_end.inc
