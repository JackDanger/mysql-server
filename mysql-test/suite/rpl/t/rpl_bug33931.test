# Test for 
# Bug #33931  	assertion at write_ignored_events_info_to_relay_log if init_replica_thread() fails
# Bug #33932  	assertion at handle_replica_sql if init_replica_thread() fails

--source include/not_group_replication_plugin.inc
source include/have_debug.inc;
source include/primary-replica.inc;

connection replica;

# Add suppression for expected warnings in replicas error log
call mtr.add_suppression("Failed during replica I/O thread initialization");
call mtr.add_suppression("Replica SQL.*Failed during replica thread initialization.* 1593");

--source include/stop_replica.inc
reset replica;

# Set debug flags on replica to force errors to occur
SET GLOBAL debug="d,simulate_io_replica_error_on_init,simulate_sql_replica_error_on_init";

--disable_query_log
--replace_regex /[0-9]{4}/####/
eval CHANGE PRIMARY TO PRIMARY_USER='root',
                      PRIMARY_CONNECT_RETRY=1,
                      PRIMARY_HOST='127.0.0.1',
                      PRIMARY_PORT=$PRIMARY_MYPORT;
--enable_query_log

start replica;

#
# replica is going to stop because of emulated failures
# but there won't be any crashes nor asserts hit.
#

# 1593 = ER_REPLICA_FATAL_ERROR 
--let $replica_sql_errno= 1593
--let $show_replica_sql_error= 1
--source include/wait_for_replica_sql_error.inc

#
# Cleanup
#
SET GLOBAL debug="";

# Clear Last_SQL_Error
RESET REPLICA;

--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
