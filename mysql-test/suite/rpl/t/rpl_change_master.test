# ==== Purpose ====
#
# This test calls CHANGE PRIMARY in order to check if replication can
# restart from where SQL thread left, not from where I/O thread left.
#
# This file tests the case when primary_info is stored in a file.
#
# ==== See also ====
#
# rpl_change_primary_crash_safe.test

--source include/no_valgrind_without_big.inc
--source include/not_gtid_enabled.inc
--source include/not_group_replication_plugin.inc
--source include/have_binlog_format_mixed.inc
--source include/primary-replica.inc
--source extra/rpl_tests/rpl_change_primary.test


# BUG#11758581 - 50801: CHANGE PRIMARY ACCEPTS BOGUS VARIABLES
# We want to check if CHANGE PRIMARY values have newline characters.
--source include/rpl_reset.inc
connection replica;

###
### This should fail with error ER_WRONG_ARGUMENTS due to empty PRIMARY_HOST
### value.
###
--source include/stop_replica.inc
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_WRONG_ARGUMENTS
eval CHANGE PRIMARY TO PRIMARY_USER='root', PRIMARY_HOST='', PRIMARY_PORT=$PRIMARY_MYPORT;

###
### This should fail with error ER_SYNTAX_ERROR due to newline
### in string values.
###
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_WRONG_VALUE
eval CHANGE PRIMARY TO PRIMARY_USER='root', PRIMARY_HOST='127.0.0.1\n127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT;

--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_WRONG_VALUE
eval CHANGE PRIMARY TO PRIMARY_USER='root\n', PRIMARY_HOST='primary2.mycompany.com', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='replication', PRIMARY_PASSWORD='bigs3cret', PRIMARY_LOG_FILE='primary2-bin.001', PRIMARY_LOG_POS=4;

--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_WRONG_VALUE
eval CHANGE PRIMARY TO PRIMARY_USER='root', PRIMARY_HOST='primary2.mycompany.com', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='repli\ncation', PRIMARY_PASSWORD='bigs3cret', PRIMARY_LOG_FILE='primary2-bin.001', PRIMARY_LOG_POS=4;

--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_WRONG_VALUE
eval CHANGE PRIMARY TO PRIMARY_USER='root', PRIMARY_HOST='primary2.mycompany.com', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='replication', PRIMARY_PASSWORD='bigs3cret', PRIMARY_LOG_FILE='primary2-bin.\n001', PRIMARY_LOG_POS=4;

###
### This should be accepted.
###
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_USER='root', PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT;

--source include/start_replica.inc
--let $status_items= Primary_Host
--source include/show_replica_status.inc
--source include/rpl_reset.inc

#
# Bug #11752299 REPLICATION REPLICA TRUNCATES PRIMARY_PASSWORD > 32 CHARACTERS
#

--let $passwd=012345678901234567890123456789ab
--let assert_cond=CHAR_LENGTH("$passwd") = 32
--let assert_text=Password length is 32
--source include/assert.inc

connection primary;
SET SQL_LOG_BIN=0;
--eval GRANT REPLICATION REPLICA ON *.* TO rpl@127.0.0.1 IDENTIFIED BY '$passwd'
SET SQL_LOG_BIN=1;

connection replica;
--source include/stop_replica.inc

# First, verify that 32 char maximum password works.
--eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', primary_user='rpl', primary_password='$passwd'

--source include/start_replica_io.inc

--let $replica_param= Replica_IO_Running
--let $replica_param_value= Yes
--source include/check_replica_param.inc

# Now, prove 1 char oversized password is rejected
--error ER_CHANGE_PRIMARY_PASSWORD_LENGTH
--eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', primary_user='rpl', primary_password='x$passwd'

# Cleanup Bug #11752299

connection primary;
SET SQL_LOG_BIN=0;
DROP USER rpl@127.0.0.1;
FLUSH PRIVILEGES;
SET SQL_LOG_BIN=1;

connection replica;
--source include/stop_replica_io.inc
CHANGE PRIMARY TO PRIMARY_USER = 'root', PRIMARY_PASSWORD = '';
--source include/start_replica.inc

--source include/rpl_end.inc
