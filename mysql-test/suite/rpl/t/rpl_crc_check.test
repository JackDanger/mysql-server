# ==== Purpose ====
#
# Bug #20644100  "Event crc check failed" when primary disable binlog_checksum
#
# Starting replica sql_thread to apply events will cause event crc check
# failure when primary disables binlog_checksum.
#
# Currently relay logs have the following sequence (starting from
# position 4):
# Format_desc (of replica)
# Previous-GTIDs (of replica)
# Rotate (of primary)
# Format_desc (of primary)
# The Format_desc which really describes the rest of the relay
# log is the 4rd event, which is from primary.
# Relay_log_info::init_relay_log_pos(...) will look for a
# Format_description_log_event from primary. We only need this when
# replica applier thread starts and opens an existing relay log and
# has to execute it (possibly from an offset >4), because we need
# to read the description event of the relay log to be able to
# parse the events we have to execute.
# But the current code supposed that relay logs have the following
# sequence (starting from position 4):
# Format_desc (of replica)
# Rotate (of primary)
# Format_desc (of primary)
# So the function failed to find the Format_description_log_event
# from primary when replica applier thread starts and opens an existing
# relay log and has to execute it, which causes some failures.
# The event crc check failure is one of them.
#
# Fix code to let replica applier thread also skip the Previous-GTIDs
# log event to find the correct Format_description_log_event from
# primary when it is starting and opening an existing relay log.
#
# Steps to reproduce:
# 1) Start primary and replica servers
# 2) Stop replica applier thread.
# 3) Write an event into binary log on primary
#    when primary disables binlog_checksum.
# 4) Start replica applier thread to verify that
#    their is no event crc check failure.
#

--source include/not_group_replication_plugin.inc
# Test in this file is binlog format agnostic, thus no need
# to rerun them for every format.
--source include/have_binlog_format_row.inc
--source include/primary-replica.inc

--source include/rpl_connection_replica.inc
--source include/stop_replica_sql.inc

--source include/rpl_connection_primary.inc
CREATE TABLE t1 (c1 INT);

--echo #
--echo # Start replica applier thread to verify that
--echo # their is no event crc check failure.
--echo #
--source include/rpl_connection_replica.inc
--source include/start_replica_sql.inc

--source include/rpl_connection_primary.inc
DROP TABLE t1;

--source include/rpl_end.inc
