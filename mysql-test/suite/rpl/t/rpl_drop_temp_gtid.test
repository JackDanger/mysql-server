# ==== Purpose ====
#
# Verify if the temporary tables will still be present on the replica after
# restarting only the IO thread when using the GTID AUTO_POSITION protocol.
#
# ==== Related Bugs and Worklogs ====
#
# Bug#18472603 SQL THREAD COMMITS PARTIAL TRANSACTION WITH GTID AND AUTO
#              POSITIONING ENABLED
#
--source include/have_binlog_format_statement.inc
--source include/have_innodb.inc
--source include/have_gtid.inc
--let $use_gtids= 1
--source include/primary-replica.inc

--echo # Initial setup
--source include/rpl_connection_primary.inc
CREATE TABLE t1 (c1 INT) ENGINE=InnoDB;
CREATE TEMPORARY TABLE temp_t1 (c1 INT) ENGINE=InnoDB;

--echo # Insert the data in the primary
BEGIN;
INSERT INTO temp_t1 VALUES (1);
COMMIT;

BEGIN;
INSERT INTO t1 VALUES ((SELECT COUNT(*) FROM temp_t1));
COMMIT;
--source include/sync_replica_sql_with_primary.inc

--source include/rpl_connection_replica.inc
--echo # Stop the IO thread
--source include/stop_replica_io.inc
--echo # Restart IO thread
--source include/start_replica_io.inc

--echo # Do one more insert on primary and then sync replica with primary
--source include/rpl_connection_primary.inc
BEGIN;
INSERT INTO t1 VALUES ((SELECT COUNT(*) FROM temp_t1));
COMMIT;
--source include/sync_replica_sql_with_primary.inc

--echo # Now compare primary and replica's t1 table data
--source include/rpl_connection_primary.inc
--let diff_tables= primary:t1, replica:t1
--source include/diff_tables.inc

--echo # Cleanup
--source include/rpl_connection_primary.inc
DROP TABLE t1, temp_t1;
--source include/rpl_end.inc
