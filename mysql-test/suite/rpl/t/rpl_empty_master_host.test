# 
# BUG
# ---
#   BUG#28796: CHANGE PRIMARY TO PRIMARY_HOST="" leads to invalid primary.info
#
# Description
# -----------
#
#   This test aims at: 
#     i) verifying that an error is thrown when setting PRIMARY_HOST=''
#     ii) no error is thrown when setting non empty PRIMARY_HOST
#     iii) replication works after setting a correct host name/ip
#
#   Implementation is performed by feeding different values (according
#   to i), ii) and iii) ) to CHANGE PRIMARY TO PRIMARY_HOST= x and checking
#   along the way if error/no error is thrown and/or if replication starts
#   working when expected.

--source include/primary-replica.inc
--source include/have_binlog_format_mixed.inc

connection replica;
STOP REPLICA;
--source include/wait_for_replica_to_stop.inc

let $primary_host= query_get_value(SHOW REPLICA STATUS, Primary_Host, 1);
--echo Primary_Host = '$primary_host' (expected '127.0.0.1')

# attempt to change to an empty primary host should 
# result in error ER_WRONG_ARGUMENTS: "Incorrect arguments to ..."
error ER_WRONG_ARGUMENTS;
CHANGE PRIMARY TO PRIMARY_HOST="";

# show replica status still holds previous information
let $primary_host= query_get_value(SHOW REPLICA STATUS, Primary_Host, 1);
--echo Primary_Host = '$primary_host' (expected '127.0.0.1')

# changing primary to other than empty primary host succeeds
CHANGE PRIMARY TO PRIMARY_HOST="foo";

# show replica status should hold "foo" as primary host
let $primary_host= query_get_value(SHOW REPLICA STATUS, Primary_Host, 1);
--echo Primary_Host = '$primary_host' (expected 'foo')

# changing back to localhost
CHANGE PRIMARY TO PRIMARY_HOST="127.0.0.1";
let $primary_host= query_get_value(SHOW REPLICA STATUS, Primary_Host, 1);
--echo Primary_Host = '$primary_host' (expected '127.0.0.1')

# start replica must succeed.
START REPLICA;
--source include/wait_for_replica_to_start.inc
--source include/rpl_end.inc
