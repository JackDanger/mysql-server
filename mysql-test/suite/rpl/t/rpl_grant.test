# Tests of grants and users

--source include/not_group_replication_plugin.inc
source include/not_gtid_enabled.inc;
source include/not_embedded.inc;
source include/primary-replica.inc;

--echo **** On Primary ****
connection primary;

CREATE USER dummy@localhost;
CREATE USER dummy1@localhost, dummy2@localhost;

SELECT user, host FROM mysql.user WHERE user like 'dummy%';
SELECT COUNT(*) FROM mysql.user WHERE user like 'dummy%';
--source include/sync_replica_sql_with_primary.inc
--echo **** On Replica ****
SELECT user,host FROM mysql.user WHERE user like 'dummy%';
SELECT COUNT(*) FROM mysql.user WHERE user like 'dummy%';

--echo **** On Primary ****
connection primary;

# No user exists
error ER_CANNOT_USER;
DROP USER nonexisting@localhost;

# At least one user exists, but not all
error ER_CANNOT_USER;
DROP USER nonexisting@localhost, dummy@localhost;

# All users exist
DROP USER dummy1@localhost, dummy2@localhost;

SELECT user, host FROM mysql.user WHERE user like 'dummy%';
SELECT COUNT(*) FROM mysql.user WHERE user like 'dummy%';
--source include/sync_replica_sql_with_primary.inc
--echo **** On Replica ****
SELECT user,host FROM mysql.user WHERE user like 'dummy%';
SELECT COUNT(*) FROM mysql.user WHERE user like 'dummy%';


######################################################

#
# BUG#54866: Partially failed REVOKE not binlogged, causes inconsistency or replication abort
#

--echo ##########
--echo ########## setup (PART I)
--echo ##########
-- source include/rpl_reset.inc
-- connection primary

call mtr.add_suppression("Did not write failed .* into binary log while "
                         "storing routine level grants in the privilege "
                         "tables.");
call mtr.add_suppression("Did not write failed .* into binary log while "
                         "revoking all_privileges from a list of users.");
--let $dbname= b54866
--let $dbuser= b54866_user

--eval CREATE DATABASE $dbname 
--eval use $dbname
CREATE TABLE t1 ( c1 INT, c2 INT, c3 INT );

--echo ##########
--echo ########## GRANT ALL
--echo ##########

## create user, grant and revoke (the last command fails partially)
--eval CREATE USER '$dbuser'@'localhost'
--eval GRANT ALL ON $dbname.* TO '$dbuser'@'localhost'
--error ER_NONEXISTING_GRANT
--eval REVOKE ALL ON $dbname.* FROM '$dbuser'@'localhost', 'b54866_fake_user'

--connection replica
call mtr.add_suppression("Replica SQL.*The incident LOST_EVENTS occured on the primary.*");
--let $replica_sql_errno= convert_error(ER_REPLICA_INCIDENT)
--source include/wait_for_replica_sql_error.inc
# Skip incident event caused by failed REVOKE
SET GLOBAL SQL_REPLICA_SKIP_COUNTER=1;
--source include/start_replica_sql.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc

## assert that grants are the same on primary and on replica for $dbuser
--connection primary
--echo ****** Checking grants on the primary for user: $dbuser ******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--source include/sync_replica_sql_with_primary.inc
--echo ****** Checking grants on the replica for user: $dbuser *******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--echo ##########
--echo ########## TABLE GRANTS
--echo ##########

--connection primary
--eval GRANT ALTER,CREATE,DROP ON TABLE $dbname.t1 TO '$dbuser'@'localhost'
--echo ****** Checking grants on the primary for user: $dbuser ******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--source include/sync_replica_sql_with_primary.inc
--echo ****** Checking grants on the replica for user: $dbuser *******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

## revoke should now fail and log a incident event
--connection primary
--error ER_NONEXISTING_GRANT
--eval REVOKE ALTER ON TABLE $dbname.t1 FROM '$dbuser'@'localhost', 'b54866_fake_user'

## assert that ALTER grant is revoked on replica and replica does not stop
--connection primary
--echo ****** Checking grants on the primary for user: $dbuser ******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--connection replica
--let $replica_sql_errno= convert_error(ER_REPLICA_INCIDENT)
--source include/wait_for_replica_sql_error.inc
# Skip incident event caused by failed REVOKE
SET GLOBAL SQL_REPLICA_SKIP_COUNTER=1;
--source include/start_replica_sql.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc

--echo ****** Checking grants on the replica for user: $dbuser *******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--echo ##########
--echo ########## setup (PART II)
--echo ##########

-- connection primary
DELIMITER |;
CREATE PROCEDURE b54866_p() BEGIN SELECT 1; END|
CREATE FUNCTION b54866_f() RETURNS INT BEGIN RETURN 1; END|
DELIMITER ;|

--eval GRANT EXECUTE ON PROCEDURE $dbname.b54866_p TO '$dbuser'@'localhost'
--eval GRANT EXECUTE ON FUNCTION $dbname.b54866_f TO '$dbuser'@'localhost'

--echo ****** Checking grants on the primary for user: $dbuser ******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--source include/sync_replica_sql_with_primary.inc
--echo ****** Checking grants on the replica for user: $dbuser *******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--echo ##########
--echo ########## PROCEDURE
--echo ##########

-- connection primary

-- echo #### PROCEDURE ASSERTION
--error ER_NONEXISTING_GRANT
--eval REVOKE EXECUTE ON PROCEDURE $dbname.b54866_p FROM '$dbuser'@'localhost', 'b54866_fake_user'

--echo ****** Checking grants on the primary for user: $dbuser ******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--connection replica
--let $replica_sql_errno= convert_error(ER_REPLICA_INCIDENT)
--source include/wait_for_replica_sql_error.inc
# Skip incident event caused by failed REVOKE
SET GLOBAL SQL_REPLICA_SKIP_COUNTER=1;
--source include/start_replica_sql.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc

--echo ****** Checking grants on the replica for user: $dbuser *******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--echo ##########
--echo ########## FUNCTION
--echo ##########
-- connection primary

--error ER_NONEXISTING_GRANT
--eval REVOKE EXECUTE ON FUNCTION $dbname.b54866_f FROM '$dbuser'@'localhost', 'b54866_fake_user'

--connection primary
--echo ****** Checking grants on the primary for user: $dbuser ******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--connection replica
--let $replica_sql_errno= convert_error(ER_REPLICA_INCIDENT)
--source include/wait_for_replica_sql_error.inc
# Skip incident event caused by failed REVOKE
SET GLOBAL SQL_REPLICA_SKIP_COUNTER=1;
--source include/start_replica_sql.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc

--echo ****** Checking grants on the replica for user: $dbuser *******
--eval SHOW GRANTS FOR '$dbuser'@'localhost'
--echo *************************************************************

--echo ##########
--echo ########## empty revokes should not be binlogged
--echo ##########

-- connection primary

## assert that failing revoke on non existing user will not 
## be binlogged
-- error ER_NONEXISTING_GRANT
REVOKE EXECUTE ON PROCEDURE b54866_p FROM 'fake_user'@'localhost';
-- error ER_NONEXISTING_GRANT
REVOKE EXECUTE ON FUNCTION b54866_f FROM 'fake_user'@'localhost';
-- error ER_REVOKE_GRANTS
REVOKE ALL PRIVILEGES, GRANT OPTION FROM 'fake_user'@'localhost';
--source include/sync_replica_sql_with_primary.inc

--echo ##########
--echo ########## Cleanup
--echo ##########
--connection primary
DROP PROCEDURE b54866_p;
DROP FUNCTION b54866_f;
--eval DROP USER '$dbuser'@'localhost'
--eval DROP DATABASE $dbname
--source include/sync_replica_sql_with_primary.inc

#
# BUG#11827392: 60082: EVEN THOUGH IT FAILS, 'CREATE USER' STATEMENT SI STILL BINLOGGED. 
#

#
# The test case is based on the one included in the
# original report. It works as follows:
#
# 1. We issue a failing statement on the primary
# 2. Then we synchronize the replica
#    - this asserts that there is no side-effect
#      on the replication stream
# 3. We then dump the contents of the binlog and
#    search for the CREATE USER entry. There should
#    not be any, so we print the # of entries found.
#

--connection primary
--source include/rpl_reset.inc
--connection primary

--error ER_PLUGIN_IS_NOT_LOADED
CREATE USER foo IDENTIFIED WITH 'my_plugin';
--source include/sync_replica_sql_with_primary.inc

--connection primary

--disable_query_log

--let $MYSQLD_DATADIR= `select @@datadir`
--let $binlog_file= query_get_value(SHOW PRIMARY STATUS, File, 1)
--let $prefix=`SELECT UUID()`
--let $out_file=$MYSQLTEST_VARDIR/tmp/$prefix.out
--exec $MYSQL_BINLOG --verbose $MYSQLD_DATADIR/$binlog_file > $out_file

--let OUTF=$out_file

--enable_query_log

--echo # Search for occurrences of CREATE USER in the output from mysqlbinlog

perl;
  use strict;
  my $outf= $ENV{'OUTF'} or die "OUTF not set";
  open(FILE, "$outf") or die("Unable to open $outf: $!\n");
  my $count = () = grep(/create user 'foo'/gi,<FILE>);
  print "- Occurrences: $count\n";
  close(FILE);
EOF

--remove_file $out_file

--source include/rpl_end.inc
