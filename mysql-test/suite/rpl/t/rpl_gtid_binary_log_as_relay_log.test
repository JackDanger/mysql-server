###############################################################################
# Bug#17812024  MTS IS NOT ABLE TO REPRODUCE BINLOGS AS RELAY LOGS
# Problem: When a binarylog is used as a relaylog (transfer binarylogs to
# Replica machine to avoid I/O thread reading delay), MTS is unable to operate
# on that kind of relaylog.

# Steps to Reproduce:
#  1) Prepare a binary log with some 3 sample GTIDs
#  2) Make that binary log as relay log
#  3) Set replica_parallel_workers to 1 and start worker thread
#  4) Make sure everything is replicated
###############################################################################

--source include/not_group_replication_plugin.inc
--source include/have_gtid.inc
--source include/have_binlog_format_statement.inc
--source include/primary-replica.inc
# Initial setup
--let $MYSQLD_PRIMARY_DATADIR= `select @@datadir`
--connection replica
--let $MYSQLD_REPLICA_DATADIR= `select @@datadir`
--source include/stop_replica_sql.inc

# Step-1: Prepare a binary log with 3 sample GTIDs
--connection primary
CREATE TABLE t1(i INT);
INSERT INTO t1 values (1);
INSERT INTO t1 values (2);
--source include/sync_replica_io_with_primary.inc

# Step-2: Make that binary log as relay log
--remove_file $MYSQLD_REPLICA_DATADIR/replica-relay-bin.000001
--copy_file $MYSQLD_PRIMARY_DATADIR/primary-bin.000001 $MYSQLD_REPLICA_DATADIR/replica-relay-bin.000001

# Step-3: Now start worker thread with that relay log(binary log as relay log)
# and see that worker thread does not have issues in completing it.
SET @save.replica_parallel_workers=@@global.replica_parallel_workers;
SET @@global.replica_parallel_workers=1;

SET @save.replica_transaction_retries=@@global.replica_transaction_retries;
SET @@global.replica_transaction_retries=0;
--source include/start_replica_sql.inc

# Step-4: Make sure everything is replicated
--connection primary
--source include/sync_replica_sql_with_primary.inc
--let diff_tables=primary:t1,replica:t1
--source include/diff_tables.inc

# Cleanup
--connection primary
DROP TABLE t1;
--connection replica
--source include/stop_replica_sql.inc
SET @@global.replica_parallel_workers=@save.replica_parallel_workers;
SET @@global.replica_transaction_retries=@save.replica_transaction_retries;
--source include/start_replica_sql.inc
--source include/rpl_end.inc
