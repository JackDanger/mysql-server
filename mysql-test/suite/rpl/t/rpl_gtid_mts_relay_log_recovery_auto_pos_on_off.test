###############################################################################
# Bug#19316063: MAKE MTS WORK WITH RELAY_LOG_RECOVERY=1 WHEN
# GTID IS ENABLED
#
# Problem:
# ========
# When gaps are present in MTS and trying to restart the server with
# relay-log-recovery=1 will result in the following error.
# "relay-log-recovery cannot be executed when the replica was stopped with an
# error or killed in MTS mode"
#
# Test:
# =====
# Enable GTID protocol and execute the test with both primary_auto_postion
# on and primary_auto_postion off. Generate gaps in MTS, on the replica and
# restart replica server with relay-log-recovery=1. The gaps should
# be filled because of GTID protocol and replica should be in sync with primary.
###############################################################################
--source include/force_restart.inc
# Script is independent of binlog format hence considering mixed mode
--source include/have_binlog_format_mixed.inc
--source include/have_gtid.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
--let $rpl_gtid_utils= 1
--source include/primary-replica.inc

--source include/rpl_connection_replica.inc
CALL mtr.add_suppression("Recovery from primary pos*");
CALL mtr.add_suppression("Replica SQL.*Duplicate entry.* Error_code: 1062");
CALL mtr.add_suppression("The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state");
--let $auto_position=0
--let $loop_count=2

# Execute the following set of instructions twice
# once with change primary with auto position 0
# second time change primary with auto position 1
while ($loop_count)
{
  --source include/stop_replica.inc
  eval CHANGE PRIMARY TO PRIMARY_AUTO_POSITION=$auto_position;
  SET @@global.replica_parallel_workers=4;
  SET @@global.relay_log_info_repository='TABLE';
  SET @@global.primary_info_repository='TABLE';
  --source include/start_replica.inc

  --source extra/rpl_tests/rpl_gtid_mts_relay_log_recovery.test

  if ($auto_position == 0)
  {
    --source include/rpl_reset.inc
  }

  --dec $loop_count
  --inc $auto_position
}


--source include/rpl_end.inc
