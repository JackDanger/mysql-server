# ==== Purpose ====
#
# Testing basic functionality of heartbeat.
#
# Description:
# * Testing different values for replica_heartbeat_period.
# * How to affect various statements to replica_heartbeat_period
# * Various states of replica and heartbeat
# * Various states of primary and heartbeat
# * Circular replication
#
-- source include/big_test.inc
--source include/primary-replica.inc
#
# The test runs long and does not have any specifics to 
# binlog_format. It is choosen therefore to run with MIXED mode
# in order to not slow down much `make test'.
#
--source include/have_binlog_format_mixed.inc

call mtr.add_suppression("Replica I/O: The replica I/O thread stops because a fatal error is encountered when it tried to SET @primary_binlog_checksum");
call mtr.add_suppression("The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state");

--echo

# Set number of retries to connect to primary
let $connect_retry= 20;

--echo *** Preparing ***
--source include/sync_replica_sql_with_primary.inc

--disable_query_log
call mtr.add_suppression("The primary's UUID has changed, although this should not happen unless you have changed it manually.");
--enable_query_log

--source include/stop_replica.inc
RESET REPLICA;
RESET PRIMARY;
SET @restore_replica_net_timeout=@@global.replica_net_timeout;
let $replica_heartbeat_timeout= query_get_value(SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period', Value, 1);
--disable_query_log
eval SET @restore_replica_heartbeat_timeout=$replica_heartbeat_timeout;
--enable_query_log

--connection primary
RESET PRIMARY;
SET @restore_replica_net_timeout=@@global.replica_net_timeout;
SET @restore_event_scheduler=@@global.event_scheduler;
--echo

#
# Test replica_heartbeat_period
#

--connection replica

# Default value of replica_heartbeat_timeout = replica_net_timeout/2
--echo *** Default value ***
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root';
let $replica_net_timeout= query_get_value(SHOW VARIABLES LIKE 'replica_net_timeout', Value, 1);
let $replica_heartbeat_timeout= query_get_value(SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period', Value, 1);
let $result= query_get_value(SELECT $replica_net_timeout/$replica_heartbeat_timeout AS Result, Result, 1);
--echo replica_net_timeout/replica_heartbeat_timeout=$result
RESET REPLICA;
RESET PRIMARY;
--echo

# Reset replica set replica_heartbeat_timeout = replica_net_timeout/2
--echo *** Reset replica affect ***
--disable_warnings
SET @@global.replica_net_timeout=30;
--enable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=5;
RESET REPLICA;
RESET PRIMARY;
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
--echo

# Check default value of replica_heartbeat_timeout if replica_net_timeout is changed
--echo *** Default value if replica_net_timeout changed ***
--disable_warnings
SET @@global.replica_net_timeout=50;
--enable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry;
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SET @@global.replica_net_timeout=@restore_replica_net_timeout;
RESET REPLICA;
RESET PRIMARY;
--echo

# Set replica_net_timeout less than current value of replica_heartbeat_period
--echo *** Warning if updated replica_net_timeout < replica_heartbeat_timeout ***
let $replica_heartbeat_timeout= query_get_value(SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period', Value, 1);
--replace_result $replica_heartbeat_timeout REPLICA_HEARTBEAT_TIMEOUT
eval SET @@global.replica_net_timeout=FLOOR($replica_heartbeat_timeout)-1;
SET @@global.replica_net_timeout=@restore_replica_net_timeout;
RESET REPLICA;
RESET PRIMARY;
--echo

# Set value of replica_heartbeat_period greater than replica_net_timeout
--echo *** Warning if updated replica_heartbeat_timeout > replica_net_timeout ***
let $replica_net_timeout= query_get_value(SHOW VARIABLES LIKE 'replica_net_timeout', Value, 1);
inc $replica_net_timeout;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT $replica_net_timeout REPLICA_NET_TIMEOUT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=$replica_net_timeout;
RESET REPLICA;
RESET PRIMARY;
--echo 

# Changing of replica_net_timeout shouldn't affect to current value of replica_heartbeat_period
--echo *** CHANGE PRIMARY statement only updates replica_heartbeat_period ***
--disable_warnings
SET @@global.replica_net_timeout=20;
--enable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=5;
SHOW VARIABLES LIKE 'replica_net_timeout';
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SET @@global.replica_net_timeout=2*@@global.replica_net_timeout;
SHOW VARIABLES LIKE 'replica_net_timeout';
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SET @@global.replica_net_timeout=@restore_replica_net_timeout;
RESET REPLICA;
RESET PRIMARY;
--echo

# Primary value of replica_net_timeout shouldn't affect to replica's replica_heartbeat_period
--echo *** Update replica_net_timeout on primary ***
--connection primary
--disable_warnings
SET @@global.replica_net_timeout=500;
--enable_warnings
--connection replica
SET @@global.replica_net_timeout=200;
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry;
--source include/start_replica.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc
SHOW VARIABLES LIKE 'replica_net_timeout';
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SET @@global.replica_net_timeout=@restore_replica_net_timeout;
--source include/stop_replica.inc
RESET REPLICA;
RESET PRIMARY;
--connection primary
SET @@global.replica_net_timeout=@restore_replica_net_timeout;
--echo

# Start/stop replica shouldn't change replica_heartbeat_period
--echo *** Start/stop replica ***
--connection replica
--disable_warnings
SET @@global.replica_net_timeout=100;
--enable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=20;
--source include/start_replica.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
--source include/stop_replica.inc
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
--echo

# Reload replica shouldn't change replica_heartbeat_period
--echo *** Reload replica ***
--connection replica
--disable_warnings
SET @@global.replica_net_timeout=50;
--enable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=30;
--let $rpl_server_number= 2
--source include/rpl_restart_server.inc
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SET @restore_replica_net_timeout=@@global.replica_net_timeout;
--echo

# Disable heartbeat
--echo *** Disable heartbeat ***
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0;
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SHOW STATUS LIKE 'replica_received_heartbeats';
--source include/start_replica.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc
--sleep 2
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SHOW STATUS LIKE 'replica_received_heartbeats';
--source include/stop_replica.inc
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
SHOW STATUS LIKE 'replica_received_heartbeats';
RESET REPLICA;
RESET PRIMARY;
let $replica_heartbeat_timeout= query_get_value(SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period', Value, 1);
--replace_result $replica_heartbeat_timeout REPLICA_HEARTBEAT_TIMEOUT
--eval SELECT $replica_heartbeat_timeout = 0 AS Result
--echo 

#
# Check limits for replica_heartbeat_timeout
#

--echo *** Min replica_heartbeat_timeout ***
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0.001;
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0.0009;
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
RESET REPLICA;
RESET PRIMARY;
--echo

--echo *** Max replica_heartbeat_timeout ***
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=4294967;
SHOW GLOBAL STATUS LIKE 'replica_heartbeat_period';
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_REPLICA_HEARTBEAT_VALUE_OUT_OF_RANGE 
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=4294968;
RESET REPLICA;
RESET PRIMARY;
# Check double size of max allowed value for primary_heartbeat_period
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_REPLICA_HEARTBEAT_VALUE_OUT_OF_RANGE 
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=8589935;
RESET REPLICA;
RESET PRIMARY;
# Check 2^32
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_REPLICA_HEARTBEAT_VALUE_OUT_OF_RANGE 
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=4294967296;
RESET REPLICA;
RESET PRIMARY;
--echo

--echo *** Misc incorrect values ***
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_PARSE_ERROR
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD='-1';
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_PARSE_ERROR
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD='123abc';
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--error ER_PARSE_ERROR
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD='';
RESET REPLICA;
RESET PRIMARY;
--echo

#
# Testing heartbeat 
#
# Check received heartbeat events for running replica.
# It must arrived not ealier than as specified by HEARTBEAT_PERIOD.
#
--let $hb_period= 3.0
--echo *** Running replica ***
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD= $hb_period;
SELECT unix_timestamp() into @time_0;
--source include/start_replica.inc

--connection primary
--source include/sync_replica_sql_with_primary.inc
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var= replica_received_heartbeats;
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
SELECT unix_timestamp() into @time_1;
if (`SELECT @time_1 - @time_0 < $hb_period`)
{
    --echo "Heartbeat is received ealier than specified."
    --die
}
--echo Heartbeat event received
--echo

# Check received heartbeat events for stopped replica
--echo *** Stopped replica ***
--source include/stop_replica.inc
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD= 0.1;

let $rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
sleep 2;
let $rcvd_heartbeats_after= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $result= query_get_value(SELECT ($rcvd_heartbeats_after - $rcvd_heartbeats_before) AS Result, Result, 1);
--echo Number of received heartbeat events while replica stopped: $result
--echo

# Check received heartbeat events for started replica
--echo *** Started replica ***
--source include/start_replica.inc
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
--source include/wait_for_status_var.inc
--echo Heartbeat event received
--echo

# Check received heartbeat events for stopped IO thread
--echo *** Stopped IO thread ***
--source include/stop_replica_io.inc
let $rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
sleep 2;
let $rcvd_heartbeats_after= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $result= query_get_value(SELECT ($rcvd_heartbeats_after - $rcvd_heartbeats_before) AS Result, Result, 1);
--echo Number of received heartbeat events while io thread stopped: $result
--echo

# Check received heartbeat events for started IO thread
--echo *** Started IO thread ***
START REPLICA IO_THREAD;
--source include/wait_for_replica_io_to_start.inc
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
--source include/wait_for_status_var.inc
--echo Heartbeat event received
--echo

# Check received heartbeat events for stopped SQL thread
--echo *** Stopped SQL thread ***
--source include/stop_replica_sql.inc
let $rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
sleep 2;
let $rcvd_heartbeats_after= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $result= query_get_value(SELECT ($rcvd_heartbeats_after - $rcvd_heartbeats_before) > 0 AS Result, Result, 1);
--echo Heartbeat events are received while sql thread stopped (1 means 'yes'): $result
--echo

# Check received heartbeat events for started SQL thread
--echo *** Started SQL thread ***
START REPLICA SQL_THREAD;
--source include/wait_for_replica_sql_to_start.inc
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
--source include/wait_for_status_var.inc
--echo Heartbeat event received
--echo

# Check received heartbeat event for stopped SQL thread by error
--echo *** Stopped SQL thread by error ***
--connection primary
CREATE TABLE t1 (a INT PRIMARY KEY, b VARCHAR(10), c LONGTEXT);
--source include/sync_replica_sql_with_primary.inc
INSERT INTO t1 VALUES (1, 'on replica', NULL);
--connection primary
INSERT INTO t1 VALUES (1, 'on primary', NULL);
--connection replica
call mtr.add_suppression("Replica SQL.*Duplicate entry .1. for key .PRIMARY.. on query.* Error_code: 1062");
call mtr.add_suppression("Replica SQL.*Request to stop replica SQL Thread received while applying a group that has non-transactional changes; waiting for completion of the group");
let $replica_errno= ER_DUP_ENTRY
--source include/wait_for_replica_sql_error.inc
let $rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
sleep 2;
let $rcvd_heartbeats_after= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $result= query_get_value(SELECT ($rcvd_heartbeats_after - $rcvd_heartbeats_before) > 0 AS Result, Result, 1);
--echo Heartbeat events are received while sql thread stopped (1 means 'yes'): $result
--source include/stop_replica.inc
DELETE FROM t1;
--source include/start_replica.inc
--connection primary
--source include/sync_replica_sql_with_primary.inc
--connection primary
DROP TABLE t1;
--echo

# Check received heartbeat events while logs flushed on replica
--source include/sync_replica_sql_with_primary.inc
--echo *** Flush logs on replica ***
--let $rpl_no_start_replica= 1
--source include/rpl_reset.inc
--let $rpl_no_start_replica= 0
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0.5;
let $replica_param_comparison= =;
--source include/start_replica.inc
let $rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
# Flush logs every 0.1 second during 10 sec
--disable_query_log
let $i=100;
while ($i) {
  FLUSH LOGS;
  dec $i;
  sleep 0.1;
}
--enable_query_log
--let $assert_cond= [SHOW STATUS LIKE "replica_received_heartbeats", Value, 1] > $rcvd_heartbeats_before
--let $assert_text= Should receive at least one heartbeat event while running FLUSH LOGS for 10 seconds
--source include/assert.inc
--echo

# Use compressed protocol between primary and replica
--echo *** Compressed protocol ***
--connection primary
SET @@global.replica_compressed_protocol=1;
--connection replica
--source include/stop_replica.inc
RESET REPLICA;
RESET PRIMARY;
SET @@global.replica_compressed_protocol=1;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0.1;
--source include/start_replica.inc
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var= replica_received_heartbeats;
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
--echo Heartbeat event received
SET @@global.replica_compressed_protocol=0;
--connection primary
SET @@global.replica_compressed_protocol=0;
--echo


# Check received heartbeat events after reset of primary
--echo *** Reset primary ***
--connection replica

STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0.1;
--source include/start_replica.inc
let $rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
--connection primary
RESET PRIMARY;
--enable_query_log
--source include/sync_replica_sql_with_primary.inc
--sleep 2
let $rcvd_heartbeats_after= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $result= query_get_value(SELECT ($rcvd_heartbeats_after - $rcvd_heartbeats_before) > 0 AS Result, Result, 1);
--echo Heartbeat events are received after reset of primary (1 means 'yes'): $result
--echo

# Reloaded primary should restore heartbeat
--echo *** Reload primary ***
--connection replica
STOP REPLICA;
RESET REPLICA;
RESET PRIMARY;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$PRIMARY_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=0.1;
--source include/start_replica.inc
# Wait until replica_received_heartbeats will be incremented
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var= replica_received_heartbeats;
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
--echo Heartbeat event received
--let $rpl_server_number= 1
--source include/rpl_restart_server.inc
# make sure IO thread has re-connected 
# due to slow valgrind env the following wait_for_status may time out
--let $rpl_allow_error= 1
--source include/wait_for_replica_io_to_start.inc
# Wait until replica_received_heartbeats will be incremented
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var= replica_received_heartbeats;
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
--echo Heartbeat event received
--echo

# Circular replication: demonstrating bidirectional hearbeat flow
--echo *** Circular replication ***
# Configure circular replication
--source include/rpl_reset.inc
--source include/stop_replica.inc
--let $rpl_topology= 1->2->1
--source include/rpl_change_topology.inc

#--connection replica
#--source include/stop_replica.inc
#let $replica_binlog= query_get_value(SHOW PRIMARY STATUS, File, 1);
--connection primary
#--replace_result $REPLICA_MYPORT REPLICA_PORT $replica_binlog REPLICA_BINLOG
#eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_PORT=$REPLICA_MYPORT, PRIMARY_USER='root', PRIMARY_CONNECT_RETRY=$connect_retry, PRIMARY_HEARTBEAT_PERIOD=1, PRIMARY_LOG_FILE='$replica_binlog';

# BUG#12403008 RPL_HEARTBEAT_BASIC FAILS SPORADICALLY ON PUSHBUILD
# PRIMARY_HEARTBEAT_PERIOD had the default value (replica_net_timeout/2)
# so wait on "Heartbeat event received on primary", that only waits for
# 1 minute, sometimes timeout before heartbeat arrives.
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_HEARTBEAT_PERIOD=1;
--source include/start_replica.inc

# Insert data on primary and on replica and make sure that it replicated for both directions
CREATE TABLE t1 (a INT PRIMARY KEY, b VARCHAR(10));
INSERT INTO t1 VALUES(1, 'on primary');
--save_primary_pos
--connection replica
## set replica period 1/10 of primary's
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_HEARTBEAT_PERIOD=0.1;
--source include/start_replica.inc
--sync_with_primary
INSERT INTO t1 VALUES(2, 'on replica');
--let $sync_replica_connection= primary
--source include/sync_replica_sql_with_primary.inc
SELECT * FROM t1 ORDER BY a;
let $primary_rcvd_heartbeats_before= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
--connection replica
SELECT * FROM t1 ORDER BY a;

# Wait for heartbeat event on primary
--connection primary
let $status_var= replica_received_heartbeats;
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
--echo Heartbeat event received on primary

# Wait heartbeat events on replica
--connection replica
let $status_var= replica_received_heartbeats;
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
--echo Heartbeat event received on replica
let $replica_rcvd_heartbeats= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);

#
# Clean up and restore system variables
#
--echo *** Clean up ***
--connection primary
#--source include/stop_replica.inc
DROP TABLE t1;
--connection replica
SET @@global.replica_net_timeout=@restore_replica_net_timeout;

#--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
