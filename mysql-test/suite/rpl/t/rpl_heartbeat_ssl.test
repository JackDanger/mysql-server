#############################################################
# Author: Serge Kozlov <Serge.Kozlov@Sun.COM>
# Date:   02/19/2009
# Purpose: Testing basic functionality of heartbeat over SSL
#############################################################
--source include/not_gtid_enabled.inc
--source include/not_group_replication_plugin.inc
--source include/have_ssl_communication.inc
--source include/primary-replica.inc
--echo

#
# Testing heartbeat over SSL
#

# Heartbeat over SSL 
--echo *** Heartbeat over SSL ***
--connection primary
let $primary_binlog= query_get_value(SHOW PRIMARY STATUS, File, 1);
--connection replica
--source include/stop_replica.inc
RESET REPLICA;
# Connect to primary with SSL
--replace_result $PRIMARY_MYPORT PRIMARY_PORT $MYSQL_TEST_DIR MYSQL_TEST_DIR $primary_binlog PRIMARY_BINLOG
--replace_column 2 ####
eval CHANGE PRIMARY TO 
    PRIMARY_HOST='127.0.0.1',
    PRIMARY_PORT=$PRIMARY_MYPORT,
    PRIMARY_USER='root',
    PRIMARY_HEARTBEAT_PERIOD=0.1,
    PRIMARY_LOG_FILE='$primary_binlog',
    PRIMARY_SSL=1,
    PRIMARY_SSL_CA='$MYSQL_TEST_DIR/std_data/cacert.pem',
    PRIMARY_SSL_CERT='$MYSQL_TEST_DIR/std_data/client-cert.pem',
    PRIMARY_SSL_KEY='$MYSQL_TEST_DIR/std_data/client-key.pem';
--source include/start_replica.inc
# Check SSL state of replica
let $replica_ssl_status= query_get_value(SHOW REPLICA STATUS, Primary_SSL_Allowed, 1);
--echo Primary_SSL_Allowed: $replica_ssl_status
# Wait until hearbeat event will received
let $status_var_value= query_get_value(SHOW STATUS LIKE 'replica_received_heartbeats', Value, 1);
let $status_var= replica_received_heartbeats;
let $status_var_comparsion= >;
--source include/wait_for_status_var.inc
--echo Heartbeat event has received
--echo

#
# Clean up
#
--echo *** Clean up ***
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO 
    PRIMARY_SSL=0,
    PRIMARY_SSL_CA='',
    PRIMARY_SSL_CERT='',
    PRIMARY_SSL_KEY='';
--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
