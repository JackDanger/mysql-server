# test verifies that REVOKE must not be replicated when 
# replica server starts with --replicate-wild-ignore-table=mysql.% 
# the option is set in rpl_ignore_revoke-replica.opt
# The first part of BUG#9483 for GRANT is checked by
# existed specific rpl_ignore_grant test case (BUG#980)

--source include/not_group_replication_plugin.inc
source include/primary-replica.inc;

###  CLEAN-UP: create an account and manually duplicate it on the replica

connection primary;
grant select on *.* to 'user_foo'@'%' identified by 'user_foopass';
revoke select on *.* from 'user_foo'@'%';
select select_priv from mysql.user where user='user_foo' /* primary:must be N */;

--source include/sync_replica_sql_with_primary.inc
#connection replica;
grant select on *.* to 'user_foo'@'%' identified by 'user_foopass';
revoke select on *.* from 'user_foo'@'%';
select select_priv from mysql.user where user='user_foo' /* replica:must be N */;


### TEST

#connection replica;
grant select on *.* to 'user_foo'@'%' identified by 'user_foopass';
select select_priv from mysql.user where user='user_foo' /* replica:must be Y */;

connection primary;
revoke select on *.* from 'user_foo';
select select_priv from mysql.user where user='user_foo' /* primary:must be N */;

--source include/sync_replica_sql_with_primary.inc
#connection replica;
select select_priv from mysql.user where user='user_foo' /* replica:must get Y */;

### CLEAN-UP

connection replica;
--disable_abort_on_error
revoke select on *.* FROM 'user_foo';
--enable_abort_on_error

connection primary;
delete from mysql.user where user="user_foo";
--source include/sync_replica_sql_with_primary.inc

# Since changes to mysql.* are ignored, the revoke need to
# be done on replica as well
delete from mysql.user where user="user_foo";
--source include/rpl_end.inc
