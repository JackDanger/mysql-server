################################################################################
# This test case aims to verify if the changes made to the START REPLICA command
# in the context of the WL#4143 work as specified. The following properties
# are verified:
#
# 0 - This aims at checking syntax.
#
# 1 - If START REPLICA works with regular users and different combinations
#     of USER and PASSWORD.
#
# 2 - If START REPLICA USER=xxxx PASSWORD=yyyy works with pluggable users
#     and different combinations of DEFAULT_AUTH and PLUGIN_DIR.
#     It is always required to provide a password when pluggable users are
#     used. The password is the name of the proxy user.
# 
# 3 - If START REPLICA works with pluggable users defined in the primary info
#     repository.
#
# 4 - The warning message "Sending passwords in plain text without SSL/TLS is"
#      extremely insecure" is not printed out if a SSL connection is in use.
################################################################################
--source include/not_group_replication_plugin.inc
--source include/have_plugin_auth.inc
--source include/not_embedded.inc
--source include/have_openssl.inc
--source include/primary-replica.inc

################################################################################
# 1. Prepare the environment
################################################################################
SET SQL_LOG_BIN=0;

--sorted_result
SELECT user, plugin, authentication_string FROM mysql.user WHERE user != 'root';

CREATE USER 'plug_user_p' IDENTIFIED WITH 'test_plugin_server' AS 'proxy_user_p';
CREATE USER 'plug_user_wp' IDENTIFIED WITH 'test_plugin_server' AS 'proxy_user_wp';
CREATE USER 'proxy_user_p' IDENTIFIED BY 'password';
CREATE USER 'proxy_user_wp' IDENTIFIED BY '';
CREATE USER 'regular_user_p' IDENTIFIED BY 'password';
CREATE USER 'regular_user_wp' IDENTIFIED BY '';

--sorted_result
SELECT user, plugin, authentication_string FROM mysql.user WHERE user != 'root';

GRANT PROXY ON proxy_user_p to plug_user_p;
GRANT PROXY ON proxy_user_wp to plug_user_wp;
GRANT REPLICATION REPLICA ON *.* TO proxy_user_p;
GRANT REPLICATION REPLICA ON *.* TO proxy_user_wp;
GRANT REPLICATION REPLICA ON *.* TO regular_user_p;
GRANT REPLICATION REPLICA ON *.* TO regular_user_wp;

SET SQL_LOG_BIN=1;

###############################################################################
# 2. Test if different type of users can connect when CHANGE PRIMARY
#    START REPLICA are specified
###############################################################################
--connection replica
--let $replica_io_errno= 2059
--let $show_replica_io_error= 0

#
# Check Property 0
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--error ER_SQLTHREAD_WITH_SECURE_REPLICA
--eval START REPLICA SQL_THREAD USER= 'regular_user_p' PASSWORD= 'password'

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--error ER_SQLTHREAD_WITH_SECURE_REPLICA
--eval START REPLICA SQL_THREAD USER= 'regular_user_p' PASSWORD= 'password' DEFAULT_AUTH= 'auth_test_plugin'

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--error ER_SQLTHREAD_WITH_SECURE_REPLICA
--eval START REPLICA SQL_THREAD USER= 'regular_user_p' PASSWORD= 'password' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA IO_THREAD USER= 'regular_user_p' PASSWORD= 'password'
--source include/wait_for_replica_io_to_start.inc
--source include/stop_replica_io.inc

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA IO_THREAD USER= 'regular_user_p' PASSWORD= 'password' DEFAULT_AUTH= 'auth_test_plugin'
--source include/wait_for_replica_io_to_start.inc
--source include/stop_replica_io.inc

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA IO_THREAD USER= 'regular_user_p' PASSWORD= 'password' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--source include/wait_for_replica_io_to_start.inc
--source include/stop_replica_io.inc

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA IO_THREAD, SQL_THREAD USER= 'regular_user_p' PASSWORD= 'password'
--source include/wait_for_replica_io_to_start.inc
--source include/stop_replica_io.inc

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA IO_THREAD, SQL_THREAD USER= 'regular_user_p' PASSWORD= 'password' DEFAULT_AUTH= 'auth_test_plugin'
--source include/wait_for_replica_io_to_start.inc
--source include/stop_replica_io.inc

--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA IO_THREAD, SQL_THREAD USER= 'regular_user_p' PASSWORD= 'password' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--source include/wait_for_replica_io_to_start.inc
--source include/stop_replica_io.inc

#
# Check Property 1.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'regular_user_p' PASSWORD= 'password'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 1.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'regular_user_wp' PASSWORD= ''
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 1.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'regular_user_p' PASSWORD= 'password'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 1.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'regular_user_wp' PASSWORD= ''
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 1.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'regular_user_wp'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_result $PRIMARY_MYSOCK PRIMARY_MYSOCK $PLUGIN_AUTH_OPT PLUGIN_AUTH_OPT
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_p' PASSWORD= 'proxy_user_p'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_result $PRIMARY_MYSOCK PRIMARY_MYSOCK $PLUGIN_AUTH_OPT PLUGIN_AUTH_OPT
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_wp' PASSWORD= 'proxy_user_wp'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_p' PASSWORD= 'proxy_user_p' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_wp' PASSWORD= 'proxy_user_wp' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_p' PASSWORD= 'proxy_user_p' DEFAULT_AUTH= 'auth_test_plugin'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_wp' PASSWORD= 'proxy_user_wp' DEFAULT_AUTH= 'auth_test_plugin'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_p' PASSWORD= 'proxy_user_p' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 2.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'DOES NOT EXIST', PRIMARY_PASSWORD = 'DOES NOT EXIST';
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--replace_column 2 ####
--eval START REPLICA USER= 'plug_user_wp' PASSWORD= 'proxy_user_wp' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

#
# Check Property 3.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'plug_user_p', PRIMARY_PASSWORD= 'proxy_user_p';
--source include/start_replica.inc
--source include/check_replica_is_running.inc

#
# Check Property 3.
#
--source include/stop_replica.inc
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'plug_user_wp', PRIMARY_PASSWORD= 'proxy_user_wp';
--source include/start_replica.inc
--source include/check_replica_is_running.inc

#
# Check Property 4
#

--connection replica
CREATE USER 'ssl_user' IDENTIFIED BY '';
GRANT ALL ON *.* TO ssl_user REQUIRE SSL;
--source include/stop_replica.inc
--replace_result $REPLICA_MYPORT REPLICA_MYPORT
connect (con_ssl,127.0.0.1,ssl_user,,test,$REPLICA_MYPORT,,SSL);
--connection con_ssl
--replace_column 2 ####
CHANGE PRIMARY TO PRIMARY_USER= 'root', PRIMARY_PASSWORD = '';
--source include/start_replica.inc

--source include/stop_replica.inc
--eval START REPLICA USER= 'root' PASSWORD= ''
--source include/wait_for_replica_to_start.inc
--source include/check_replica_is_running.inc

# 
# Bug#13410464: FOR START REPLICA .. PASSWORD=<PASSWORD>, THE PASSWORD IS LOGGED IN PLAIN TEXT  
#

SET @old_log_output= @@log_output;
SET GLOBAL log_output= 'TABLE,FILE';

call mtr.add_suppression(".*Invalid .* username when attempting to connect to the primary server.*");
--disable_warnings

--source include/stop_replica.inc
TRUNCATE mysql.general_log;
START REPLICA PASSWORD='secret';
--let $replica_io_errno=1593
--source include/wait_for_replica_io_error.inc

--source include/stop_replica.inc
TRUNCATE mysql.general_log;
START REPLICA USER='root' PASSWORD='secret';
--let $rewritten= `SELECT argument FROM mysql.general_log WHERE argument LIKE "%PASSWORD = '<secret>'%"`
# execute it to see if the rewrite generated a (syntatically) valid command 
--source include/stop_replica.inc
--eval $rewritten

--source include/stop_replica.inc
TRUNCATE mysql.general_log;
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval START REPLICA IO_THREAD USER='root' PASSWORD='secret' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--let $rewritten= `SELECT argument FROM mysql.general_log WHERE argument LIKE "%PASSWORD = '<secret>'%"`
# execute it to see if the rewrite generated a (syntatically) valid command 
--source include/stop_replica.inc
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval $rewritten

--source include/stop_replica.inc
TRUNCATE mysql.general_log;
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval START REPLICA IO_THREAD, SQL_THREAD USER='root' PASSWORD='secret' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--let $rewritten= `SELECT argument FROM mysql.general_log WHERE argument LIKE "%PASSWORD = '<secret>'%"`
# execute it to see if the rewrite generated a (syntatically) valid command 
--source include/stop_replica.inc
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval $rewritten

--source include/stop_replica.inc
TRUNCATE mysql.general_log;
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval START REPLICA IO_THREAD, SQL_THREAD UNTIL PRIMARY_LOG_FILE='dummy-log.000001', PRIMARY_LOG_POS=116 USER='root' PASSWORD='secret' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--let $rewritten= `SELECT argument FROM mysql.general_log WHERE argument LIKE "%PASSWORD = '<secret>'%"`
# execute it to see if the rewrite generated a (syntatically) valid command 
--source include/stop_replica.inc
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval $rewritten

--source include/stop_replica.inc
TRUNCATE mysql.general_log;
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval START REPLICA IO_THREAD, SQL_THREAD UNTIL RELAY_LOG_FILE='dummy-log.000001', RELAY_LOG_POS=116 USER='root' PASSWORD='secret' DEFAULT_AUTH= 'auth_test_plugin' PLUGIN_DIR= '$PLUGIN_AUTH_DIR'
--let $rewritten= `SELECT argument FROM mysql.general_log WHERE argument LIKE "%PASSWORD = '<secret>'%"`
# execute it to see if the rewrite generated a (syntatically) valid command 
--source include/stop_replica.inc
--replace_result $PLUGIN_AUTH_DIR PLUGIN_AUTH_DIR
--eval $rewritten

--source include/stop_replica.inc

--enable_warnings

SET GLOBAL log_output= @old_log_output;
TRUNCATE mysql.general_log;
--source include/start_replica.inc

################################################################################
# 3. Clean the environment
################################################################################
--connection primary
SET SQL_LOG_BIN=0;
DROP USER plug_user_p, plug_user_wp, regular_user_p, regular_user_wp, proxy_user_p, proxy_user_wp;
SET SQL_LOG_BIN=1;

--connection replica
DROP USER ssl_user;
disconnect con_ssl;

--source include/rpl_end.inc
