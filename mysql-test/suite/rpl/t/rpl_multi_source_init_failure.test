--source include/have_binlog_format_statement.inc
--source include/primary-replica.inc

--source include/rpl_connection_replica.inc
#
# Testing how well MSR handles initialization failures.
# Specifically it's proved that a failure to initialize mi in one of
# the channels allows RESET REPLICA, no crash happens.
#

call mtr.add_suppression("Error during --relay-log-recovery");
call mtr.add_suppression("Replica: Failed to initialize the primary info structure for channel");
call mtr.add_suppression("Failed to create or recover replication info repositories");
call mtr.add_suppression("Recovery from primary pos.* and file");
# The default channel and channel 'ch_a' will connect to the same primary
call mtr.add_suppression("A replica with the same server_uuid as this replica has connected to the primary");

--source include/stop_replica.inc

SET @@global.primary_info_repository="TABLE";
SET @@global.relay_log_info_repository="TABLE";
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
eval CHANGE PRIMARY TO PRIMARY_HOST='localhost', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT FOR CHANNEL 'ch_a';
CHANGE PRIMARY TO PRIMARY_HOST='dummy_host', PRIMARY_USER='root', PRIMARY_PORT=13010 FOR CHANNEL 'ch_b';
START REPLICA;

STOP REPLICA FOR CHANNEL 'ch_a';

# --relay-log-recovery is a source of the following mi initialization failure
--let $rpl_server_number= 2
--let $rpl_server_parameters= --relay-log-recovery --skip-replica-start --primary-info-repository=TABLE --relay-log-info-repository=TABLE
--source include/rpl_restart_server.inc

--source include/rpl_connection_replica.inc
RESET REPLICA ALL;
