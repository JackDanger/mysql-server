--source include/have_binlog_format_mixed.inc
--source include/primary-replica.inc

--let $save_mi_repo_type=`SELECT @@GLOBAL.primary_info_repository`
--let $save_rli_repo_type=`SELECT @@GLOBAL.relay_log_info_repository`
--let $save_replica_parallel_workers=`SELECT @@global.replica_parallel_workers`

#
# BUG#20236305: MSR: CRASH ON 'START/STOP REPLICA' CMD I.E. ER1794 -> ER1201 -> CRASH
#

# Tests that default channel is created even if creation of
# other channels fails in multisource replication.
# Test that default channel is always created to preserve
# backward compatibility.

--source include/rpl_connection_replica.inc
call mtr.add_suppression("Replica failed to initialize relay log info structure from the repository");
call mtr.add_suppression("Replica: Could not start replica for channel");
call mtr.add_suppression("Error during --relay-log-recovery: Could not locate rotate event from the primary");
call mtr.add_suppression("replica with the same server_uuid as this replica has connected to the primary");
call mtr.add_suppression("Failed to create or recover replication info repositories");
--source include/stop_replica.inc

# On the replica
RESET REPLICA ALL;
SET GLOBAL primary_info_repository='TABLE';
SET GLOBAL relay_log_info_repository='TABLE';

# create a new channel
--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='localhost', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT FOR CHANNEL 'ch1'
--enable_warnings

--echo #
--echo # RESTART REPLICA SERVER
--echo #
--let $rpl_server_number= 2
--let $rpl_server_parameters= --relay-log-recovery --skip-replica-start --primary-info-repository=TABLE --relay-log-info-repository=TABLE --replica-parallel-workers=4 --relay-log-purge=0
--source include/rpl_restart_server.inc

# replica fails to initialize due to BUG#19021091 (default
# channel cannot recover valid positions from the SQL
# applier thread).
--error ER_REPLICA_RLI_INIT_REPOSITORY
START REPLICA;

# This command would fail with an error, which would
# fail with error ER_PRIMARY_INFO . Later when start
# replica was issued, the server would crash.
#
# Now, CHANGE PRIMARY succeeds (and later START REPLICA
# fails).
--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='localhost', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT FOR CHANNEL 'ch1'
--enable_warnings

# This would have crashed, but it does not anymore.
--error ER_REPLICA_RLI_INIT_REPOSITORY
START REPLICA;

# Lets clear the offending channel and recreate it.
RESET REPLICA ALL FOR CHANNEL 'ch1';
--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='localhost', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT FOR CHANNEL 'ch1'
--enable_warnings

# Lets configure the default channel as well.
--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='localhost', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT FOR CHANNEL ''
--enable_warnings

# Lets start the replica (and as such, assert that the
# START REPLICA command is not failing any more).
#
# (There are two channels connected to the same server
# though, which may render the replica unable to connect,
# thence not using --source include/start_replica.inc )
START REPLICA;

# clean up
--source include/stop_replica.inc
RESET REPLICA ALL;
--replace_result $save_mi_repo_type SAVE_MI_REPO_TYPE
--eval SET @@global.primary_info_repository='$save_mi_repo_type'
--replace_result $save_rli_repo_type SAVE_RLI_REPO_TYPE
--eval SET @@global.relay_log_info_repository='$save_rli_repo_type'
--replace_result $save_replica_parallel_workers SAVE_PARALLEL_WORKERS
--eval SET @@global.replica_parallel_workers=$save_replica_parallel_workers

--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT
--enable_warnings
--source include/start_replica.inc

--let $rpl_server_number= 2
--let $rpl_server_parameters=
--source include/rpl_restart_server.inc
--source include/rpl_connection_primary.inc

#
# BUG#20191813: MSR + MTS: IF WE HAVE ANY INACTIVE CHANNEL, POST RESTART START REPLICA HITS ER1794
#

#
# Added test case of BUG#20191813 for sanity check
#
# Test validates that even if the default IO channel
# is not initialized, the existing channel will be
# able to start and not throw an error.
#

--source include/rpl_connection_replica.inc
call mtr.add_suppression("Replica: Failed to initialize the primary info structure for channel");
call mtr.add_suppression("The replica coordinator and worker threads are stopped");
call mtr.add_suppression("Recovery from primary pos");
call mtr.add_suppression("It is not possible to change the type of the relay log repository because there are workers repositories with possible");
--source include/stop_replica.inc
RESET REPLICA ALL;
SET @@global.primary_info_repository="TABLE";
SET @@global.relay_log_info_repository="TABLE";
SET @@global.replica_parallel_workers=5;
--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='localhost', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT FOR CHANNEL 'ch_trunk'
--enable_warnings

# make sure that the IO thread related part for the
# existing channel is indeed started (on slow systems
# START REPLICA is asynchronous and thus the server
# could shutdown without having the structures initialized).
--source include/start_replica.inc

--echo === RESTART REPLICA SERVER ===
--let $rpl_server_number= 2
--let $rpl_server_parameters= --relay-log-recovery --skip-replica-start --primary-info-repository=TABLE --relay-log-info-repository=TABLE --replica-parallel-workers=5
--source include/rpl_restart_server.inc
--source include/rpl_connection_replica.inc
START REPLICA;

# clean up
--source include/stop_replica.inc
RESET REPLICA ALL;
--replace_result $save_mi_repo_type SAVE_MI_REPO_TYPE
--eval SET @@global.primary_info_repository='$save_mi_repo_type'
--replace_result $save_rli_repo_type SAVE_RLI_REPO_TYPE
--eval SET @@global.relay_log_info_repository='$save_rli_repo_type'
--replace_result $save_replica_parallel_workers SAVE_PARALLEL_WORKERS
--eval SET @@global.replica_parallel_workers=$save_replica_parallel_workers

--disable_warnings
--replace_result $PRIMARY_MYPORT PRIMARY_MYPORT
--eval CHANGE PRIMARY TO PRIMARY_HOST='127.0.0.1', PRIMARY_USER='root', PRIMARY_PORT=$PRIMARY_MYPORT
--enable_warnings
--source include/start_replica.inc

--let $rpl_server_number= 2
--let $rpl_server_parameters=
--source include/rpl_restart_server.inc
--source include/start_replica.inc
--source include/rpl_connection_primary.inc

--source include/rpl_end.inc
