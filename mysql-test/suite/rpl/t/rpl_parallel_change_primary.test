#
# Test verifies MTS behaviour with regard to Change-Primary.
# It's made the MTS scheduler type insensitive.
# Related bugs:
# Bug 12995174 - MTS: UNEXPECTED RECOVERY ATTEMPT ENDS WITH ER_PRIMARY_INFO OR ASSERTION

--source include/not_group_replication_plugin.inc
--source include/not_gtid_enabled.inc
# The test for bug#12995174 is not format-specific but uses sleep
# so it made to be run in ROW format that is the way the bug is reported.
--source include/have_binlog_format_row.inc
--source include/have_innodb.inc
--source include/primary-replica.inc

--connection replica
call mtr.add_suppression("Replica SQL for channel '': .*Could not execute Write_rows event on table d1.t1; Duplicate entry '13' for key 'a'");
call mtr.add_suppression("Replica SQL for channel '': ... The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state.");
call mtr.add_suppression("Error writing relay log configuration.");
--source include/stop_replica.inc
SET @save.replica_parallel_workers=@@global.replica_parallel_workers;
SET @@global.replica_parallel_workers=2;
--source include/start_replica.inc

--connection primary

CREATE DATABASE d1;
CREATE DATABASE d2;
CREATE TABLE d1.t1 (a int unique) ENGINE=INNODB;
CREATE TABLE d2.t1 (a int unique) ENGINE=INNODB;

INSERT INTO d1.t1 VALUES (1);
FLUSH LOGS;

--source include/sync_replica_sql_with_primary.inc

--source include/stop_replica.inc
CHANGE PRIMARY TO PRIMARY_DELAY=5;
--source include/start_replica.inc

--connection primary
INSERT INTO d1.t1 VALUES (3);
--sleep 3
INSERT INTO d1.t1 VALUES (5);
FLUSH LOGS;

--connection replica
--source include/stop_replica.inc

let $relay_file = query_get_value( SHOW REPLICA STATUS, Relay_Log_File, 1 );
let $relay_pos = query_get_value( SHOW REPLICA STATUS, Relay_Log_Pos, 1 );

--replace_regex /RELAY_LOG_FILE=[^,]+/RELAY_LOG_FILE=FILE/ /RELAY_LOG_POS=[0-9]+/ RELAY_LOG_POS= POS/
eval CHANGE PRIMARY TO RELAY_LOG_FILE='$relay_file', RELAY_LOG_POS=$relay_pos;

--source include/start_replica.inc
--sleep 5
--source include/stop_replica.inc

let $relay_file = query_get_value( SHOW REPLICA STATUS, Relay_Log_File, 1 );
let $relay_pos = query_get_value( SHOW REPLICA STATUS, Relay_Log_Pos, 1 );
--replace_regex /RELAY_LOG_FILE=[^,]+/RELAY_LOG_FILE=FILE/ /RELAY_LOG_POS=[0-9]+/ RELAY_LOG_POS= POS/
eval CHANGE PRIMARY TO RELAY_LOG_FILE='$relay_file', RELAY_LOG_POS=$relay_pos, PRIMARY_DELAY=0;

--source include/start_replica.inc
BEGIN;
INSERT INTO d1.t1 VALUES (13); # to cause the dup key error
# change-primary with gaps
--connection primary

INSERT INTO d1.t1 VALUES (6);
INSERT INTO d2.t1 VALUES (7);
--connection primary1
BEGIN;
INSERT INTO d1.t1 VALUES (13);
--connection primary
BEGIN;
INSERT INTO d2.t1 VALUES (8);  # this worker will race over one inserting (13)
--connection primary1
COMMIT;
--connection primary
COMMIT;
INSERT INTO d2.t1 VALUES (9);

--connection replica1
# make sure workers doing d2.t1 raced the one that occupied  with d1.t1
--let $count= 1
--let $table= d2.t1
--let $wait_condition= select count(*) = 1 from $table where a = 8
--source include/wait_condition_or_abort.inc

--connection replica
# make worker executing (13) to error out
COMMIT;

--let $replica_sql_errno= 1062
--source include/wait_for_replica_sql_error.inc

--source include/stop_replica_io.inc

let $relay_file = query_get_value( SHOW REPLICA STATUS, Relay_Log_File, 1 );
let $relay_pos = query_get_value( SHOW REPLICA STATUS, Relay_Log_Pos, 1 );
--replace_regex /RELAY_LOG_FILE=[^,]+/RELAY_LOG_FILE=FILE/ /RELAY_LOG_POS=[0-9]+/ RELAY_LOG_POS= POS/
--error ER_MTS_CHANGE_PRIMARY_CANT_RUN_WITH_GAPS
eval CHANGE PRIMARY TO RELAY_LOG_FILE='$relay_file', RELAY_LOG_POS=$relay_pos;

SET @@global.replica_parallel_workers= @save.replica_parallel_workers; # cleanup

#
# --relay-log-recovery= 1 and MTS gaps is handled similarly to Change-Primary
#
--let $rpl_server_number= 2
--let $rpl_server_parameters= --relay-log-recovery --skip-replica-start
--source include/rpl_restart_server.inc

--connection replica
SELECT @@global.relay_log_recovery as 'must be ON';
call mtr.add_suppression("--relay-log-recovery cannot be executed when the replica was stopped with an error or killed in MTS mode; consider using RESET REPLICA or restart the server with --relay-log-recovery = 0");
call mtr.add_suppression("Failed to initialize the primary info structure");
call mtr.add_suppression("Failed to create or recover replication info repositories.");
#
# the following suppression applies to either restart.
# The reason it was not required when the test run "normally" with the default
# --relay-log-info-repository=FILE is here:
# Bug #15858271 MTR INCORRECTLY PROPAGATES A SERVER OPTION FROM A PREVIOUS TEST TO THE CURRENT
# todo: The suppression should be removed after the bug is fixed.
#
call mtr.add_suppression("It is not possible to change the type of the relay log repository because there are workers repositories with possible execution gaps. The value of --relay_log_info_repository is altered to one of the found Worker repositories");
--let $rpl_server_number= 2
--let $rpl_server_parameters= --skip-replica-start
--source include/rpl_restart_server.inc

SELECT @@global.relay_log_recovery as 'must be OFF';
--connection replica
DELETE FROM d1.t1 WHERE a = 13;
--source include/start_replica.inc

#
# cleanup
#
--connection primary
DROP DATABASE d1;
DROP DATABASE d2;
--source include/sync_replica_sql_with_primary.inc

###############################################################################
# Bug#20411374: CAN NOT EXECUTE CHANGE PRIMARY AFTER ERROR OCCURED IN MTS MODE
#
# Problem:
# ========
# When error occurred in MTS mode, If user first change primary
# (ER_MTS_CHANGE_PRIMARY_CANT_RUN_WITH_GAPS received here), and then reset replica,
# user can never change primary (error ER_MTS_CHANGE_PRIMARY_CANT_RUN_WITH_GAPS
# occurred again). The debug version mysqld will crash at this case.
#
# Test:
# =====
# Generate MTS gaps and execute CHANGE PRIMARY command so that
# ER_MTS_CHANGE_PRIMARY_CANT_RUN_WITH_GAPS error is reported. Execute RESET
# REPLICA command. Reexecute the CHANGE PRIMARY command once again it should
# report an assert in the case of bug scenario and it should succeed after the
# fix.
###############################################################################
--source include/rpl_connection_replica.inc
--source include/stop_replica.inc
SET @save.replica_parallel_workers=@@global.replica_parallel_workers;
SET @@global.replica_parallel_workers=2;
SET @save.relay_log_info_repository=@@global.relay_log_info_repository;
SET @@global.relay_log_info_repository='TABLE';
--source include/start_replica.inc

--source include/rpl_connection_primary.inc
CREATE DATABASE d1;
CREATE DATABASE d2;
CREATE TABLE d1.t1 (a int unique) ENGINE=INNODB;
CREATE TABLE d2.t1 (a int unique) ENGINE=INNODB;
--source include/sync_replica_sql_with_primary.inc
BEGIN;
INSERT INTO d1.t1 VALUES (13); # to cause the dup key error
# change-primary with gaps
--source include/rpl_connection_primary.inc
INSERT INTO d1.t1 VALUES (6);
INSERT INTO d2.t1 VALUES (7);
--connection primary1
BEGIN;
INSERT INTO d1.t1 VALUES (13);
--connection primary
BEGIN;
INSERT INTO d2.t1 VALUES (8);  # this worker will race over one inserting (13)
--connection primary1
COMMIT;
--connection primary
COMMIT;
INSERT INTO d2.t1 VALUES (9);

--source include/rpl_connection_replica1.inc
# make sure workers doing d2.t1 raced the one that occupied  with d1.t1
--let $count= 1
--let $table= d2.t1
--let $wait_condition= select count(*) = 1 from $table where a = 8
--source include/wait_condition.inc

--source include/rpl_connection_replica.inc
# make worker executing (13) to error out
COMMIT;

--let $replica_sql_errno= 1062
--source include/wait_for_replica_sql_error.inc

--source include/stop_replica_io.inc

--source include/rpl_connection_primary.inc
FLUSH LOGS;
--let $file= query_get_value(SHOW PRIMARY STATUS, File, 1)
--let $pos= query_get_value(SHOW PRIMARY STATUS, Position, 1)

--source include/rpl_connection_replica.inc
--replace_result $PRIMARY_MYPORT PRIMARY_PORT  $file FILE $pos POS
--replace_column 2 ####
--error ER_MTS_CHANGE_PRIMARY_CANT_RUN_WITH_GAPS
eval CHANGE PRIMARY TO PRIMARY_HOST= '127.0.0.1', PRIMARY_PORT= $PRIMARY_MYPORT, PRIMARY_USER= 'root',PRIMARY_LOG_FILE = '$file', PRIMARY_LOG_POS = $pos ;
reset replica;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT  $file FILE $pos POS
--replace_column 2 ####
eval CHANGE PRIMARY TO PRIMARY_HOST= '127.0.0.1', PRIMARY_PORT= $PRIMARY_MYPORT, PRIMARY_USER= 'root',PRIMARY_LOG_FILE = '$file', PRIMARY_LOG_POS = $pos ;

SET @@global.replica_parallel_workers= @save.replica_parallel_workers;
SET @@global.relay_log_info_repository= @save.relay_log_info_repository;
--source include/start_replica.inc
#
# cleanup
#
--source include/rpl_connection_primary.inc
DROP DATABASE d1;
DROP DATABASE d2;

--source include/rpl_end.inc
