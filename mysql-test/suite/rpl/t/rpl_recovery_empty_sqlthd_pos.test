###############################################################################
# Bug#19021091: RELAY_LOG_RECOVERY KO WHEN CHANGE PRIMARY WITHOUT FILE AND
# SQL_THREAD NOT STARTED
#
# Problem:
# ========
# If, on an empty database:
# - CHANGE PRIMARY TO without a PRIMARY_FILE and PRIMARY_POS is used,
# - the IO_THREAD is started WITHOUT starting the SQL_THREAD,
# - MySQL crashed,
# - MySQL is restarted with relay_log_recovery = 1.
#
# Crash recovery will not work as expected:
# - The IO_THREAD position will NOT be initialized to the SQL_THREAD position,
# - SQL_THREAD position will NOT be initialized to the new relay log.
#
# It looks like, when the SQL_THREAD does not have a Relay_Primary_Log_File,
# relay_log_recovery does not work.
#
# Test:
# =====
# Use primary and replica info repositories to be tables and set
# relay-log-recovery=1. Stop the replica, execute a CREATE DATABASE statement on
# the primary. Execute a CHANGE PRIMARY statement on replica without a PRIMARY_FILE
# and PRIMARY_POS. Start IO thread alone. Crash the replica and restart it. When
# replica is restarted with bug, sql thread will not be able to start. It will fail
# with an error saying the database already exists. Post fix sql thread will
# read positions from the first rotate event that is received from the primary.
# Sql thread will start without any error.
###############################################################################
--source include/not_group_replication_plugin.inc
--source include/primary-replica.inc
--source include/force_restart.inc
--source include/rpl_connection_replica.inc
call mtr.add_suppression("Recovery from primary pos .*");

--source include/rpl_connection_replica.inc
--source include/stop_replica.inc

--source include/rpl_connection_primary.inc
CREATE DATABASE test_jfg;

--source include/rpl_connection_replica.inc
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
--replace_column 2 ####
--eval CHANGE PRIMARY TO primary_host='127.0.0.1',primary_port=$PRIMARY_MYPORT,primary_user='root'
START REPLICA IO_THREAD;
source include/wait_for_replica_io_to_start.inc;

--source include/rpl_connection_primary.inc
source include/sync_replica_io_with_primary.inc;

# Restart the replica server
--let $rpl_server_number= 2
--let $rpl_force_stop= 1
--let $rpl_server_parameters=--skip_replica_start=FALSE --primary-info-repository=TABLE --relay-log-info-repository=TABLE --relay-log-recovery=1
--source include/rpl_restart_server.inc

# With bug sql thread will not be able to start it will fail with error 1007
# Replica: Can't create database 'test_jfg'; database exists Error_code: 1007
source include/wait_for_replica_sql_to_start.inc;

--source include/rpl_connection_primary.inc
DROP DATABASE test_jfg;
--source include/rpl_end.inc
