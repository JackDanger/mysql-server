###############################################################################
# Bug#19021091: RELAY_LOG_RECOVERY KO WHEN CHANGE PRIMARY WITHOUT FILE AND
# SQL_THREAD NOT STARTED
#
# Problem:
# ========
# If, on an empty database:
# - CHANGE PRIMARY TO without a PRIMARY_FILE and PRIMARY_POS is used,
# - the IO_THREAD is started WITHOUT starting the SQL_THREAD,
# - MySQL crashed,
# - MySQL is restarted with relay_log_recovery = 1.
#
# Crash recovery will not work as expected:
# - The IO_THREAD position will NOT be initialized to the SQL_THREAD position,
# - SQL_THREAD position will NOT be initialized to the new relay log.
#
# It looks like, when the SQL_THREAD does not have a Relay_Primary_Log_File,
# relay_log_recovery does not work.
#
# Test:
# =====
# If SQL_THREAD does not have a Relay_Primary_Log_File set recovery process
# will try to extract the first rotate event from the primary and try to
# extract primary_log_file and primary_log_pos from the rotate event. But when
# replicate-same-server-id is set primary and replica will have same server_id
# and it will not be possible to identify the rotate event from primary. Hence
# if recovery is happening with empty Relay_Primary_Log_File and
# replicate-same-server-id is set we generate an error saying recovery is not
# possible.
#
# Enable replicate-same-server-id. Set replica's info repository to be tables
# and set relay-log-recovery=1. Start replica io_thread to ensure that
# Relay_Primary_Log_File is not initialized. Stop and restart the replica server.
# Relay log recovery will not happen replica will generate an error in error log
# as shown below.
#
# Error during --relay-log-recovery, replicate_same_server_id is in use and
# sql thread's positions are not initialized, hence relay log recovery cannot
# happen.
###############################################################################
--source include/force_restart.inc
--source include/not_group_replication_plugin.inc
--source include/primary-replica.inc

--source include/rpl_connection_replica.inc
call mtr.add_suppression("Failed to initialize the primary info structure");
call mtr.add_suppression("Error during --relay-log-recovery *");
CREATE TABLE t1 ( n INT);
RESET PRIMARY;

# replicate ourselves
--source include/stop_replica.inc
--source include/wait_for_replica_to_stop.inc
--replace_result $REPLICA_MYPORT REPLICA_PORT
eval CHANGE PRIMARY TO PRIMARY_PORT=$REPLICA_MYPORT;
START REPLICA IO_THREAD;
--source include/wait_for_replica_io_to_start.inc

# Restart the replica server
--let $rpl_server_number= 2
--source include/rpl_stop_server.inc

--let $rpl_server_number= 2
--let $rpl_server_parameters=--skip_replica_start=FALSE --primary-info-repository=TABLE --relay-log-info-repository=TABLE --relay-log-recovery=1
--source include/rpl_start_server.inc

--let $assert_text= One error should match 'Error during --relay-log-recovery'
--let $assert_file= $MYSQLTEST_VARDIR/tmp/replica.err
--let $assert_select= Error during --relay-log-recovery
--let $assert_count= 1
--source include/assert_grep.inc

# Clean up Server needs to be restarted with relay-log-recovery=0
--let $rpl_server_number= 2
--let $rpl_server_parameters=--primary-info-repository=TABLE --relay-log-info-repository=TABLE --relay-log-recovery=0
--source include/rpl_restart_server.inc

DROP TABLE t1;
--replace_result $PRIMARY_MYPORT PRIMARY_PORT
eval change primary to primary_port=$PRIMARY_MYPORT;
--source include/start_replica.inc

--source include/rpl_end.inc
