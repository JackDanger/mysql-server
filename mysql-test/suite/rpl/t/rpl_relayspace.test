# The replica is started with relay_log_space_limit=10 bytes,
# to force the deadlock after one event.

--source include/not_group_replication_plugin.inc
source include/primary-replica.inc;
--let $primary_log_file= query_get_value(SHOW PRIMARY STATUS, File, 1)
connection replica;
--source include/stop_replica.inc
connection primary;
# This will generate a primary's binlog > 10 bytes
create table t1 (a int);
drop table t1;
create table t1 (a int);
drop table t1;
connection replica;
reset replica;
start replica io_thread;
# Give the I/O thread time to block.
let $replica_param= Replica_IO_State;
let $replica_param_value= Waiting for the replica SQL thread to free enough relay log space;
source include/wait_for_replica_param.inc;

# A bug caused the I/O thread to refuse stopping.
--source include/stop_replica_io.inc
reset replica;
--source include/start_replica.inc

# The I/O thread stops filling the relay log when it's >10b. And the
# SQL thread cannot purge this relay log as purge is done only when
# the SQL thread switches to another relay log, which does not exist
# here.  So we should have a deadlock.  If it is not resolved
# automatically we'll detect it with primary_pos_wait that waits for
# farther than 1Ob; it will timeout after 300 seconds (which is inline
# with the default used for sync_replica_with_primary and will protect us
# against slow test envs); also the replica will probably not cooperate
# to shutdown (as 2 threads are locked)
--let $outcome= `SELECT PRIMARY_POS_WAIT('$primary_log_file',200,300) AS mpw;`

# primary_pos_wait returns:
#
# * >= 0, the number of events the replica had to wait to advance to the
#         position
#
# * -1,   if there was a timeout
#
# * NULL, if an error occurred, or the SQL thread was not started,
#         replica primary info is not initialized, the arguments are incorrect
--let $assert_text= Assert that primary_pos_wait does not timeout nor it returns NULL
--let $assert_cond= $outcome IS NOT NULL AND $outcome <> -1
--source include/assert.inc

# End of 4.1 tests
--source include/rpl_end.inc
