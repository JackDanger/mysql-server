#
#BUG#13333431 : INCORRECT DEFAULT PORT IN 'SHOW REPLICA HOSTS' OUTPUT 
#
# ==== Purpose ====
#
# The test show the default value printed for the replica's port number if the 
# --report-port= <some value> is not set on the replica. This is different from
# the present scenario which show 3306 as the default value if the report-port 
# is not set on the replica. 
#
#====Method====
#
# Start replication  with report port set to 9000 and restart the replica.
# In this case on doing SHOW REPLICA HOSTS on the primary, we get the port number
# of the replica to be 9000.
# In the second case restart the replica server with report port not set. In this
# case on doing SHOW REPLICA HOSTS on the primary, we get the actual port number
# of the replica (ie. REPLICA_PORT).

source include/primary-replica.inc;
source include/have_binlog_format_mixed.inc;

connection primary;

# Start the server with some value being passed to the report_port= <option>
# this will be used incase we have to mask the value of the replica's port
# number in certain situations.

--let $rpl_server_number= 2
--let $rpl_server_parameters= --report-port=9000
--source include/rpl_restart_server.inc

connection replica;
--source include/start_replica.inc
--let $replica_param= Replica_IO_State
--let $replica_param_value= Waiting for primary to send event
--source include/wait_for_replica_param.inc

--echo [Replica restarted with the report-port set to some value]
connection primary;

# 9000 is the value of the port we should get.
--let $report_port= query_get_value(SHOW REPLICA HOSTS, Port, 1)
--let assert_text= The value shown for the replica's port number is user specified port number which is the value set for report-port.
--let assert_cond= $report_port = "9000"
--source include/assert.inc

# Start the server with the report-port being passed with no value. So on SHOW REPLICA HOSTS
# on the primary the value of replica's port should be the actual value of the replica port.
connection primary;

--let $rpl_server_number= 2
--let $rpl_server_parameters= 
--source include/rpl_restart_server.inc

connection replica;
--source include/start_replica.inc
--let $replica_param= Replica_IO_State
--let $replica_param_value= Waiting for primary to send event
--source include/wait_for_replica_param.inc

connection primary;
--source include/sync_replica_sql_with_primary.inc
--echo [Replica restarted with the report-port set to the value of replica's port number]

connection primary;

# The value reported is the actual value of the replica's port.
--let $report_port= query_get_value(SHOW REPLICA HOSTS, Port, 1)
--let assert_text= The default value shown for the replica's port number is the actual port number of the replica.
--let assert_cond= $report_port = "$REPLICA_MYPORT"
--source include/assert.inc

--source include/rpl_end.inc
