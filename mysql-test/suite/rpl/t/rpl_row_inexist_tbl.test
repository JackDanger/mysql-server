# ==== Purpose ====
#
# Verify that replica gives an error message if primary updates a table
# that replica does not have.
#
# ==== Method ====
#
# Create a table on primary, wait till it's on replica, remove it from
# replica.  Then update the table on primary.
--source include/not_group_replication_plugin.inc
--source include/have_binlog_format_row.inc

source include/primary-replica.inc;

--echo ==== Setup table on primary but not on replica ====
--echo [on primary]
CREATE TABLE t1 (a INT);

--echo [on replica]
--source include/sync_replica_sql_with_primary.inc
DROP TABLE t1;

--echo ==== Modify table on primary ====
--echo [on primary]
connection primary;
INSERT INTO t1 VALUES (1);

--echo ==== Verify error on replica ====
--echo [on replica]
connection replica;
# replica should have stopped because can't find table t1
# 1146 = ER_NO_SUCH_TABLE
call mtr.add_suppression("Replica SQL.*Error executing row event: .Table .test.t1. doesn.t exist., Error_code: 1146");
call mtr.add_suppression("The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state");

--let $replica_sql_errno= 1146
--source include/wait_for_replica_sql_error.inc

--echo ==== Clean up ====
source include/stop_replica_io.inc;
RESET REPLICA;

--echo [on primary]
connection primary;
DROP TABLE t1;
--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
