###############################################################################
# Bug#17453826:ASSERSION ERROR WHEN SETTING FUTURE BINLOG FILE/POS WITH
# SEMISYNC
#
# Problem:
# ========
# When DMLs are in progress on the primary, stopping a replica and setting ahead
# binlog name/pos will cause an asssert on the primary.
#
# Test:
# =====
# Do DMLs on the primary and on the replica do a stop replica. Execute change primary
# to a future binlog file name and position which doesn't exist. Primary should
# not assert.
###############################################################################
--source include/have_semisync_plugin.inc
--source include/primary-replica.inc
--source include/install_semisync.inc

call mtr.add_suppression("Timeout waiting for reply of binlog*");
call mtr.add_suppression("Read semi-sync reply network error");

--source include/rpl_connection_primary.inc
CREATE TABLE t1 (a INT);
--let $binlog_pos= query_get_value("SHOW PRIMARY STATUS", Position, 1)
--let $primary_binlog= query_get_value(SHOW PRIMARY STATUS, File, 1)
--source include/sync_replica_sql_with_primary.inc
--source include/stop_replica.inc

--source include/rpl_connection_primary.inc
--send INSERT INTO t1 VALUES(0)

--source include/rpl_connection_primary1.inc
--let $status_var= rpl_semi_sync_primary_wait_sessions
--let $status_var_value= 1
--source include/wait_for_status_var.inc

--source include/rpl_connection_replica.inc
CHANGE PRIMARY TO PRIMARY_LOG_FILE='primary-bin.000002', PRIMARY_LOG_POS=4, PRIMARY_AUTO_POSITION=0;
START REPLICA;
--let $replica_io_errno=1236
--source include/wait_for_replica_io_error.inc

--source include/rpl_connection_primary.inc
--reap
INSERT INTO t1 VALUES (20);

# Since dump thread has exited and no replicas are connected, primary_clients
# must be zero.
--source include/rpl_connection_primary.inc
--let $primary_clients=[show status like "Rpl_semi_sync_primary_clients", Value, 1]
--let assert_cond= $primary_clients = 0
--let assert_text= semi sync primary clients should be 0.
--source include/assert.inc

--source include/rpl_connection_replica.inc
--source include/stop_replica.inc
--replace_regex /PRIMARY_LOG_FILE=[^,]+/PRIMARY_LOG_FILE=FILE/ /PRIMARY_LOG_POS=[0-9]+/ PRIMARY_LOG_POS= POS/
eval CHANGE PRIMARY TO PRIMARY_LOG_FILE='$primary_binlog', PRIMARY_LOG_POS=$binlog_pos, PRIMARY_AUTO_POSITION=0;
--source include/start_replica.inc

--source include/rpl_connection_primary.inc
DROP TABLE t1;
--source include/sync_replica_sql_with_primary.inc
--source include/uninstall_semisync.inc
--source include/rpl_end.inc
