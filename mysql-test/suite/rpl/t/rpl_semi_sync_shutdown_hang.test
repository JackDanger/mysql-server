###############################################################################
# Bug#17879675:SHUTDOWN HANG IF SEMISYNC IS ENABLED AND REPLICA ABORT
#
# Problem:
# ========
# Step 1. enable semisync and set a big value for
# rpl_semi_sync_primary_timeout.
#
# Step 2. kill io thread of replica, so the threads on primary will keep on
# WAITING ACK FROM REPLICA.
#
# Step 3.shutdown the primary ---hang
#
# Test:
# =====
# Stop IO thread and execute a transaction on primary. The transaction thread
# will wait for an ack as IO thread is stopped.  Now shutdown the primary the
# shutdown should not hang.  Shutdown should stop the dump thread and the
# dump thread should wakeup the waiting transaction thread and switch off
# semisync as there are no active replicas connected to the server.
###############################################################################
--source include/have_semisync_plugin.inc
--source include/not_group_replication_plugin.inc
# Test script is independent of binlog format.
--source include/have_binlog_format_mixed.inc
--source include/primary-replica.inc
--source include/install_semisync.inc

call mtr.add_suppression("Read semi-sync reply network error");
call mtr.add_suppression("SEMISYNC: Forced shutdown. Some updates might not be replicated.");

--source include/rpl_connection_primary.inc
SET GLOBAL rpl_semi_sync_primary_timeout = 10000000;

--source include/rpl_connection_replica.inc
--source include/stop_replica_io.inc

--source include/rpl_connection_primary.inc
--send CREATE TABLE t(f INT) ENGINE=INNODB;

--source include/rpl_connection_primary1.inc
--let $status_var= rpl_semi_sync_primary_wait_sessions
--let $status_var_value= 1
--source include/wait_for_status_var.inc

--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--disable_result_log
--replace_regex /.*mysqladmin.*: /mysqladmin: /
--exec $MYSQLADMIN -uroot -S $PRIMARY_MYSOCK -P $PRIMARY_MYPORT shutdown 2>&1
--enable_result_log

--source include/rpl_connection_primary.inc
--error 0,2013
--reap
--let $rpl_server_number=1
--source include/rpl_start_server.inc

--source include/rpl_connection_replica.inc
--source include/start_replica_io.inc

--source include/rpl_connection_primary.inc
DROP TABLE t;
--source include/sync_replica_sql_with_primary.inc

--source include/uninstall_semisync.inc
--source include/rpl_end.inc
