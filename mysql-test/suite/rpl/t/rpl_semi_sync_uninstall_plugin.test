###############################################################################
# Bug#17638477 UNINSTALL AND INSTALL SEMI-SYNC PLUGIN CAUSES REPLICAS TO BREAK
#  Problem: Uninstallation of Semi sync plugin should be blocked when it is
#  in use.
#  Test case: Uninstallation of semi sync should be allowed
#   On Primary:
#     1) When there is no dump thread
#     2) When there are no semi sync replicas (i.e., async replication).
#   On Replica:
#     1) When there is no I/O thread
#     2) When there are no semi sync enabled I/O thread (i.e.,async replication).
###############################################################################

--source include/have_semisync_plugin.inc
--source include/not_embedded.inc
--source include/have_binlog_format_statement.inc
--source include/primary-replica.inc

###############################################################################
# Case 1: Uninstallation of semi sync plugins should be allowed when it is
#  not in use i.e., when asynchronous replication is active.
###############################################################################
# Step 1.1: Install semi sync primary plugin on primary
--replace_result $SEMISYNC_PRIMARY_PLUGIN SEMISYNC_PRIMARY_PLUGIN
eval INSTALL PLUGIN rpl_semi_sync_primary SONAME '$SEMISYNC_PRIMARY_PLUGIN';

# Step 1.2: Install semi sync replica plugin on replica
--connection replica
--replace_result $SEMISYNC_REPLICA_PLUGIN SEMISYNC_REPLICA_PLUGIN
eval INSTALL PLUGIN rpl_semi_sync_replica SONAME '$SEMISYNC_REPLICA_PLUGIN';

# Step 1.3: Uninstallation of semisync plugin on primary and replica should be
#  allowed at this state as there is no semi sync replication enabled between
#  primary and replica.
UNINSTALL PLUGIN rpl_semi_sync_replica;
--connection primary
UNINSTALL PLUGIN rpl_semi_sync_primary;

# Step 1.4: Check that replication is working fine at the end of the test case.
CREATE TABLE t1(i int);
INSERT INTO t1 values (1);
DROP TABLE t1;
--sync_replica_with_primary

###############################################################################
# Case 2: Uninstallation of semi sync plugins should be disallowed
#  when it is in use i.e., when semi sync replication is active
###############################################################################
# Step 2.1: Install and enable semi sync replication between primary and replica
--source include/install_semisync.inc

# Step 2.2: Check that rpl_semi_sync_replica uninstallation on Replica is not
#  possible at this state
--connection replica
call mtr.add_suppression("Plugin 'rpl_semi_sync_replica' cannot be uninstalled now");
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
UNINSTALL PLUGIN rpl_semi_sync_replica;

# Step 2.3: Check that rpl_semi_sync_primary uninstallation on Primary is not
#  possible at this state
--connection primary
call mtr.add_suppression("Plugin 'rpl_semi_sync_primary' cannot be uninstalled now");
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
UNINSTALL PLUGIN rpl_semi_sync_primary;

# Step 2.4: Check that replication is working fine at the end of the test case.
CREATE TABLE t1(i int);
INSERT INTO t1 values (2);
DROP TABLE t1;
--sync_replica_with_primary

# Step 2.5: Make sure rpl_semi_sync_primary_status on Primary and
# rpl_semi_sync_replica_staus on Replica are ON
--let $replica_status=[show status like "Rpl_semi_sync_replica_status", Value, 1]
--let assert_cond= "$replica_status" = "ON"
--let assert_text= semi sync replica status should be ON.
--source include/assert.inc

--connection primary
--let $primary_status=[show status like "Rpl_semi_sync_primary_status", Value, 1]
--let assert_cond= "$primary_status" = "ON"
--let assert_text= semi sync primary status should be ON.
--source include/assert.inc

--let $primary_clients=[show status like "Rpl_semi_sync_primary_clients", Value, 1]
--let assert_cond= $primary_clients = 1
--let assert_text= semi sync primary clients should be 1.
--source include/assert.inc

###############################################################################
# Case 3: Uninstallation of semi sync plugin should be disallowed when there
#  are semi sync replicas even though rpl_semi_sync_primary_enabled= OFF;.
###############################################################################
# Step 3.1: Disable semi sync on primary
--connection primary
SET GLOBAL rpl_semi_sync_primary_enabled = OFF;

# Step 3.2: Check that still Rpl_semi_sync_primary_clients is 1
--let $primary_clients=[show status like "Rpl_semi_sync_primary_clients", Value, 1]
--let assert_cond= $primary_clients = 1
--let assert_text= semi sync primary clients should be 1.
--source include/assert.inc

# Step 3.3: Since Rpl_semi_sync_primary_clients is 1, uninstallation of
#  rpl_semi_sync_primary should be disallowed.
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
UNINSTALL PLUGIN rpl_semi_sync_primary;

###############################################################################
# Case 4: Uninstallation of semi sync plugin should be allowed when it is not
#  in use. Same as Case 1 but this case is to check the case after enabling and
#  disabling semi sync replication.
###############################################################################

# Step 4.1: Stop IO thread on replica.
--connection replica
--source include/stop_replica.inc

# Step 4.2: Disable semi sync on replica.
SET GLOBAL rpl_semi_sync_replica_enabled = OFF;

# Step 4.3: Start IO thread on replica.
--source include/start_replica.inc

# Step 4.4: Uninstall semi sync plugin, it should be successful now.
UNINSTALL PLUGIN rpl_semi_sync_replica;

# Step 4.5: On Primary, check that semi sync replicas are now '0'.
--connection primary
--let $primary_clients=[show status like "Rpl_semi_sync_primary_clients", Value, 1]
--let assert_cond= $primary_clients = 0
--let assert_text= semi sync primary clients should be 0.
--source include/assert.inc

# Step 4.6: So uninstalling semi sync plugin should be allowed
UNINSTALL PLUGIN rpl_semi_sync_primary;

# Step 4.7: Check that replication is working fine at the end of the test case
CREATE TABLE t1(i int);
INSERT INTO t1 values (3);
DROP TABLE t1;
--sync_replica_with_primary

# Cleanup
source include/rpl_end.inc;
