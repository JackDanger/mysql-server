###############################################################################
# Bug#19843808: DEADLOCK ON FLUSH TABLES WITH READ LOCK + SHOW
# REPLICA STATUS
#
# Problem:
# ========
# If a client thread on an replica does FLUSH TABLES WITH READ
# LOCK; then primary does some updates, SHOW REPLICA STATUS in
# the same client will be blocked.
#
# Test:
# =====
# Execute a DML on primary and make it blocked on replica after entering commit.
# Execute FLUSH TABLES WITH READ LOCK on replica. Allow the blocked DML to
# continue. The sql thread will be blocked in a state where it has acquired
# rli->data_lock and it is waiting for MDL COMMIT lock. Now execute show replica
# status command from the same client where FLUSH TABLES WITH READ LOCK was
# issued. The show replica status command should not be blocked.
###############################################################################
--source include/have_binlog_format_mixed.inc
--source include/primary-replica.inc
--source include/have_debug.inc
--source include/have_innodb.inc
--source include/have_debug_sync.inc

--echo # Let primary and replica synced with t1 table created
CREATE TABLE t1 (f INT) ENGINE= INNODB;
--source include/sync_replica_sql_with_primary.inc

--echo # Setup GLOBAL.DEBUG at replica to reach commit
--source include/rpl_connection_replica.inc
--let $debug_saved= `SELECT @@GLOBAL.DEBUG`
SET @@GLOBAL.DEBUG= '+d,dbug.reached_commit';

--echo # Do some DML operation on primary so that it will be blocked on
--echo # replica as global read lock is in place.
--source include/rpl_connection_primary.inc
INSERT INTO t1 VALUES (10);

--echo # Issue FLUSH TABLES WITH READ LOCK after Reached is signaled
--source include/rpl_connection_replica.inc
SET DEBUG_SYNC='now WAIT_FOR Reached';
FLUSH TABLES WITH READ LOCK;
--echo # Let sql thread continue to try to obtain commit lock
SET DEBUG_SYNC= 'now SIGNAL signal.commit_continue';

--echo # Wait until sql thread enters "Waiting for commit lock" state
let $wait_condition= SELECT COUNT(*) = 1 FROM information_schema.processlist
                     WHERE state = "Waiting for commit lock";
--source include/wait_condition.inc

--source include/rpl_connection_replica.inc
--disable_result_log
query_vertical SHOW REPLICA STATUS;
--enable_result_log
UNLOCK TABLES;
SET @@GLOBAL.DEBUG= '$debug_saved';

--source include/rpl_connection_primary.inc
--source include/sync_replica_sql_with_primary.inc

let $diff_tables= primary:t1, replica:t1;
source include/diff_tables.inc;

--source include/rpl_connection_primary.inc
DROP TABLE t1;
--source include/sync_replica_sql_with_primary.inc

--source include/rpl_end.inc
