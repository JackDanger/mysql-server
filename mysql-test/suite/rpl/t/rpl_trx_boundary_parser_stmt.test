# ==== Purpose ====
#
# Test the behavior of mysql server replication with the transaction boundary
# parser.
#
# This test will insert data in the primary while the replica will have some debug
# sync points activated to stop the IO thread in the middle of the transaction
# what will cause the transactions to be spanned along distinct relay log files.
#
# As the GTID auto positioning protocol will retrieved the partial transactions
# from the beginning, we repeat the test again disabling GTID auto positioning.
#
# ==== Related Bugs and Worklogs ====
#
# BUG#17943188: SHOW REPLICA STATUS/RETRIEVED_GTID_SET MAY HAVE PARTIAL TRX OR
#               MISS COMPLETE TRX
#

# This test should run only on debug build
--source include/have_debug.inc
# This test uses debug sync to stop the IO thread in the middle of a transaction
--source include/have_debug_sync.inc

--source include/have_innodb.inc
--source include/have_myisam.inc

--let $rpl_gtid_utils= 1
--source include/have_gtid.inc
--source include/have_binlog_format_statement.inc
--source include/primary-replica.inc

--echo # Using MyISAM storage engine
--let $storage_engine= MyISAM
--source extra/rpl_tests/rpl_trx_boundary_parser.inc

--echo # Using InnoDB storage engine
--let $storage_engine= InnoDB
--source extra/rpl_tests/rpl_trx_boundary_parser.inc

#
# As we are going to use GTID related checks for the IO thread after
# a CHANGE PRIMARY, we will first reset both replica and primary to avoid
# problems with the gtid related mtr includes.
#
--source include/rpl_connection_replica.inc
--source include/stop_replica.inc
RESET PRIMARY;
RESET REPLICA;
--source include/rpl_connection_primary.inc
RESET PRIMARY;

#
# Disabling replica's auto positioning
#
--source include/rpl_connection_replica.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 0;
--source include/start_replica.inc

--echo # Using MyISAM storage engine without auto positioning
--let $storage_engine= MyISAM
--source extra/rpl_tests/rpl_trx_boundary_parser.inc

--echo # Using InnoDB storage engine without auto positioning
--let $storage_engine= InnoDB
--source extra/rpl_tests/rpl_trx_boundary_parser.inc

#
# Enabling replica's auto positioning again
#
--source include/rpl_connection_replica.inc
--source include/stop_replica.inc
CHANGE PRIMARY TO PRIMARY_AUTO_POSITION= 1;
--source include/start_replica.inc

--source include/rpl_end.inc
