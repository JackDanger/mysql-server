# Created: 2015-07-01  Lalit Choudhary
# WL#8540
# Testing IF [NOT] EXISTS clause in CREATE/DROP/ALTER USER with Replication.
--source include/primary-replica.inc
--connection primary
--echo [On Primary]
--echo #
--echo #
--connection primary
--echo [On Primary]
--echo # No users exist:

DROP USER IF EXISTS wl8540@nohost1, wl8540@nohost2;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';
ALTER USER IF EXISTS wl8540@nohost1, wl8540@nohost2 ACCOUNT LOCK;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';
CREATE USER IF NOT EXISTS wl8540@nohost1, wl8540@nohost2;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';

--source include/sync_replica_sql_with_primary.inc
--echo [On Replica]
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';

--connection primary
--echo [On Primary]
--echo # All users exist:

ALTER USER IF EXISTS wl8540@nohost1, wl8540@nohost2 ACCOUNT LOCK;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';
CREATE USER IF NOT EXISTS wl8540@nohost1, wl8540@nohost2;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';
DROP USER IF EXISTS wl8540@nohost1, wl8540@nohost2;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';

--source include/sync_replica_sql_with_primary.inc
--echo [On Replica]
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';

--connection primary
--echo [On Primary]
CREATE USER wl8540@nohost1;

# One of two users exist:

DROP USER IF EXISTS wl8540@nohost1, wl8540@nohost2;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';
ALTER USER IF EXISTS wl8540@nohost1, wl8540@nohost2 ACCOUNT LOCK;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';
CREATE USER IF NOT EXISTS wl8540@nohost1, wl8540@nohost2;
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';

--source include/sync_replica_sql_with_primary.inc
--echo [On Replica]
SELECT COUNT(*) FROM mysql.user WHERE user = 'wl8540';

# Creating users on REPLICA
CREATE USER IF NOT EXISTS replica_user1@localhost
IDENTIFIED WITH 'mysql_native_password' BY 'auth_string#%y';

CREATE USER IF NOT EXISTS replica_user2@localhost;

--connection primary
--echo [On PRIMARY]

# Creating replica_user1 not exists on PRIMARY and exist on REPLICA.
CREATE USER IF NOT EXISTS replica_user1@localhost
IDENTIFIED WITH 'mysql_native_password' BY 'auth_string#%y';

# ALTER replica_user2 not exists on PRIMARY and exist on REPLICA.
ALTER USER IF EXISTS replica_user2@localhost
IDENTIFIED WITH 'sha256_password' WITH MAX_CONNECTIONS_PER_HOUR 2;

# Dropping replica_user2 not exists on PRIMARY and exist on REPLICA.
DROP USER IF EXISTS replica_user2@localhost;

# Cleanup
DROP USER IF EXISTS wl8540@nohost1, wl8540@nohost2,
                    replica_user1@localhost,replica_user2@localhost;
FLUSH PRIVILEGES;

--source include/sync_replica_sql_with_primary.inc

--source include/rpl_end.inc
# End:
