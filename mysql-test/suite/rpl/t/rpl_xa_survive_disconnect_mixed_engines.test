# BUG#12161 Xa recovery and client disconnection
#
# The test verifies correct XA transaction two phase logging and its applying
# in a case the transaction updates transactional and non-transactional tables.
# Transactions are terminated according to specfied parameters to
# a sourced inc-file.

--source include/not_gtid_enabled.inc
--source include/primary-replica.inc

--source include/rpl_connection_replica.inc
#Bug #21273010 	REPLICA GROUP EVENT PARSER DOES NOT RECOGNIZE XA ROLLBACK AS A BOUNDARY
CALL mtr.add_suppression("An unexpected event sequence was detected by the IO thread while queuing the event");
CALL mtr.add_suppression("GTID_LOG_EVENT or ANONYMOUS_GTID_LOG_EVENT is not expected in an event stream in the middle of a DML");

--source include/rpl_connection_primary.inc
CALL mtr.add_suppression("Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT");

--let $command=setup
--source extra/rpl_tests/rpl_xa_mixed_engines.inc

--echo === COMMIT ===
--let $command=run
--let $xa_terminate=XA COMMIT
--let $xa_prepare_opt=1
--source extra/rpl_tests/rpl_xa_mixed_engines.inc

--source include/sync_replica_sql_with_primary.inc
--source include/rpl_connection_primary.inc

--echo === COMMIT ONE PHASE ===

--let $command=run
--let $xa_terminate=XA COMMIT
--let $one_phase=ONE PHASE
--let $xa_prepare_opt=
--source extra/rpl_tests/rpl_xa_mixed_engines.inc
--let $one_phase=
--source include/sync_replica_sql_with_primary.inc
--source include/rpl_connection_primary.inc

--echo === ROLLBACK with PREPARE ===

--let $command=run
--let $xa_terminate=xa rollback
--let $xa_prepare_opt=1
--source extra/rpl_tests/rpl_xa_mixed_engines.inc

--source include/sync_replica_sql_with_primary.inc
--source include/rpl_connection_primary.inc

--echo === ROLLBACK with no PREPARE ===

--let $command=run
--let $xa_terminate=xa rollback
--let $xa_prepare_opt=
--source extra/rpl_tests/rpl_xa_mixed_engines.inc
--let $xa_rollback_only=

--source include/sync_replica_sql_with_primary.inc

--let $diff_tables= primary:tm, replica:tm
--source include/diff_tables.inc

# Cleanup

--source include/rpl_connection_primary.inc
--let $command=cleanup
--source extra/rpl_tests/rpl_xa_mixed_engines.inc

--source include/sync_replica_sql_with_primary.inc

--source include/rpl_end.inc
