# The include statement below is a temp one for tests that are yet to
#be ported to run with InnoDB,
#but needs to be kept for tests that would need MyISAM in future.
--source include/force_myisam_default.inc

--source include/have_ndb.inc
--source include/have_binlog_format_row.inc
--source include/primary-replica.inc
let $engine_type=NDBCLUSTER;

connection replica;
set @saved_replica_type_conversions = @@global.replica_type_conversions;
CREATE TABLE type_conversions (
       TestNo INT AUTO_INCREMENT PRIMARY KEY,
       Source TEXT,
       Target TEXT,
       Flags TEXT,
       On_Primary TEXT,
       On_Replica TEXT,
       Expected TEXT,
       Compare INT,
       Error TEXT);

SELECT @@global.replica_type_conversions;
SET GLOBAL REPLICA_TYPE_CONVERSIONS='';
SELECT @@global.replica_type_conversions;
SET GLOBAL REPLICA_TYPE_CONVERSIONS='ALL_NON_LOSSY';
SELECT @@global.replica_type_conversions;
SET GLOBAL REPLICA_TYPE_CONVERSIONS='ALL_LOSSY';
SELECT @@global.replica_type_conversions;
SET GLOBAL REPLICA_TYPE_CONVERSIONS='ALL_LOSSY,ALL_NON_LOSSY';
SELECT @@global.replica_type_conversions;
--error ER_WRONG_VALUE_FOR_VAR
SET GLOBAL REPLICA_TYPE_CONVERSIONS='ALL_LOSSY,ALL_NON_LOSSY,NONEXISTING_BIT';
SELECT @@global.replica_type_conversions;

# Checking lossy integer type conversions
connection replica;
SET GLOBAL REPLICA_TYPE_CONVERSIONS='ALL_LOSSY';
source extra/rpl_tests/type_conversions.test;

connection replica;
--source suite/rpl_ndb/t/check_conversions.inc

DROP TABLE type_conversions;

--disable_query_log
call mtr.add_suppression("Replica SQL.*Column 1 of table .test.t1. cannot be converted from type.* Error_code: 1677");
--enable_query_log

connection primary;
DROP TABLE t1;
sync_replica_with_primary;

set global replica_type_conversions = @saved_replica_type_conversions;

--source include/rpl_end.inc
